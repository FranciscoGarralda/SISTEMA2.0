<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>Sistema Financiero - Gesti√≥n Profesional</title>
    <style>
        :root {
            /* Tema OSCURO por defecto (seg√∫n memoria del usuario) */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --button-bg: #77abff;
            --button-text: #f1f5f9;
            --active-bg: #4c85ff;
            --active-text: #ffffff;
            --error-color: #ff453a;
            --success-color: #30d158;
        }
        .light-theme {
            /* Tema CLARO */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e5e5e5;
            --button-bg: #9dc2fe;
            --button-text: #1a1a1a;
            --active-bg: #4c85ff;
            --active-text: #ffffff;
            --error-color: #ff3b30;
            --success-color: #34c759;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-top: 60px;
            padding-bottom: 50px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .menu-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }
        .menu-btn:hover {
            color: var(--button-bg);
        }
        .date-display {
            font-size: 14px;
            font-weight: 500;
        }
        @media (max-width: 480px) {
            .date-display {
                font-size: 12px;
            }
        }
        .user-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        @media (max-width: 480px) {
            .user-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        .user-btn:hover {
            border-color: var(--button-bg);
            color: var(--button-bg);
        }
        /* Footer */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 6px 20px;
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .cotizaciones {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: wrap;
        }
        @media (max-width: 480px) {
            .cotizaciones {
                gap: 8px;
            }
        }
        .cotizacion-item {
            text-align: center;
        }
        .cotizacion-label {
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        @media (max-width: 480px) {
            .cotizacion-label {
                font-size: 8px;
            }
        }
        .cotizacion-valores {
            display: flex;
            gap: 8px;
            font-size: 11px;
        }
        @media (max-width: 480px) {
            .cotizacion-valores {
                gap: 5px;
                font-size: 10px;
            }
        }
        .compra, .venta {
            display: flex;
            flex-direction: column;
        }
        .compra span:first-child, .venta span:first-child {
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        .compra span:last-child {
            color: var(--success-color);
        }
        .venta span:last-child {
            color: var(--error-color);
        }
        /* Content */
        main {
            padding: 20px;
            min-height: calc(100vh - 120px);
            overflow-x: hidden;
        }
        @media (max-width: 600px) {
            main {
                padding: 15px;
            }
        }
        @media (max-width: 400px) {
            main {
                padding: 10px;
            }
        }
        /* Sidebar Menu */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background-color: var(--bg-secondary);
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
            transition: left 0.3s ease, background-color 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }
        .dark-theme .sidebar {
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.3);
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s ease;
        }
        .close-btn:hover {
            color: var(--button-bg);
        }
        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .menu-item {
            border-bottom: 1px solid var(--border-color);
        }
        .menu-link {
            display: block;
            padding: 16px 20px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        .menu-link:hover {
            background-color: var(--bg-primary);
            color: var(--button-bg);
            padding-left: 28px;
        }
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1500;
        }
        .overlay.active {
            display: block;
        }
        /* Operations Form */
        .operations-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 15px;
            width: 100%;
        }
        @media (max-width: 750px) {
            .operations-container {
                max-width: 100%;
                padding: 0 10px;
            }
        }
        @media (max-width: 500px) {
            .operations-container {
                padding: 0 8px;
            }
        }
        .form-card {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        .dark-theme .form-card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 600px) {
            .form-card {
                padding: 16px;
                margin-bottom: 16px;
            }
        }
        @media (max-width: 400px) {
            .form-card {
                padding: 12px;
                margin-bottom: 12px;
            }
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .form-title {
            font-size: 20px;
            font-weight: 600;
        }
        @media (max-width: 480px) {
            .form-title {
                font-size: 18px;
            }
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .form-grid > * {
            min-width: 0;
        }
        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        @media (max-width: 500px) {
            .form-grid {
                gap: 12px;
            }
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dynamic-fields-container > .form-group {
            margin-bottom: 20px;
        }
        .dynamic-fields-container > .form-group:last-child {
            margin-bottom: 0;
        }
        .dynamic-fields-container > div[style*="display: grid"] {
            margin-bottom: 20px;
        }
        .dynamic-fields-container > div[style*="display: grid"]:last-child {
            margin-bottom: 0;
        }
        .form-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-input, .form-select, .form-textarea {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 12px;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
        }
        @media (max-width: 480px) {
            .form-input, .form-select, .form-textarea {
                padding: 8px 10px;
                font-size: 16px;
            }
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--button-bg);
            background-color: var(--bg-secondary);
        }
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-input:read-only {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }
        /* Button Grid for Operations */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            max-width: 100%;
            gap: 10px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .button-grid > * {
            min-width: 0;
        }
        @media (max-width: 600px) {
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }
        @media (max-width: 400px) {
            .button-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }
        .btn-option {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-option:hover {
            transform: scale(1.02);
        }
        @media (max-width: 600px) {
            .btn-option {
                padding: 4px 8px;
                font-size: 11px;
                min-height: 28px;
            }
        }
        @media (max-width: 400px) {
            .btn-option {
                padding: 3px 6px;
                font-size: 10px;
                min-height: 26px;
            }
        }
        .btn-option.btn-moneda {
            padding: 6px 10px;
            font-size: 12px;
        }
        .btn-option:hover:not(.active) {
            border-color: var(--button-bg);
            background-color: var(--bg-secondary);
            transform: scale(1.02);
        }
        .btn-option.active {
            background-color: var(--active-bg);
            border-color: var(--active-bg);
            color: var(--active-text);
            font-weight: 600;
        }
        /* Theme Switch */
        .theme-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .theme-switch-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
        }
        .theme-switch-label span {
            font-size: 20px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: var(--bg-primary);
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        input:checked + .slider {
            background-color: var(--button-bg);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider:hover {
            opacity: 0.9;
        }
        .btn-submit {
            background-color: var(--button-bg);
            color: var(--text-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        @media (max-width: 480px) {
            .btn-submit {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        .btn-submit:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .btn-submit:disabled {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-cancel {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        @media (max-width: 480px) {
            .btn-cancel {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        .btn-cancel:hover {
            border-color: var(--error-color);
            color: var(--error-color);
            transform: scale(1.02);
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        @media (max-width: 480px) {
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            .form-actions button {
                width: 100%;
            }
        }
        /* Section Title */
        .section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        /* Hidden class */
        .hidden {
            display: none !important;
        }
        /* Input with button */
        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        .input-with-button .form-input {
            flex: 1;
        }
        .btn-add {
            background-color: var(--button-bg);
            color: var(--text-primary);
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
        }
        @media (max-width: 480px) {
            .btn-add {
                min-width: 40px;
                padding: 8px 12px;
                font-size: 16px;
            }
        }
        .btn-add:hover {
            opacity: 0.9;
        }
        /* Read-only inputs */
        .form-input-readonly {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        /* Wallet buttons container */
        .wallet-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
            max-width: 100%;
            overflow: hidden;
        }
        @media (max-width: 600px) {
            .wallet-buttons-container {
                gap: 6px;
            }
        }
        .moneda-buttons-container {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 4px;
            max-width: 100%;
            overflow: hidden;
        }
        @media (max-width: 500px) {
            .moneda-buttons-container {
                gap: 4px;
            }
        }
        .wallet-step {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            overflow: hidden;
        }
        .wallet-step-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .btn-wallet {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex: 1;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 600px) {
            .btn-wallet {
                padding: 4px 8px;
                font-size: 11px;
                min-height: 28px;
            }
        }
        @media (max-width: 400px) {
            .btn-wallet {
                padding: 3px 6px;
                font-size: 10px;
                min-height: 26px;
            }
        }
        .btn-wallet:hover:not(:disabled) {
            border-color: var(--button-bg);
            background-color: var(--bg-primary);
        }
        .btn-wallet.active {
            background-color: var(--active-bg) !important;
            border-color: var(--active-bg) !important;
            color: var(--active-text) !important;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(76, 133, 255, 0.4);
            opacity: 1 !important;
        }
        .btn-wallet:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .btn-wallet.active:disabled {
            opacity: 0.85 !important;
            background-color: var(--active-bg) !important;
            border-color: var(--active-bg) !important;
            color: var(--active-text) !important;
            box-shadow: 0 2px 6px rgba(76, 133, 255, 0.4);
        }
        /* Mixed payments section */
        .mixed-payments-section {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            overflow: hidden;
        }
        @media (max-width: 600px) {
            .mixed-payments-section {
                padding: 16px;
            }
        }
        @media (max-width: 400px) {
            .mixed-payments-section {
                padding: 12px;
            }
        }
        .mixed-payment-item {
            display: grid;
            grid-template-columns: 1fr 1fr minmax(42px, auto);
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        .mixed-payment-item > * {
            min-width: 0;
        }
        .mixed-payment-item:last-child {
            margin-bottom: 0;
        }
        .mixed-payment-item .btn-remove {
            align-self: end;
            flex-shrink: 0;
            min-width: 42px;
            width: 42px;
        }
        /* Responsive para pantallas peque√±as - X siempre visible */
        @media (max-width: 600px) {
            .mixed-payment-item {
                grid-template-columns: 1fr minmax(42px, auto);
                gap: 12px;
            }
            /* Wallet ocupa toda la primera fila */
            .mixed-payment-item .form-group:first-child {
                grid-column: 1 / -1;
            }
            /* Monto y X en la segunda fila */
            .mixed-payment-item .form-group:nth-child(2) {
                grid-column: 1;
            }
            .mixed-payment-item .btn-remove {
                grid-column: 2;
                min-width: 42px;
                width: 42px;
                height: 42px;
                align-self: end;
            }
        }
        @media (max-width: 400px) {
            .mixed-payment-item {
                gap: 10px;
            }
            .mixed-payment-item .btn-remove {
                min-width: 38px;
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
        }
        #mixedPaymentsList {
            width: 100%;
            box-sizing: border-box;
        }
        .btn-remove {
            background-color: var(--error-color);
            color: white;
            border: none;
            padding: 0;
            width: 42px;
            height: 42px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 400px) {
            .btn-remove {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
        }
        .btn-remove:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }
        .btn-add-payment {
            background-color: var(--button-bg);
            color: var(--text-primary);
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
            transition: all 0.2s;
            width: 100%;
        }
        @media (max-width: 480px) {
            .btn-add-payment {
                padding: 8px 14px;
                font-size: 13px;
            }
        }
        .btn-add-payment:hover {
            opacity: 0.8;
        }
        .mixed-payment-total {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .total-match {
            color: var(--success-color);
        }
        .total-mismatch {
            color: var(--error-color);
        }
        /* Dynamic fields container */
        .dynamic-fields-container {
            margin: 24px 0;
        }
        /* Separator */
        .field-separator {
            height: 1px;
            background-color: var(--border-color);
            margin: 24px 0;
        }
        /* Fecha y D√≠a juntos */
        .fecha-dia-group {
            display: flex;
            gap: 12px;
        }
        @media (max-width: 600px) {
            .fecha-dia-group {
                flex-direction: column;
                gap: 16px;
            }
        }
        .fecha-dia-group .form-group {
            flex: 1;
        }
        /* Movimientos en formato lista */
        .movimiento-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr 1fr auto;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .movimiento-row:hover {
            background: var(--bg-surface-hover);
        }
        @media (max-width: 600px) {
            .movimiento-row {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            .movimiento-row > div {
                padding: 4px 0;
            }
        }
        @media (max-width: 480px) {
            .movimiento-row {
                padding: 10px;
                gap: 6px;
            }
        }

        /* Pendientes en formato lista */
        .pendiente-cliente-card {
            padding: 16px;
            margin-bottom: 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
        }
        .pendiente-cliente-card > div:first-child {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }
        .pendiente-operacion-row {
            display: grid;
            grid-template-columns: auto 2fr 1fr 1fr auto;
            gap: 12px;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            align-items: center;
        }
        @media (max-width: 600px) {
            .pendiente-cliente-card > div:first-child {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            .pendiente-operacion-row {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            .pendiente-operacion-row > * {
                padding: 4px 0;
            }
        }
        @media (max-width: 480px) {
            .pendiente-cliente-card {
                padding: 12px;
            }
            .pendiente-operacion-row {
                padding: 8px;
                gap: 6px;
            }
        }

        /* Toast System */
        #toastContainer {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            max-width: 90%;
            width: 300px;
        }
        @media (max-width: 480px) {
            #toastContainer {
                width: calc(100% - 40px);
                bottom: 70px;
            }
        }
        .toast {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(20px);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        @media (max-width: 480px) {
            .toast {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            border-left: 4px solid var(--success-color);
        }
        .toast.error {
            border-left: 4px solid var(--error-color);
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Men√∫</div>
            <button class="close-btn" id="closeBtn">‚úï</button>
        </div>
        <ul class="menu-list">
            <li class="menu-item">
                <a href="#pendientes" class="menu-link">Pendientes</a>
            </li>
            <li class="menu-item">
                <a href="#operaciones" class="menu-link">Operaciones</a>
            </li>
            <li class="menu-item">
                <a href="#clientes" class="menu-link">Clientes</a>
            </li>
            <li class="menu-item">
                <a href="#movimientos" class="menu-link">Movimientos</a>
            </li>
            <li class="menu-item">
                <a href="#saldos" class="menu-link">Saldos</a>
            </li>
            <li class="menu-item">
                <a href="#comisiones" class="menu-link">Comisiones</a>
            </li>
            <li class="menu-item">
                <a href="#cuentas-corrientes" class="menu-link">Cuentas Corrientes</a>
            </li>
            <li class="menu-item">
                <a href="#configuracion" class="menu-link">Configuraci√≥n</a>
            </li>
        </ul>
    </nav>
    <header>
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <div class="date-display" id="dateDisplay"></div>
        <button class="user-btn">üë§ Usuario</button>
    </header>
    <main id="mainContent">
    </main>
    <footer>
        <div class="cotizaciones">
            <div class="cotizacion-item">
                <div class="cotizacion-label">USD</div>
                <div class="cotizacion-valores">
                    <div class="compra">
                        <span>Compra</span>
                        <span>1,050</span>
                    </div>
                    <div class="venta">
                        <span>Venta</span>
                        <span>1,080</span>
                    </div>
                </div>
            </div>
            <div class="cotizacion-item">
                <div class="cotizacion-label">USDT</div>
                <div class="cotizacion-valores">
                    <div class="compra">
                        <span>Compra</span>
                        <span>1,045</span>
                    </div>
                    <div class="venta">
                        <span>Venta</span>
                        <span>1,075</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <div id="toastContainer"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            /**
             * =================================================================
             * M√ìDULO DE CARGA Y NAVEGACI√ìN PRINCIPAL
             * =================================================================
             */
            function loadModule(module) {
                const mainContent = document.getElementById('mainContent');
                if (!mainContent) return;
                localStorage.setItem('activeModule', module);
                
                // Resetear estado de edici√≥n al cambiar de m√≥dulo
                if (module === 'operaciones') {
                    // Resetear solo si no estamos editando (para no perder datos al cambiar de pesta√±a y volver)
                    if (editingMovimientoId === null) {
                        formData = getInitialFormState();
                        clearFormState();
                    }
                } else {
                    // Si cambiamos a otro m√≥dulo, resetear todo
                    editingMovimientoId = null;
                }
                switch(module) {
                    case 'pendientes':
                        mainContent.innerHTML = renderPendientesModule();
                        initPendientesModule();
                        break;
                    case 'operaciones':
                        mainContent.innerHTML = renderOperationsModule();
                        initOperationsModule();
                        break;
                    case 'clientes':
                        mainContent.innerHTML = renderClientesModule();
                        initClientesModule();
                        break;
                    case 'movimientos':
                        mainContent.innerHTML = renderMovimientosModule();
                        initMovimientosModule();
                        break;
                    case 'configuracion':
                        mainContent.innerHTML = `
                            <div class="operations-container">
                                <div class="form-card">
                                    <h2 class="form-title" style="margin-bottom: 30px;">Configuraci√≥n</h2>
                                    <div class="theme-switch-container">
                                        <div class="theme-switch-label">
                                            <span id="themeIcon">üåô</span>
                                            <span id="themeText">Tema Oscuro</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="themeToggle">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        `;
                        initConfiguracion();
                        break;
                    default:
                        mainContent.innerHTML = '<div class="operations-container"><h2 class="form-title">Bienvenido</h2><p style="color: var(--text-secondary);">Selecciona una opci√≥n del men√∫</p></div>';
                }
            }

            /**
             * =================================================================
             * UTILIDADES Y CONFIGURACI√ìN GLOBAL
             * =================================================================
             */
            const operaciones = {
                TRANSACCIONES: { icon: 'üí±', subMenu: ['COMPRA', 'VENTA', 'ARBITRAJE'] },
                CUENTAS_CORRIENTES: { icon: 'üè¶', subMenu: ['INGRESO', 'EGRESO', 'COMPRA', 'VENTA', 'ARBITRAJE'] },
                WALLET: { icon: 'üí≥', subMenu: ['INGRESO', 'SALIDA', 'PRESTAMO', 'DEVOLUCION', 'MOV ENTRE CUENTAS', 'CREAR WALLET', 'LISTA DE WALLETS'] },
                ADMINISTRATIVAS: { icon: '‚öôÔ∏è', subMenu: ['AJUSTE', 'GASTO'] },
                PRESTAMISTAS: { icon: 'ü§ù', subMenu: ['PRESTAMO', 'RETIRO'] }
            };
            const monedas = [
                { value: 'ARS', label: 'ARS' }, { value: 'USD', label: 'USD' }, { value: 'EURO', label: 'EUR' },
                { value: 'USDT', label: 'USDT' }, { value: 'REAL', label: 'BRL' }, { value: 'LIBRA', label: 'GBP' },
                { value: 'CLP', label: 'CLP' }
            ];
            const estados = [
                { value: 'pendiente_retiro', label: 'P. Retiro' }, { value: 'pendiente_entrega', label: 'P. Entrega' },
                { value: 'realizado', label: 'Finalizado' }
            ];
            let formData = {};
            let editingMovimientoId = null; // ID del movimiento que se est√° editando
            let lastEditedField = null; // Campo editado m√°s recientemente para arbitraje bidireccional

            function getInitialFormState() {
                return {
                    fecha: new Date().toISOString().split('T')[0], nombreDia: '', cliente: '', operacion: '',
                    subOperacion: '', detalle: '', monto: '', moneda: '', tc: '', total: '', estado: 'pendiente_retiro',
                    por: '', nombreOtro: '', walletCompra: '', walletTC: '', monedaTC: '', proveedorCC: '',
                    comisionTipo: 'porcentaje', comisionValor: '', montoComision: '', monedaComision: '', cuentaComision: '',
                    montoReal: '', interes: '', lapso: '', cuentaSalida: '', cuentaIngreso: '', monedaSalida: '',
                    monedaIngreso: '', comision: '', montoBase: '', monedaBase: '', cotizacionCliente: '',
                    cotizacionReal: '', montoCobrado: '', monedaCobro: '', costoReal: '', profit: '', monedaProfit: '',
                    walletProfit: '', walletBase: '', mixedPayments: [], isMixedPaymentActive: false
                };
            }

            function saveFormState() {
                try {
                    localStorage.setItem('formState', JSON.stringify(formData));
                } catch (error) {
                    console.error('Error al guardar estado del formulario:', error);
                }
            }

            function loadFormState() {
                try {
                    const savedState = localStorage.getItem('formState');
                    if (savedState) {
                        formData = JSON.parse(savedState);
                        return true;
                    }
                    formData = getInitialFormState();
                    return false;
                } catch (error) {
                    console.error('Error al cargar estado del formulario:', error);
                    formData = getInitialFormState();
                    return false;
                }
            }

            function clearFormState() {
                localStorage.removeItem('formState');
                formData = getInitialFormState();
                editingMovimientoId = null;
            }
            
            function showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icon = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ùå' : '‚ÑπÔ∏è');
                toast.innerHTML = `<span>${icon}</span> ${message}`;
                container.appendChild(toast);
                setTimeout(() => { toast.classList.add('show'); }, 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            /**
             * =================================================================
             * GESTI√ìN DE WALLETS (LocalStorage)
             * =================================================================
             */
            function getWallets() {
                return JSON.parse(localStorage.getItem('wallets') || '[]');
            }

            function saveWallets(wallets) {
                localStorage.setItem('wallets', JSON.stringify(wallets));
            }

            function addWallet(wallet) {
                const wallets = getWallets();
                wallets.push(wallet);
                saveWallets(wallets);
            }

            function deleteWallet(walletId) {
                let wallets = getWallets();
                wallets = wallets.filter(w => w.id !== walletId);
                saveWallets(wallets);
            }

            /**
             * =================================================================
             * GESTI√ìN DE CLIENTES (LocalStorage)
             * =================================================================
             */
            function getClientes() {
                return JSON.parse(localStorage.getItem('clientes') || '[]');
            }

            function saveClientes(clientes) {
                localStorage.setItem('clientes', JSON.stringify(clientes));
            }

            function addCliente(cliente) {
                const clientes = getClientes();
                clientes.push(cliente);
                saveClientes(clientes);
            }

            function deleteCliente(clienteId) {
                let clientes = getClientes();
                clientes = clientes.filter(c => c.id !== clienteId);
                saveClientes(clientes);
            }

            function updateCliente(clienteId, datosActualizados) {
                let clientes = getClientes();
                const index = clientes.findIndex(c => c.id === clienteId);
                if (index !== -1) {
                    clientes[index] = { ...clientes[index], ...datosActualizados };
                    saveClientes(clientes);
                }
            }

            /**
             * =================================================================
             * GESTI√ìN DE MOVIMIENTOS (LocalStorage)
             * =================================================================
             */
            function getMovimientos() {
                return JSON.parse(localStorage.getItem('movimientos') || '[]');
            }

            function saveMovimientos(movimientos) {
                localStorage.setItem('movimientos', JSON.stringify(movimientos));
            }

            function addMovimiento(movimiento) {
                const movimientos = getMovimientos();
                // Generar ID √∫nico para el movimiento
                const id = 'MOV_' + crypto.randomUUID();
                movimientos.unshift({ ...movimiento, id, fechaCreacion: new Date().toISOString(), anulado: false });
                saveMovimientos(movimientos);
                return id;
            }

            function updateMovimiento(movimientoId, datosActualizados) {
                let movimientos = getMovimientos();
                const index = movimientos.findIndex(m => m.id === movimientoId);
                if (index !== -1) {
                    movimientos[index] = { ...movimientos[index], ...datosActualizados, fechaModificacion: new Date().toISOString() };
                    saveMovimientos(movimientos);
                }
            }

            function anularMovimiento(movimientoId) {
                let movimientos = getMovimientos();
                const index = movimientos.findIndex(m => m.id === movimientoId);
                if (index !== -1) {
                    movimientos[index].anulado = true;
                    movimientos[index].fechaAnulacion = new Date().toISOString();
                    saveMovimientos(movimientos);
                }
            }

            function getClienteNombre(clienteId) {
                if (!clienteId) return 'Sin cliente';
                const clientes = getClientes();
                const cliente = clientes.find(c => c.id === clienteId);
                return cliente ? cliente.nombre : 'Cliente no encontrado';
            }

            function getClienteCompleto(clienteId) {
                if (!clienteId) return null;
                const clientes = getClientes();
                return clientes.find(c => c.id === clienteId) || null;
            }

            function getWalletNombre(walletId) {
                if (!walletId || walletId === 'pago_mixto') return null;
                const wallets = getWallets();
                const wallet = wallets.find(w => w.id === walletId.split('_')[0]);
                return wallet ? wallet.nombre : null;
            }

            function actualizarUltimaOperacionCliente(clienteId) {
                if (!clienteId) return;
                const fechaActual = new Date().toISOString();
                updateCliente(clienteId, { ultimaOperacion: fechaActual });
            }

            function calcularDiasDesdeUltimaOperacion(fechaUltimaOperacion) {
                if (!fechaUltimaOperacion) return null;
                const fechaUltima = new Date(fechaUltimaOperacion);
                const fechaActual = new Date();
                const diferencia = fechaActual - fechaUltima;
                const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
                return dias;
            }

            function formatearFechaUltimaOperacion(fechaUltimaOperacion) {
                if (!fechaUltimaOperacion) return 'Nunca';
                const fecha = new Date(fechaUltimaOperacion);
                const hoy = new Date();
                const ayer = new Date(hoy);
                ayer.setDate(ayer.getDate() - 1);
                
                // Comparar solo fecha (sin hora)
                const fechaSinHora = new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());
                const hoySinHora = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                const ayerSinHora = new Date(ayer.getFullYear(), ayer.getMonth(), ayer.getDate());
                
                if (fechaSinHora.getTime() === hoySinHora.getTime()) {
                    return 'Hoy';
                } else if (fechaSinHora.getTime() === ayerSinHora.getTime()) {
                    return 'Ayer';
                } else {
                    return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
            }

            /**
             * =================================================================
             * L√ìGICA DE C√ÅLCULOS (PRESERVADA COMPLETA DEL ORIGINAL)
             * =================================================================
             */
            function safeParseFloat(value, defaultValue = 0) {
                if (!value && value !== 0) return defaultValue;
                // Convertir a string y eliminar espacios
                let str = String(value).trim();
                // Eliminar s√≠mbolos de moneda y caracteres no num√©ricos (excepto punto, coma y guion)
                str = str.replace(/[^\d.,-]/g, '');
                // Eliminar separadores de miles (puntos que no son decimales)
                // Si hay coma, los puntos son miles. Si hay punto y no coma, el punto es decimal
                const hasComa = str.includes(',');
                const hasPunto = str.includes('.');
                if (hasComa) {
                    // Formato con coma decimal: eliminar todos los puntos (son miles)
                    str = str.replace(/\./g, '');
                    // Reemplazar coma decimal por punto
                    str = str.replace(',', '.');
                } else if (hasPunto) {
                    // Formato con punto: verificar si es decimal o miles
                    // Si hay m√°s de un punto, los primeros son miles
                    const puntos = str.split('.');
                    if (puntos.length > 2) {
                        // M√∫ltiples puntos = separadores de miles, el √∫ltimo es decimal
                        str = puntos.slice(0, -1).join('') + '.' + puntos[puntos.length - 1];
                    }
                    // Si hay un solo punto, asumimos que es decimal (ya est√° bien)
                }
                const parsed = parseFloat(str);
                return isNaN(parsed) ? defaultValue : parsed;
            }
            
            function formatNumberWithThousands(value) {
                if (!value && value !== 0) return '';
                const num = safeParseFloat(value);
                if (isNaN(num) || num === 0) return '';
                // Formatear con separadores de miles (punto) y coma decimal
                // Usar siempre 2 decimales para n√∫meros con decimales, 0 para enteros
                const hasDecimals = num % 1 !== 0;
                const formatted = num.toLocaleString('es-ES', { 
                    minimumFractionDigits: hasDecimals ? 2 : 0, 
                    maximumFractionDigits: 2,
                    useGrouping: true
                });
                return formatted;
            }
            
            function calculateTotal() {
                // Si es VENTA y la moneda vendida es ARS, dividir en lugar de multiplicar
                // Si es COMPRA y la moneda comprada es ARS, tambi√©n dividir
                const subOp = String(formData.subOperacion || '').trim();
                const moneda = String(formData.moneda || '').trim();
                
                const esVentaConARS = subOp === 'VENTA' && moneda === 'ARS';
                const esCompraConARS = subOp === 'COMPRA' && moneda === 'ARS';
                
                if (esVentaConARS || esCompraConARS) {
                    formData.total = (safeParseFloat(formData.monto) / safeParseFloat(formData.tc)).toFixed(2);
                } else {
                    // Para otras operaciones, multiplicar (l√≥gica original)
                    formData.total = (safeParseFloat(formData.monto) * safeParseFloat(formData.tc)).toFixed(2);
                }
            }
            
            function calculatePrestamo() {
                const monto = safeParseFloat(formData.monto);
                const interesTotal = (monto * safeParseFloat(formData.interes) * safeParseFloat(formData.lapso)) / (365 * 100);
                formData.total = (monto + interesTotal).toFixed(2);
            }
            
            function calculateArbitraje() {
                const montoBase = safeParseFloat(formData.montoBase);
                const cotizacionCliente = safeParseFloat(formData.cotizacionCliente);
                const montoCobrado = safeParseFloat(formData.montoCobrado);
                const cotizacionReal = safeParseFloat(formData.cotizacionReal);
                const costoReal = safeParseFloat(formData.costoReal);

                // L√ìGICA BIDIRECCIONAL basada en lastEditedField
                // Primera ecuaci√≥n: Monto Base √ó Cotizaci√≥n Cliente = Monto Cobrado
                if (lastEditedField === 'montoBase') {
                    if (cotizacionCliente > 0) {
                        formData.montoCobrado = (montoBase * cotizacionCliente).toFixed(2);
                    }
                } else if (lastEditedField === 'cotizacionCliente') {
                    if (montoBase > 0) {
                        formData.montoCobrado = (montoBase * cotizacionCliente).toFixed(2);
                    }
                } else if (lastEditedField === 'montoCobrado') {
                    if (montoBase > 0 && montoBase !== 0) {
                        formData.cotizacionCliente = (montoCobrado / montoBase).toFixed(2);
                    } else if (cotizacionCliente > 0 && cotizacionCliente !== 0) {
                        formData.montoBase = (montoCobrado / cotizacionCliente).toFixed(2);
                    }
                }

                // Segunda ecuaci√≥n: Monto Base √ó Cotizaci√≥n Real = Costo Real
                const montoBaseFinal = safeParseFloat(formData.montoBase);
                if (lastEditedField === 'montoBase' || lastEditedField === 'cotizacionReal') {
                    if (montoBaseFinal > 0 && cotizacionReal > 0) {
                        formData.costoReal = (montoBaseFinal * cotizacionReal).toFixed(2);
                    }
                } else if (lastEditedField === 'costoReal') {
                    if (montoBaseFinal > 0 && montoBaseFinal !== 0) {
                        formData.cotizacionReal = (costoReal / montoBaseFinal).toFixed(2);
                    } else if (cotizacionReal > 0 && cotizacionReal !== 0) {
                        formData.montoBase = (costoReal / cotizacionReal).toFixed(2);
                    }
                }

                // Calcular Profit si tengo montoCobrado y costoReal
                const montoCobradoFinal = safeParseFloat(formData.montoCobrado);
                const costoRealFinal = safeParseFloat(formData.costoReal);
                if (montoCobradoFinal > 0 && costoRealFinal > 0) {
                    formData.profit = (montoCobradoFinal - costoRealFinal).toFixed(2);
                }

                // Actualizar campos en el DOM
                const montoCobradoInput = document.querySelector('[name="montoCobrado"]');
                const cotizacionClienteInput = document.querySelector('[name="cotizacionCliente"]');
                const montoBaseInput = document.querySelector('[name="montoBase"]');
                const cotizacionRealInput = document.querySelector('[name="cotizacionReal"]');
                const costoRealInput = document.querySelector('[name="costoReal"]');
                const profitInput = document.querySelector('[name="profit"]');

                if (montoCobradoInput) montoCobradoInput.value = formData.montoCobrado || '';
                if (cotizacionClienteInput) cotizacionClienteInput.value = formData.cotizacionCliente || '';
                if (montoBaseInput) montoBaseInput.value = formData.montoBase || '';
                if (cotizacionRealInput) cotizacionRealInput.value = formData.cotizacionReal || '';
                if (costoRealInput) costoRealInput.value = formData.costoReal || '';
                if (profitInput) profitInput.value = formData.profit || '';
            }

            function calculateComisionAndTotal() {
                const monto = safeParseFloat(formData.monto);
                let montoComision = 0;

                if (formData.comisionTipo === 'porcentaje') {
                    montoComision = (monto * safeParseFloat(formData.comisionValor)) / 100;
                    formData.monedaComision = formData.moneda;
                } else {
                    montoComision = safeParseFloat(formData.comisionValor);
                }
                formData.montoComision = montoComision.toFixed(2);
                
                if (formData.operacion === 'CUENTAS_CORRIENTES' && ['INGRESO', 'EGRESO'].includes(formData.subOperacion)) {
                     formData.total = (monto + montoComision).toFixed(2);
                }
            }

            /**
             * =================================================================
             * RENDERIZADO DIN√ÅMICO DE LA INTERFAZ
             * =================================================================
             */
            function getDynamicFields() {
                const { operacion, subOperacion } = formData;
                if (!operacion || !subOperacion) return '';
                const key = `${operacion}_${subOperacion}`;
                
                const fieldsConfig = {
                    'TRANSACCIONES_COMPRA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Compramos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Comprada</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se recibe</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Pago</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet desde donde se paga</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Pagar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'TRANSACCIONES_VENTA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Vendemos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Vendida</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde sale</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Cobro</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se cobra</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Cobrar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'TRANSACCIONES_ARBITRAJE': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto Base</label><input type="text" inputmode="numeric" class="form-input" name="montoBase" value="${formData.montoBase || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Base</label><div class="moneda-buttons-container" id="monedaBaseButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de Origen (Base)</label><div class="wallet-buttons-container" id="walletBaseButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Cotizaci√≥n Cliente</label><input type="text" inputmode="numeric" class="form-input" name="cotizacionCliente" value="${formData.cotizacionCliente || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Cotizaci√≥n Real</label><input type="text" inputmode="numeric" class="form-input" name="cotizacionReal" value="${formData.cotizacionReal || ''}" placeholder="0.00" step="0.01"></div>
                        </div>
                        <div class="form-grid">
                             <div class="form-group"><label class="form-label">Monto Cobrado</label><input type="text" inputmode="numeric" class="form-input" name="montoCobrado" value="${formData.montoCobrado || ''}" placeholder="0.00" step="0.01"></div>
                             <div class="form-group"><label class="form-label">Moneda de Cobro</label><div class="moneda-buttons-container" id="monedaCobroButtons"></div></div>
                        </div>
                         <div class="field-separator"></div>
                         <div class="form-grid">
                            <div class="form-group"><label class="form-label">Costo Real</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="costoReal" value="${formData.costoReal || ''}" readonly></div>
                            <div class="form-group"><label class="form-label">Profit</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="profit" value="${formData.profit || ''}" readonly></div>
                        </div>
                        <div class="form-grid">
                             <div class="form-group"><label class="form-label">Moneda del Profit</label><div class="moneda-buttons-container" id="monedaProfitButtons"></div></div>
                             <div class="form-group"><label class="form-label">Wallet Destino (Profit)</label><div class="wallet-buttons-container" id="walletProfitButtons"></div></div>
                        </div>`,
                    'CUENTAS_CORRIENTES_INGRESO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto Ingreso</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde ingresa</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-group"><label class="form-label">Comisi√≥n</label><div style="display: flex; gap: 10px;"><button type="button" class="btn-option ${formData.comisionTipo === 'porcentaje' ? 'active' : ''}" id="comisionPorcentajeBtn" style="flex: 1;">%</button><button type="button" class="btn-option ${formData.comisionTipo === 'fijo' ? 'active' : ''}" id="comisionFijoBtn" style="flex: 1;">$</button></div></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Valor Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input" name="comisionValor" value="${formData.comisionValor || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group ${formData.comisionTipo === 'porcentaje' ? 'hidden' : ''}" id="monedaComisionContainer"><label class="form-label">Moneda Comisi√≥n</label><div class="moneda-buttons-container" id="monedaComisionButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Monto Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="montoComision" value="${formData.montoComision || ''}" readonly></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_EGRESO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto Egreso</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde egresa</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-group"><label class="form-label">Comisi√≥n</label><div style="display: flex; gap: 10px;"><button type="button" class="btn-option ${formData.comisionTipo === 'porcentaje' ? 'active' : ''}" id="comisionPorcentajeBtn" style="flex: 1;">%</button><button type="button" class="btn-option ${formData.comisionTipo === 'fijo' ? 'active' : ''}" id="comisionFijoBtn" style="flex: 1;">$</button></div></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Valor Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input" name="comisionValor" value="${formData.comisionValor || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group ${formData.comisionTipo === 'porcentaje' ? 'hidden' : ''}" id="monedaComisionContainer"><label class="form-label">Moneda Comisi√≥n</label><div class="moneda-buttons-container" id="monedaComisionButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Monto Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="montoComision" value="${formData.montoComision || ''}" readonly></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_COMPRA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Compramos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Comprada</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se recibe</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Pago</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet desde donde se paga</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Pagar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_VENTA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Vendemos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Vendida</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde sale</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Cobro</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se cobra</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Cobrar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_ARBITRAJE': `<p style="color: var(--text-secondary);">Arbitraje para Cuentas Corrientes pendiente de definici√≥n.</p>`,
                    'WALLET_INGRESO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto de Ingreso</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet Destino</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_SALIDA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto de Salida</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet Origen</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_MOV ENTRE CUENTAS': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="field-separator"></div>
                        <div class="form-group"><label class="form-label">Wallet de Salida</label><div class="wallet-buttons-container" id="cuentaSalidaButtons"></div></div>
                        <div class="form-group"><label class="form-label">Wallet de Ingreso</label><div class="wallet-buttons-container" id="cuentaIngresoButtons"></div></div>`,
                    'ADMINISTRATIVAS_GASTO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto del Gasto</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de Origen</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                     'ADMINISTRATIVAS_AJUSTE': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto del Ajuste</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet a ajustar</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'PRESTAMISTAS_PRESTAMO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto del Pr√©stamo</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                         <div class="form-grid">
                            <div class="form-group"><label class="form-label">% Inter√©s Anual</label><input type="text" inputmode="numeric" class="form-input" name="interes" value="${formData.interes || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Lapso (d√≠as)</label><input type="text" inputmode="numeric" class="form-input" name="lapso" value="${formData.lapso || ''}" placeholder="30"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde sale</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Monto Total a Devolver (con inter√©s)</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'PRESTAMISTAS_RETIRO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto a Retirar</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de Origen</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_CREAR WALLET': `
                        <div class="form-group"><label class="form-label">C√≥digo/ID de la Wallet (√∫nico)</label><input type="text" class="form-input" id="walletId" placeholder="ej: W1, JUAN, PROV_X"></div>
                        <div class="form-group"><label class="form-label">Nombre de la Wallet (descriptivo)</label><input type="text" class="form-input" id="walletNombre" placeholder="ej: Cliente Juan P√©rez"></div>
                        <div class="form-group"><label class="form-label">Tipo de Wallet</label><div style="display: flex; gap: 15px; margin-top: 10px;"><label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="walletTipoEfectivo" style="width: 18px; height: 18px; cursor: pointer;"><span style="color: var(--text-primary);">Efectivo</span></label><label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="walletTipoDigital" style="width: 18px; height: 18px; cursor: pointer;"><span style="color: var(--text-primary);">Digital</span></label></div></div>
                        <div class="form-group"><label class="form-label">Monedas que Opera</label><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;" id="walletMonedasCheckboxes">${monedas.map(m => `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" value="${m.value}" class="wallet-moneda-checkbox" style="width: 18px; height: 18px; cursor: pointer;"><span style="color: var(--text-primary); font-size: 13px;">${m.label}</span></label>`).join('')}</div></div>
                        <div style="margin-top: 30px;"><button type="button" class="btn-submit" id="saveWalletBtn" style="width: 100%;">Guardar Wallet</button></div>`,
                    'WALLET_LISTA DE WALLETS': `<div id="walletsListContainer"></div>`
                };
                return fieldsConfig[key] || `<p style="color: var(--text-secondary);">Configuraci√≥n de campos para ${operacion} > ${subOperacion} no encontrada.</p>`;
            }
            
            function renderOperationsModule() {
                const titulo = editingMovimientoId ? 'üí± Editar Operaci√≥n Financiera' : 'üí± Nueva Operaci√≥n Financiera';
                return `
                    <div class="operations-container">
                        <div class="form-card">
                            <div class="form-header"><h2 class="form-title">${titulo}</h2></div>
                            <form id="operationsForm">
                                <div class="form-grid">
                                    <div class="form-group"><label class="form-label" for="fecha">Fecha y D√≠a</label><div class="fecha-dia-group"><input type="date" class="form-input" id="fecha" name="fecha" value="${formData.fecha}" required><input type="text" class="form-input" id="nombreDia" name="nombreDia" value="${formData.nombreDia || ''}" readonly></div></div>
                                </div>
                                <div class="form-group"><label class="form-label section-title">Paso 1: Seleccionar Operaci√≥n</label><div class="button-grid" id="operationButtons"></div></div>
                                <div class="form-group ${!formData.operacion ? 'hidden' : ''}" id="subOperationContainer"><label class="form-label section-title">Paso 2: Seleccionar Tipo</label><div class="button-grid" id="subOperationButtons"></div></div>
                                <div class="form-group hidden" id="clienteContainer" style="margin-bottom: 20px;"><label class="form-label" for="cliente">Cliente</label><div class="input-with-button"><select class="form-select" id="cliente" name="cliente" required><option value="">Seleccionar cliente...</option>${getClientes().map(c => `<option value="${c.id}" ${formData.cliente === c.id ? 'selected' : ''}>${c.nombre}${c.documento ? ' - ' + c.documento : ''}</option>`).join('')}</select><button type="button" class="btn-add" id="addClientBtn" title="Crear nuevo cliente">+</button></div></div>
                                <div class="form-group" style="margin-bottom: 32px;"><label class="form-label" for="detalle">Detalle</label><textarea class="form-textarea" id="detalle" name="detalle" placeholder="Descripci√≥n de la operaci√≥n">${formData.detalle || ''}</textarea></div>
                                <div class="dynamic-fields-container" id="dynamicFieldsContainer"></div>
                                <div id="mixedPaymentsContainer" class="${formData.isMixedPaymentActive ? '' : 'hidden'}"></div>
                                <div class="form-grid ${['WALLET', 'ADMINISTRATIVAS'].includes(formData.operacion) ? 'hidden' : ''}" id="estadoPorContainer">
                                    <div class="form-group"><label class="form-label" for="estado">Estado</label><select class="form-select" id="estado" name="estado">${estados.map(e => `<option value="${e.value}" ${formData.estado === e.value ? 'selected' : ''}>${e.label}</option>`).join('')}</select></div>
                                    <div class="form-group"><label class="form-label" for="por">Por</label><input type="text" class="form-input" id="por" name="por" value="${formData.por || ''}" placeholder="Nombre"></div>
                                </div>
                                ${formData.subOperacion !== 'CREAR WALLET' && formData.subOperacion !== 'LISTA DE WALLETS' ? '<div class="form-actions"><button type="button" class="btn-cancel" id="cancelBtn">Cancelar</button><button type="submit" class="btn-submit">Guardar Operaci√≥n</button></div>' : ''}
                            </form>
                        </div>
                    </div>`;
            }

            function renderButtonSet(containerId, dataKey, items, cssClass = 'btn-option') {
                const container = document.getElementById(containerId);
                if (!container) return;
                const isOperation = items.length > 0 && items[0].subMenu;
                
                // Obtener el valor actual - asegurarse de que sea string para comparaci√≥n exacta
                const currentValue = String(formData[dataKey] || '');
                
                // Limpiar contenedor completamente
                container.innerHTML = '';
                
                // Crear funci√≥n handler √∫nica para este grupo
                const handleButtonClick = (selectedValue, clickedButton) => {
                    // SIEMPRE desactivar TODOS los botones del contenedor primero
                    // Usar querySelectorAll para obtener TODOS los botones, sin importar la clase
                    const allButtons = container.querySelectorAll('button');
                    allButtons.forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Activar solo el bot√≥n clickeado
                    clickedButton.classList.add('active');
                    formData[dataKey] = selectedValue;
                    
                    // Verificaci√≥n adicional: asegurar que solo este bot√≥n est√© activo
                    const stillActive = container.querySelectorAll('.active');
                    if (stillActive.length > 1) {
                        stillActive.forEach(b => {
                            if (b !== clickedButton) {
                                b.classList.remove('active');
                            }
                        });
                    }
                    
                    if (dataKey === 'operacion') handleOperationChange(selectedValue);
                    else if (dataKey === 'subOperacion') handleSubOperationChange(selectedValue);
                    else updateCalculatedFieldsAndUI();
                    saveFormState();
                };
                
                // Crear botones con onclick directo para evitar listeners duplicados
                items.forEach(item => {
                    const value = isOperation ? item.key : item.value;
                    const label = isOperation ? `${item.icon} ${item.key.replace('_', ' ')}` : item.label;
                    // Comparaci√≥n estricta con string
                    const isActive = String(value) === currentValue;
                    
                    const button = document.createElement('button');
                    button.type = 'button';
                    // Asegurarse de que solo este bot√≥n tenga 'active' si coincide
                    button.className = cssClass + (isActive ? ' active' : '');
                    button.dataset.value = value;
                    button.textContent = label;
                    button.tabIndex = 0; // Hacer navegable con teclado
                    
                    // Permitir activar con Enter o Espacio
                    button.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleClick.call(button, { target: button });
                        }
                    });
                    
                    // Usar onclick directo para evitar acumulaci√≥n de listeners
                    button.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleButtonClick(value, button);
                    };
                    
                    container.appendChild(button);
                });
                
                // Verificaci√≥n final: FORZAR que solo UN bot√≥n est√© activo
                const activeButtons = container.querySelectorAll('.active');
                if (activeButtons.length > 1) {
                    // Si hay m√∫ltiples activos, desactivar TODOS primero
                    activeButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Luego activar solo el que coincide con currentValue (si existe)
                    if (currentValue) {
                        const correctButton = container.querySelector(`[data-value="${currentValue}"]`);
                        if (correctButton) {
                            correctButton.classList.add('active');
                        }
                    }
                } else if (activeButtons.length === 0 && currentValue) {
                    // Si no hay ninguno activo pero hay un valor, activarlo
                    const correctButton = container.querySelector(`[data-value="${currentValue}"]`);
                    if (correctButton) {
                        correctButton.classList.add('active');
                    }
                }
            }
            
            /**
             * =================================================================
             * MANEJO DE L√ìGICA Y EVENTOS DEL FORMULARIO
             * =================================================================
             */
            function handleOperationChange(operation) {
                formData.subOperacion = '';
                
                // LIMPIAR TODOS los contenedores de campos din√°micos
                const dynamicContainer = document.getElementById('dynamicFieldsContainer');
                if (dynamicContainer) {
                    dynamicContainer.innerHTML = '';
                }
                
                const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                if (mixedPaymentsContainer) {
                    mixedPaymentsContainer.innerHTML = '';
                    mixedPaymentsContainer.classList.add('hidden');
                }
                
                // Resetear estado de pagos mixtos
                formData.isMixedPaymentActive = false;
                formData.mixedPayments = [];
                
                // Ocultar contenedores que no aplican
                document.getElementById('clienteContainer')?.classList.add('hidden');
                
                // Renderizar suboperaciones
                const subOpContainer = document.getElementById('subOperationContainer');
                if (subOpContainer) {
                    const subOps = operaciones[operation].subMenu.map(sub => ({ value: sub, label: sub }));
                    subOpContainer.classList.remove('hidden');
                    renderButtonSet('subOperationButtons', 'subOperacion', subOps);
                }
            }

            function handleSubOperationChange(subOperation) {
                const dynamicContainer = document.getElementById('dynamicFieldsContainer');
                const clienteContainer = document.getElementById('clienteContainer');
                const estadoPorContainer = document.getElementById('estadoPorContainer');
                const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                
                // PRIMERO: Limpiar completamente todos los contenedores
                if (dynamicContainer) {
                    dynamicContainer.innerHTML = '';
                }
                
                if (mixedPaymentsContainer) {
                    mixedPaymentsContainer.innerHTML = '';
                    mixedPaymentsContainer.classList.add('hidden');
                }
                
                // Resetear pagos mixtos si no aplica
                if (subOperation !== 'VENTA' && subOperation !== 'COMPRA') {
                    formData.isMixedPaymentActive = false;
                    formData.mixedPayments = [];
                }
                
                // LUEGO: Mostrar/ocultar contenedores seg√∫n corresponda
                if (clienteContainer) {
                    if (['TRANSACCIONES', 'CUENTAS_CORRIENTES', 'PRESTAMISTAS'].includes(formData.operacion)) {
                        clienteContainer.classList.remove('hidden');
                        // Actualizar select de clientes cuando se muestra
                        updateClientesSelect();
                    } else {
                        clienteContainer.classList.add('hidden');
                    }
                }
                
                if (estadoPorContainer) {
                    if (['WALLET', 'ADMINISTRATIVAS'].includes(formData.operacion)) {
                         estadoPorContainer.classList.add('hidden');
                    } else {
                        estadoPorContainer.classList.remove('hidden');
                    }
                }

                // FINALMENTE: Renderizar los nuevos campos
                if (dynamicContainer) {
                    dynamicContainer.innerHTML = getDynamicFields();
                    initAllDynamicFields();
                }
                
                if (subOperation === 'LISTA DE WALLETS') renderWalletsList();
                
                // Ocultar/mostrar bot√≥n "Guardar Operaci√≥n" seg√∫n la suboperaci√≥n
                const formActions = document.querySelector('.form-actions');
                if (formActions) {
                    if (subOperation === 'CREAR WALLET' || subOperation === 'LISTA DE WALLETS') {
                        formActions.style.display = 'none';
                    } else {
                        formActions.style.display = '';
                    }
                }
                
                updateCalculatedFieldsAndUI();
            }

            function initAllDynamicFields() {
                // Asegurar que los campos de moneda est√©n limpios antes de renderizar
                ['moneda', 'monedaTC', 'monedaBase', 'monedaCobro', 'monedaProfit', 'monedaComision'].forEach(key => {
                    // Si el valor no es una de las monedas v√°lidas, limpiarlo
                    const validValues = monedas.map(m => m.value);
                    if (formData[key] && !validValues.includes(formData[key])) {
                        formData[key] = '';
                    }
                });
                
                // Formatear todos los campos num√©ricos con separadores de miles
                const numericFields = ['monto', 'tc', 'total', 'montoBase', 'cotizacionCliente', 'cotizacionReal', 'montoCobrado', 'costoReal', 'profit', 'interes', 'lapso', 'comisionValor', 'montoComision'];
                numericFields.forEach(fieldName => {
                    const input = document.querySelector(`[name="${fieldName}"]`);
                    if (input && !input.readOnly && formData[fieldName]) {
                        const formatted = formatNumberWithThousands(formData[fieldName]);
                        if (formatted && input.value !== formatted) {
                            input.value = formatted;
                        }
                    }
                });
                
                initWalletButtons('walletCompraButtons', 'walletCompra');
                initWalletButtons('walletTCButtons', 'walletTC', true);
                initWalletButtons('walletBaseButtons', 'walletBase');
                initWalletButtons('walletProfitButtons', 'walletProfit');
                initWalletButtons('cuentaSalidaButtons', 'cuentaSalida');
                initWalletButtons('cuentaIngresoButtons', 'cuentaIngreso');
                
                ['monedaButtons', 'monedaTCButtons', 'monedaBaseButtons', 'monedaCobroButtons', 'monedaProfitButtons', 'monedaComisionButtons']
                    .forEach(id => {
                        const key = id.replace('Buttons', '');
                        // Limpiar el contenedor antes de renderizar
                        const container = document.getElementById(id);
                        if (container) {
                            container.innerHTML = '';
                        }
                        renderButtonSet(id, key, monedas, 'btn-option btn-moneda');
                    });
                
                initComisionEvents();
                initWalletManagement();
                if (formData.isMixedPaymentActive) {
                    const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                    if (mixedPaymentsContainer) {
                        renderMixedPayments();
                    }
                }
            }

            function updateCalculatedFieldsAndUI() {
                const { operacion, subOperacion } = formData;
                let calculated = false;

                if ((operacion === 'TRANSACCIONES' || operacion === 'CUENTAS_CORRIENTES') && (subOperacion === 'COMPRA' || subOperacion === 'VENTA')) {
                    calculateTotal(); calculated = true;
                } else if (operacion === 'TRANSACCIONES' && subOperacion === 'ARBITRAJE') {
                    calculateArbitraje(); calculated = true;
                } else if (operacion === 'PRESTAMISTAS' && subOperacion === 'PRESTAMO') {
                    calculatePrestamo(); calculated = true;
                } else if (operacion === 'CUENTAS_CORRIENTES' && (subOperacion === 'INGRESO' || subOperacion === 'EGRESO')) {
                    calculateComisionAndTotal(); calculated = true;
                }
                
                if (calculated) {
                    ['total', 'montoBase', 'costoReal', 'profit', 'montoComision'].forEach(fieldName => {
                        const input = document.querySelector(`[name="${fieldName}"]`);
                        if (input && document.activeElement !== input) {
                            // Formatear el valor con separadores de miles
                            const value = formData[fieldName] || '';
                            input.value = formatNumberWithThousands(value);
                        }
                    });
                }
                updateMixedPaymentsTotal();
            }

            function initOperationsModule() {
                const form = document.getElementById('operationsForm');
                if (!form) return;

                loadFormState();
                
                // Formatear todos los campos num√©ricos despu√©s de cargar el estado
                setTimeout(() => {
                    const numericFields = ['monto', 'tc', 'total', 'montoBase', 'cotizacionCliente', 'cotizacionReal', 'montoCobrado', 'costoReal', 'profit', 'interes', 'lapso', 'comisionValor', 'montoComision'];
                    numericFields.forEach(fieldName => {
                        const input = document.querySelector(`[name="${fieldName}"]`);
                        if (input && !input.readOnly && formData[fieldName]) {
                            const formatted = formatNumberWithThousands(formData[fieldName]);
                            if (formatted) {
                                input.value = formatted;
                            }
                        }
                    });
                }, 100);

                const fechaInput = form.querySelector('[name="fecha"]');
                const nombreDiaInput = form.querySelector('[name="nombreDia"]');
                const updateDayName = () => {
                    if (fechaInput.value) {
                        const fecha = new Date(fechaInput.value + 'T00:00:00');
                        nombreDiaInput.value = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][fecha.getDay()];
                        formData.nombreDia = nombreDiaInput.value;
                    }
                };
                fechaInput.addEventListener('change', () => { updateDayName(); saveFormState(); });
                if (!formData.nombreDia) updateDayName();

                const operationItems = Object.entries(operaciones).map(([key, value]) => ({ key, ...value }));
                renderButtonSet('operationButtons', 'operacion', operationItems);
                
                // Actualizar select de clientes
                updateClientesSelect();
                
                if (formData.operacion) {
                    handleOperationChange(formData.operacion);
                    if (formData.subOperacion) {
                        const subBtn = document.querySelector(`#subOperationButtons [data-value="${formData.subOperacion}"]`);
                        if (subBtn) subBtn.classList.add('active');
                        handleSubOperationChange(formData.subOperacion);
                    }
                }
                
                form.addEventListener('input', (e) => {
                    // Actualizar lastEditedField para arbitraje bidireccional
                    const arbitrajeFields = ['montoBase', 'cotizacionCliente', 'montoCobrado', 'cotizacionReal', 'costoReal'];
                    if (arbitrajeFields.includes(e.target.name)) {
                        lastEditedField = e.target.name;
                    }
                    const name = e.target.name;
                    if (name && formData.hasOwnProperty(name)) {
                        // Guardar el valor sin formatear para c√°lculos
                        const numericValue = safeParseFloat(e.target.value);
                        formData[name] = numericValue > 0 ? numericValue.toString() : '';
                        
                        // No formatear mientras se escribe, solo guardar el valor num√©rico
                        
                        if (['monto', 'tc', 'montoBase', 'cotizacionCliente', 'cotizacionReal', 'montoCobrado', 'costoReal', 'interes', 'lapso', 'comisionValor'].includes(name)) {
                            updateCalculatedFieldsAndUI();
                        }
                        saveFormState();
                    }
                });
                
                // Formatear campos num√©ricos cuando pierden el foco
                form.addEventListener('blur', (e) => {
                    const name = e.target.name;
                    const numericFields = ['monto', 'tc', 'montoBase', 'cotizacionCliente', 'cotizacionReal', 'montoCobrado', 'costoReal', 'interes', 'lapso', 'comisionValor', 'total', 'profit', 'montoComision'];
                    if (numericFields.includes(name) && !e.target.readOnly && e.target.value) {
                        const numValue = safeParseFloat(e.target.value);
                        if (!isNaN(numValue) && numValue > 0) {
                            const formatted = formatNumberWithThousands(numValue);
                            if (formatted) {
                                e.target.value = formatted;
                            }
                        }
                    }
                }, true);
                
                form.addEventListener('change', (e) => {
                    const name = e.target.name;
                    if (name === 'cliente' && formData.hasOwnProperty(name)) {
                        formData[name] = e.target.value;
                        saveFormState();
                    }
                });

                // Navegaci√≥n con teclado: Enter y flechas
                form.addEventListener('keydown', (e) => {
                    // Prevenir submit al presionar Enter (excepto en botones submit)
                    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.type !== 'submit' && !e.target.classList.contains('btn-option')) {
                        e.preventDefault();
                        
                        // Obtener todos los elementos interactivos (inputs, selects, botones)
                        const focusableElements = Array.from(form.querySelectorAll(
                            'input:not([type="hidden"]):not([readonly]), select, textarea, button[tabindex="0"], button:not([type="submit"])'
                        ));
                        
                        const currentIndex = focusableElements.indexOf(e.target);
                        if (currentIndex < focusableElements.length - 1) {
                            focusableElements[currentIndex + 1].focus();
                        }
                    }
                    
                    // Navegaci√≥n con flechas arriba/abajo en inputs y selects
                    if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && 
                        (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA')) {
                        e.preventDefault();
                        
                        const focusableElements = Array.from(form.querySelectorAll(
                            'input:not([type="hidden"]):not([readonly]), select, textarea, button[tabindex="0"], button:not([type="submit"])'
                        ));
                        
                        const currentIndex = focusableElements.indexOf(e.target);
                        if (e.key === 'ArrowDown' && currentIndex < focusableElements.length - 1) {
                            focusableElements[currentIndex + 1].focus();
                        } else if (e.key === 'ArrowUp' && currentIndex > 0) {
                            focusableElements[currentIndex - 1].focus();
                        }
                    }
                    
                    // Navegaci√≥n con flechas izquierda/derecha en botones
                    if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && 
                        (e.target.classList.contains('btn-option') || e.target.tagName === 'BUTTON')) {
                        e.preventDefault();
                        
                        // Buscar el contenedor del bot√≥n actual
                        const container = e.target.closest('.moneda-buttons-container, .wallet-buttons-container, .button-grid, #operationButtons, #subOperationButtons');
                        if (container) {
                            const buttons = Array.from(container.querySelectorAll('button'));
                            const currentIndex = buttons.indexOf(e.target);
                            
                            if (e.key === 'ArrowRight' && currentIndex < buttons.length - 1) {
                                buttons[currentIndex + 1].focus();
                            } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
                                buttons[currentIndex - 1].focus();
                            }
                        }
                    }
                });
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    // Crear copia del formData para guardar
                    const movimientoData = JSON.parse(JSON.stringify(formData));
                    
                    // Si estamos editando, actualizar el movimiento existente
                    if (editingMovimientoId) {
                        updateMovimiento(editingMovimientoId, movimientoData);
                        showToast('Movimiento actualizado con √©xito', 'success');
                        editingMovimientoId = null;
                    } else {
                        // Si es nuevo, crear el movimiento
                        const movimientoId = addMovimiento(movimientoData);
                        
                        // Actualizar √∫ltima operaci√≥n del cliente si hay uno seleccionado
                        if (formData.cliente) {
                            actualizarUltimaOperacionCliente(formData.cliente);
                        }
                        
                        showToast('Operaci√≥n guardada con √©xito', 'success');
                    }
                    
                    clearFormState();
                    loadModule('operaciones');
                });
                
                document.getElementById('cancelBtn')?.addEventListener('click', () => {
                    if (confirm('¬øDeseas cancelar? Se perder√°n los datos.')) {
                        clearFormState();
                        loadModule('operaciones');
                    }
                });
                
                document.getElementById('addClientBtn')?.addEventListener('click', () => {
                    // Abrir m√≥dulo de clientes
                    loadModule('clientes');
                    // Cerrar sidebar si est√° abierto
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    if (sidebar && overlay) {
                        sidebar.classList.remove('open');
                        overlay.classList.remove('active');
                    }
                });
            }
            
            function initWalletButtons(containerId, fieldName, includesPagoMixto = false) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const currentValue = formData[fieldName] || '';
                const [currentWallet, currentType] = currentValue.split('_');
                const wallets = getWallets();
                const tipoLabel = ['VENTA', 'INGRESO'].includes(formData.subOperacion) ? 'Cobro' : 'Pago';

                let html = `
                    <div class="wallet-step-label">Paso 1: Seleccionar Wallet</div>
                    <div class="wallet-step" id="${containerId}_wallets">
                        ${wallets.length === 0 ? `<p style="color: var(--text-secondary); font-size: 13px;">No hay wallets creadas.</p>` : 
                            wallets.map(w => `<button type="button" class="btn-wallet ${currentWallet === w.id ? 'active' : ''}" data-wallet="${w.id}">${w.nombre}</button>`).join('')}
                        ${includesPagoMixto ? `<button type="button" class="btn-wallet ${currentValue === 'pago_mixto' ? 'active' : ''}" data-wallet="pago_mixto">${tipoLabel} Mixto</button>` : ''}
                    </div>
                    <div class="wallet-step-label">Paso 2: Tipo de ${tipoLabel}</div>
                    <div class="wallet-step" id="${containerId}_types">
                        ${(() => {
                            const selectedWallet = wallets.find(w => w.id === currentWallet);
                            const canBeEfectivo = selectedWallet && selectedWallet.tipos && selectedWallet.tipos.includes('efectivo');
                            const canBeDigital = selectedWallet && selectedWallet.tipos && selectedWallet.tipos.includes('digital');
                            return `
                        <button type="button" class="btn-wallet ${currentType === 'efectivo' ? 'active' : ''}" data-type="efectivo" ${!currentWallet || currentValue === 'pago_mixto' || !canBeEfectivo ? 'disabled' : ''}>Efectivo</button>
                        <button type="button" class="btn-wallet ${currentType === 'digital' ? 'active' : ''}" data-type="digital" ${!currentWallet || currentValue === 'pago_mixto' || !canBeDigital ? 'disabled' : ''}>Digital</button>`;
                        })()}
                    </div>`;
                container.innerHTML = html;

                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-wallet')) {
                        const walletsContainer = e.target.closest(`#${containerId}_wallets`);
                        const typesContainer = e.target.closest(`#${containerId}_types`);
                        const walletId = walletsContainer && walletsContainer.contains(e.target) ? e.target.dataset.wallet : null;
                        const type = typesContainer && typesContainer.contains(e.target) ? e.target.dataset.type : null;

                        if (walletId) {
                            formData[fieldName] = walletId === 'pago_mixto' ? 'pago_mixto' : walletId;
                            formData.isMixedPaymentActive = walletId === 'pago_mixto';
                        } else if (type) {
                            const [selectedWallet] = (formData[fieldName] || '').split('_');
                            if(selectedWallet && selectedWallet !== 'pago_mixto') {
                                formData[fieldName] = `${selectedWallet}_${type}`;
                            }
                        }
                        
                        saveFormState();
                        initWalletButtons(containerId, fieldName, includesPagoMixto);
                        const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                        if (mixedPaymentsContainer) {
                            mixedPaymentsContainer.classList.toggle('hidden', !formData.isMixedPaymentActive);
                            if (formData.isMixedPaymentActive) renderMixedPayments();
                        }
                    }
                });
            }

            function initWalletManagement() {
                const saveBtn = document.getElementById('saveWalletBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        const id = document.getElementById('walletId')?.value.trim();
                        const nombre = document.getElementById('walletNombre')?.value.trim();
                        const tipos = [...document.querySelectorAll('#walletTipoEfectivo, #walletTipoDigital')].filter(cb => cb.checked).map(cb => cb.id.replace('walletTipo', '').toLowerCase());
                        const monedas = [...document.querySelectorAll('.wallet-moneda-checkbox:checked')].map(cb => cb.value);

                        if (!id || !nombre || tipos.length === 0 || monedas.length === 0) return showToast('Todos los campos son obligatorios.', 'error');
                        if (getWallets().some(w => w.id === id)) return showToast('Ya existe una wallet con ese ID.', 'error');

                        addWallet({ id, nombre, tipos, monedas });
                        showToast(`Wallet "${nombre}" creada con √©xito.`, 'success');
                        handleSubOperationChange('CREAR WALLET');
                    });
                }
            }
        
            function renderWalletsList() {
                const container = document.getElementById('walletsListContainer');
                if (!container) return;
                const wallets = getWallets();
                container.innerHTML = wallets.length === 0 ? '<p style="color: var(--text-secondary);">No hay wallets creadas.</p>' :
                    wallets.map(w => `
                        <div class="form-card" style="padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div><h3 style="font-size: 16px;">${w.nombre}</h3><p style="color: var(--text-secondary); font-size: 13px;">ID: ${w.id}</p></div>
                                <button type="button" class="btn-remove" data-wallet-id="${w.id}">‚úï</button>
                            </div>
                            <div class="form-grid" style="font-size: 13px; margin-top: 15px; margin-bottom: 0;">
                                <div><p>Tipo: ${w.tipos.join(', ')}</p></div><div><p>Monedas: ${w.monedas.join(', ')}</p></div>
                            </div>
                        </div>`).join('');

                container.addEventListener('click', e => {
                    if (e.target.classList.contains('btn-remove')) {
                        const walletId = e.target.dataset.walletId;
                        if (confirm(`¬øEliminar la wallet "${walletId}"?`)) {
                            deleteWallet(walletId);
                            showToast('Wallet eliminada.', 'success');
                            renderWalletsList();
                        }
                    }
                });
            }

            function initComisionEvents() {
                const form = document.getElementById('operationsForm');
                if (!form) return;
                const porcentajeBtn = form.querySelector('#comisionPorcentajeBtn');
                const fijoBtn = form.querySelector('#comisionFijoBtn');
                const container = form.querySelector('#monedaComisionContainer');

                porcentajeBtn?.addEventListener('click', () => {
                    formData.comisionTipo = 'porcentaje';
                    porcentajeBtn.classList.add('active');
                    fijoBtn?.classList.remove('active');
                    container?.classList.add('hidden');
                    updateCalculatedFieldsAndUI();
                    saveFormState();
                });
                fijoBtn?.addEventListener('click', () => {
                    formData.comisionTipo = 'fijo';
                    fijoBtn.classList.add('active');
                    porcentajeBtn?.classList.remove('active');
                    container?.classList.remove('hidden');
                    updateCalculatedFieldsAndUI();
                    saveFormState();
                });
            }
            
            function renderMixedPayments() {
                const container = document.getElementById('mixedPaymentsContainer');
                if (!container) return;
                const tipoLabel = formData.subOperacion === 'VENTA' ? 'Cobro' : 'Pago';
                container.innerHTML = `
                    <div class="mixed-payments-section">
                        <h3 style="margin-bottom: 20px; font-size: 16px;">${tipoLabel}s Mixtos</h3>
                        <div id="mixedPaymentsList"></div>
                        <button type="button" class="btn-add-payment" id="addMixedPaymentBtn">+ Agregar ${tipoLabel}</button>
                        <div class="mixed-payment-total"><span>Total Esperado:</span><span id="expectedTotal">0.00</span></div>
                        <div class="mixed-payment-total"><span>Total Agregado:</span><span id="mixedPaymentsTotal" class="total-mismatch">0.00</span></div>
                    </div>`;

                const listContainer = document.getElementById('mixedPaymentsList');
                const wallets = getWallets();
                listContainer.innerHTML = formData.mixedPayments.map((payment, index) => `
                    <div class="mixed-payment-item">
                        <div class="form-group"><label class="form-label">Wallet</label><select class="form-select" data-index="${index}" data-field="wallet"><option value="">Seleccionar</option>${wallets.map(w => w.tipos.map(t => `<option value="${w.id}_${t}" ${payment.wallet === `${w.id}_${t}` ? 'selected' : ''}>${w.nombre} - ${t}</option>`).join('')).join('')}</select></div>
                        <div class="form-group"><label class="form-label">Monto</label><input type="text" inputmode="numeric" class="form-input" data-index="${index}" data-field="monto" value="${formatNumberWithThousands(payment.monto || '')}" placeholder="0.00"></div>
                        <button type="button" class="btn-remove" data-index="${index}">‚úï</button>
                    </div>`).join('');

                listContainer.addEventListener('input', e => {
                    if(e.target.dataset.index) {
                        const index = parseInt(e.target.dataset.index);
                        const field = e.target.dataset.field;
                        
                        // No formatear mientras se escribe, solo guardar el valor num√©rico
                        // Guardar el valor num√©rico, no el formateado
                        if (field === 'monto') {
                            formData.mixedPayments[index][field] = safeParseFloat(e.target.value).toString();
                        } else {
                            formData.mixedPayments[index][field] = e.target.value;
                        }
                        updateMixedPaymentsTotal();
                        saveFormState();
                    }
                });
                
                // Formatear campos de monto cuando pierden el foco
                listContainer.addEventListener('blur', e => {
                    if(e.target.dataset.index && e.target.dataset.field === 'monto' && !e.target.readOnly && e.target.value) {
                        const numValue = safeParseFloat(e.target.value);
                        if (!isNaN(numValue) && numValue > 0) {
                            const formatted = formatNumberWithThousands(numValue);
                            if (formatted) {
                                e.target.value = formatted;
                            }
                        }
                    }
                }, true);
                
                 listContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('btn-remove')) {
                        const index = parseInt(e.target.dataset.index);
                        formData.mixedPayments.splice(index, 1);
                        renderMixedPayments();
                        saveFormState();
                    }
                });
                
                document.getElementById('addMixedPaymentBtn').addEventListener('click', () => {
                    formData.mixedPayments.push({ wallet: '', monto: '' });
                    renderMixedPayments();
                    saveFormState();
                });
                
                updateMixedPaymentsTotal();
            }

            function updateMixedPaymentsTotal() {
                const total = formData.mixedPayments.reduce((sum, p) => sum + safeParseFloat(p.monto), 0);
                const totalEl = document.getElementById('mixedPaymentsTotal');
                const expectedEl = document.getElementById('expectedTotal');
                if (totalEl && expectedEl) {
                    totalEl.textContent = formatNumberWithThousands(total);
                    const expected = safeParseFloat(formData.total);
                    expectedEl.textContent = formatNumberWithThousands(expected);
                    totalEl.classList.toggle('total-match', Math.abs(total - expected) < 0.01);
                    totalEl.classList.toggle('total-mismatch', Math.abs(total - expected) >= 0.01);
                }
            }


            /**
             * =================================================================
             * INICIALIZACI√ìN DE LA APLICACI√ìN
             * =================================================================
             */
            const setupMenu = () => {
                const sidebar = document.getElementById('sidebar'), overlay = document.getElementById('overlay');
                const closeMenu = () => { sidebar.classList.remove('open'); overlay.classList.remove('active'); };
                document.getElementById('menuBtn').addEventListener('click', () => { sidebar.classList.add('open'); overlay.classList.add('active'); });
                document.getElementById('closeBtn').addEventListener('click', closeMenu);
                overlay.addEventListener('click', closeMenu);
                document.querySelectorAll('.menu-link').forEach(link => link.addEventListener('click', e => {
                    e.preventDefault();
                    closeMenu();
                    loadModule(e.target.getAttribute('href').substring(1));
                }));
            };

            const updateDateDisplay = () => {
                const now = new Date();
                const formatted = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('dateDisplay').textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);
            };

            const applyTheme = (theme) => {
                document.body.classList.toggle('light-theme', theme === 'light');
                localStorage.setItem('theme', theme);
            };

            const setupTheme = () => {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                applyTheme(savedTheme);
            };

            function initConfiguracion() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                const setThemeUI = (isDark) => {
                    if(themeToggle) themeToggle.checked = !isDark;
                    if(themeIcon) themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                    if(themeText) themeText.textContent = isDark ? 'Tema Oscuro' : 'Tema Claro';
                };
                const currentTheme = localStorage.getItem('theme') || 'dark';
                setThemeUI(currentTheme === 'dark');
                if(themeToggle) themeToggle.addEventListener('change', (e) => {
                    const newTheme = e.target.checked ? 'light' : 'dark';
                    applyTheme(newTheme);
                    setThemeUI(newTheme === 'dark');
                });
            }

            /**
             * =================================================================
             * M√ìDULO DE CLIENTES
             * =================================================================
             */
            function renderClientesModule() {
                return `
                    <div class="operations-container">
                        <div class="form-card">
                            <div class="form-header">
                                <h2 class="form-title">üë• Gesti√≥n de Clientes</h2>
                            </div>
                            
                            <!-- Tabs para Crear / Listar -->
                            <div style="display: flex; gap: 10px; margin-bottom: 24px; border-bottom: 1px solid var(--border-color);">
                                <button type="button" class="btn-option active" id="tabCrearCliente" style="border-bottom: 2px solid var(--active-bg); border-radius: 0; margin-bottom: -1px;">Crear Cliente</button>
                                <button type="button" class="btn-option" id="tabListarClientes" style="border-bottom: 2px solid transparent; border-radius: 0; margin-bottom: -1px;">Listar Clientes</button>
                            </div>
                            
                            <!-- Secci√≥n Crear Cliente -->
                            <div id="crearClienteSection">
                                <form id="clienteForm">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label" for="clienteNombre">Nombre y Apellido *</label>
                                            <input type="text" class="form-input" id="clienteNombre" name="nombre" placeholder="Ej: Juan P√©rez" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteDocumento">DNI</label>
                                            <input type="text" class="form-input" id="clienteDocumento" name="documento" placeholder="Ej: 12345678">
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label" for="clienteTelefono">Tel√©fono</label>
                                            <input type="text" class="form-input" id="clienteTelefono" name="telefono" placeholder="Ej: +54 11 1234-5678">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteTelefonoRespaldo">Tel√©fono de Respaldo</label>
                                            <input type="text" class="form-input" id="clienteTelefonoRespaldo" name="telefonoRespaldo" placeholder="Ej: +54 11 9876-5432">
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label" for="clienteEmail">Email</label>
                                            <input type="email" class="form-input" id="clienteEmail" name="email" placeholder="Ej: cliente@email.com">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteDireccion">Calle, N√∫mero y Timbre</label>
                                            <input type="text" class="form-input" id="clienteDireccion" name="direccion" placeholder="Ej: Av. Corrientes 1234, Timbre 5B">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="clienteRecomendado">Recomendado de</label>
                                        <input type="text" class="form-input" id="clienteRecomendado" name="recomendado" placeholder="Ej: Mar√≠a Gonz√°lez">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Tipo de Cliente *</label>
                                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                            <button type="button" class="btn-option active" id="tipoClienteDiario" data-tipo="diario" style="flex: 1; min-width: 120px;">Cliente Diario</button>
                                            <button type="button" class="btn-option" id="tipoClientePrestamista" data-tipo="prestamista" style="flex: 1; min-width: 120px;">Cliente Prestamista</button>
                                            <button type="button" class="btn-option" id="tipoClienteCuentaCorriente" data-tipo="cuenta_corriente" style="flex: 1; min-width: 120px;">Cliente Cuenta Corriente</button>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="clienteNotas">Notas / Observaciones</label>
                                        <textarea class="form-textarea" id="clienteNotas" name="notas" placeholder="Informaci√≥n adicional sobre el cliente" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn-cancel" id="limpiarClienteBtn">Limpiar</button>
                                        <button type="submit" class="btn-submit">Guardar Cliente</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Secci√≥n Listar Clientes -->
                            <div id="listarClientesSection" class="hidden">
                                <div id="clientesListContainer"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function initClientesModule() {
                // Inicializar tabs
                const tabCrear = document.getElementById('tabCrearCliente');
                const tabListar = document.getElementById('tabListarClientes');
                const sectionCrear = document.getElementById('crearClienteSection');
                const sectionListar = document.getElementById('listarClientesSection');
                
                tabCrear?.addEventListener('click', () => {
                    tabCrear.classList.add('active');
                    tabListar?.classList.remove('active');
                    sectionCrear?.classList.remove('hidden');
                    sectionListar?.classList.add('hidden');
                    tabCrear.style.borderBottomColor = 'var(--active-bg)';
                    tabListar.style.borderBottomColor = 'transparent';
                });
                
                tabListar?.addEventListener('click', () => {
                    tabListar.classList.add('active');
                    tabCrear?.classList.remove('active');
                    sectionListar?.classList.remove('hidden');
                    sectionCrear?.classList.add('hidden');
                    tabListar.style.borderBottomColor = 'var(--active-bg)';
                    tabCrear.style.borderBottomColor = 'transparent';
                    renderClientesList();
                });
                
                // Manejo de tipo de cliente
                let tipoClienteSeleccionado = 'diario';
                const tipoButtons = {
                    diario: document.getElementById('tipoClienteDiario'),
                    prestamista: document.getElementById('tipoClientePrestamista'),
                    cuenta_corriente: document.getElementById('tipoClienteCuentaCorriente')
                };
                
                Object.entries(tipoButtons).forEach(([tipo, button]) => {
                    button?.addEventListener('click', () => {
                        tipoClienteSeleccionado = tipo;
                        // Desactivar todos
                        Object.values(tipoButtons).forEach(btn => btn?.classList.remove('active'));
                        // Activar el seleccionado
                        button.classList.add('active');
                    });
                });
                
                // Formulario de crear cliente
                const clienteForm = document.getElementById('clienteForm');
                clienteForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const nombre = document.getElementById('clienteNombre')?.value.trim();
                    const documento = document.getElementById('clienteDocumento')?.value.trim();
                    const telefono = document.getElementById('clienteTelefono')?.value.trim();
                    const telefonoRespaldo = document.getElementById('clienteTelefonoRespaldo')?.value.trim();
                    const email = document.getElementById('clienteEmail')?.value.trim();
                    const direccion = document.getElementById('clienteDireccion')?.value.trim();
                    const recomendado = document.getElementById('clienteRecomendado')?.value.trim();
                    const notas = document.getElementById('clienteNotas')?.value.trim();
                    
                    if (!nombre) {
                        showToast('El nombre y apellido es obligatorio', 'error');
                        return;
                    }
                    
                    // Verificar si ya existe un cliente con el mismo nombre
                    const clientes = getClientes();
                    if (clientes.some(c => c.nombre.toLowerCase() === nombre.toLowerCase())) {
                        if (!confirm('Ya existe un cliente con ese nombre. ¬øDeseas agregarlo de todas formas?')) {
                            return;
                        }
                    }
                    
                    // Generar ID aleatorio √∫nico
                    const id = 'CLI_' + crypto.randomUUID();
                    
                    const nuevoCliente = {
                        id,
                        nombre,
                        documento: documento || '',
                        telefono: telefono || '',
                        telefonoRespaldo: telefonoRespaldo || '',
                        email: email || '',
                        direccion: direccion || '',
                        recomendado: recomendado || '',
                        tipo: tipoClienteSeleccionado,
                        notas: notas || '',
                        fechaCreacion: new Date().toISOString()
                    };
                    
                    addCliente(nuevoCliente);
                    showToast(`Cliente "${nombre}" creado exitosamente`, 'success');
                    clienteForm.reset();
                    // Resetear tipo de cliente
                    tipoClienteSeleccionado = 'diario';
                    Object.values(tipoButtons).forEach(btn => {
                        if (btn) btn.classList.remove('active');
                    });
                    if (tipoButtons.diario) tipoButtons.diario.classList.add('active');
                    
                    // Actualizar select de clientes en operaciones si existe
                    updateClientesSelect();
                });
                
                // Bot√≥n limpiar
                document.getElementById('limpiarClienteBtn')?.addEventListener('click', () => {
                    clienteForm?.reset();
                });
                
                // Renderizar lista inicial
                renderClientesList();
            }

            function updateClientesSelect() {
                const clienteSelect = document.getElementById('cliente');
                if (!clienteSelect) return;
                
                const clientes = getClientes();
                const currentValue = clienteSelect.value;
                
                clienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' + 
                    clientes.map(c => `<option value="${c.id}">${c.nombre}${c.documento ? ' - ' + c.documento : ''}</option>`).join('');
                
                // Restaurar valor seleccionado si existe
                if (currentValue) {
                    clienteSelect.value = currentValue;
                }
            }

            /**
             * =================================================================
             * M√ìDULO DE MOVIMIENTOS
             * =================================================================
             */
            function renderMovimientosModule() {
                return `
                    <div class="operations-container">
                        <div class="form-card">
                            <div class="form-header">
                                <h2 class="form-title">üìä Movimientos</h2>
                            </div>
                            <div id="movimientosListContainer"></div>
                        </div>
                    </div>
                `;
            }

            function initMovimientosModule() {
                renderMovimientosList();
            }

            function renderMovimientosList() {
                const container = document.getElementById('movimientosListContainer');
                if (!container) return;
                
                const movimientos = getMovimientos();
                
                if (movimientos.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay movimientos registrados.</p>';
                    return;
                }
                
                container.innerHTML = movimientos.map(mov => {
                    const fecha = new Date(mov.fechaCreacion);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const horaFormateada = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    const clienteNombre = getClienteNombre(mov.cliente);
                    const operacionLabel = mov.operacion ? mov.operacion.replace('_', ' ') : '';
                    const subOperacionLabel = mov.subOperacion || '';
                    
                    // Informaci√≥n relevante seg√∫n el tipo de operaci√≥n
                    let infoRelevante = '';
                    if (mov.monto && mov.moneda) {
                        const monedaLabel = monedas.find(m => m.value === mov.moneda)?.label || mov.moneda;
                        infoRelevante = `${monedaLabel} ${parseFloat(mov.monto).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                    if (mov.total) {
                        infoRelevante += infoRelevante ? ` | ${parseFloat(mov.total).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : `${parseFloat(mov.total).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                    
                    return `
                        <div class="movimiento-row" style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr auto; gap: 12px; padding: 12px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 8px; align-items: center; overflow: hidden; ${mov.anulado ? 'opacity: 0.6; border: 2px solid var(--error-color);' : 'border: 1px solid var(--border-color);'}" data-movimiento-id="${mov.id}">
                            ${mov.anulado ? '<div style="grid-column: 1 / -1; background: var(--error-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; display: inline-block; width: fit-content; margin-bottom: 4px;">ANULADO</div>' : ''}
                            <div style="cursor: pointer; min-width: 0; overflow: hidden; text-overflow: ellipsis;" class="movimiento-item">
                                <div style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${operacionLabel} ${subOperacionLabel ? '> ' + subOperacionLabel : ''}</div>
                                ${mov.detalle ? `<div style="font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${mov.detalle.substring(0, 50)}${mov.detalle.length > 50 ? '...' : ''}</div>` : ''}
                            </div>
                            <div style="font-size: 13px; color: var(--text-primary); min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${clienteNombre}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); min-width: 0; white-space: nowrap;">${fechaFormateada}<br>${horaFormateada}</div>
                            <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${infoRelevante || '-'}</div>
                            <div style="display: flex; gap: 6px; min-width: 0; flex-shrink: 0;">
                                ${!mov.anulado ? `<button type="button" class="btn-option" style="font-size: 11px; padding: 4px 8px; white-space: nowrap; flex-shrink: 0;" data-action="anular" data-mov-id="${mov.id}">Anular</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Event listeners
                container.addEventListener('click', (e) => {
                    const movimientoCard = e.target.closest('[data-movimiento-id]');
                    if (!movimientoCard) return;
                    
                    const movimientoId = movimientoCard.dataset.movimientoId;
                    const movimientos = getMovimientos();
                    const movimiento = movimientos.find(m => m.id === movimientoId);
                    
                    if (!movimiento) return;
                    
                    // Si click en el contenido (no en botones), mostrar detalles
                    if (e.target.classList.contains('movimiento-item') || e.target.closest('.movimiento-item')) {
                        mostrarDetallesMovimiento(movimiento);
                    }
                    
                    // Si click en anular
                    if (e.target.dataset.action === 'anular') {
                        if (confirm('¬øEst√°s seguro de anular este movimiento? Se marcar√° como anulado pero permanecer√° visible.')) {
                            anularMovimiento(movimientoId);
                            showToast('Movimiento anulado', 'success');
                            renderMovimientosList();
                        }
                    }
                });
            }

            function mostrarDetallesMovimiento(movimiento) {
                const clienteNombre = getClienteNombre(movimiento.cliente);
                const fechaCreacion = new Date(movimiento.fechaCreacion);
                const fechaFormateada = fechaCreacion.toLocaleDateString('es-ES', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
                const horaFormateada = fechaCreacion.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                let detallesHTML = `
                    <div class="form-card" style="max-width: 800px; margin: 0 auto;">
                        <div class="form-header">
                            <h2 class="form-title">Detalles del Movimiento</h2>
                            ${movimiento.anulado ? '<div style="background: var(--error-color); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-bottom: 16px;">‚ö†Ô∏è MOVIMIENTO ANULADO</div>' : ''}
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Fecha</label>
                                <input type="text" class="form-input" value="${fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1)} ${horaFormateada}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cliente</label>
                                <input type="text" class="form-input" value="${clienteNombre}" readonly>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Operaci√≥n</label>
                                <input type="text" class="form-input" value="${movimiento.operacion ? movimiento.operacion.replace('_', ' ') : ''}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo</label>
                                <input type="text" class="form-input" value="${movimiento.subOperacion || ''}" readonly>
                            </div>
                        </div>
                `;
                
                // Mostrar campos relevantes seg√∫n el tipo de operaci√≥n
                if (movimiento.monto) {
                    detallesHTML += `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Monto</label>
                                <input type="text" class="form-input" value="${movimiento.monto}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Moneda</label>
                                <input type="text" class="form-input" value="${monedas.find(m => m.value === movimiento.moneda)?.label || movimiento.moneda || ''}" readonly>
                            </div>
                        </div>
                    `;
                }
                
                if (movimiento.tc) {
                    detallesHTML += `
                        <div class="form-group">
                            <label class="form-label">Tipo de Cambio</label>
                            <input type="text" class="form-input" value="${movimiento.tc}" readonly>
                        </div>
                    `;
                }
                
                if (movimiento.total) {
                    detallesHTML += `
                        <div class="form-group">
                            <label class="form-label">Total</label>
                            <input type="text" class="form-input" value="${movimiento.total}" readonly>
                        </div>
                    `;
                }
                
                if (movimiento.detalle) {
                    detallesHTML += `
                        <div class="form-group">
                            <label class="form-label">Detalle</label>
                            <textarea class="form-textarea" readonly>${movimiento.detalle}</textarea>
                        </div>
                    `;
                }
                
                detallesHTML += `
                        <div class="form-actions">
                            ${!movimiento.anulado ? `<button type="button" class="btn-secondary" id="editarMovimientoBtn" data-mov-id="${movimiento.id}">Editar</button>` : ''}
                            ${!movimiento.anulado ? `<button type="button" class="btn-cancel" id="anularMovimientoBtn" data-mov-id="${movimiento.id}">Anular Movimiento</button>` : ''}
                            <button type="button" class="btn-submit" id="cerrarDetallesBtn">Cerrar</button>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('movimientosListContainer');
                if (container) {
                    container.innerHTML = detallesHTML;
                    
                    document.getElementById('cerrarDetallesBtn')?.addEventListener('click', () => {
                        renderMovimientosList();
                    });
                    
                    document.getElementById('editarMovimientoBtn')?.addEventListener('click', () => {
                        editarMovimiento(movimiento);
                    });
                    
                    document.getElementById('anularMovimientoBtn')?.addEventListener('click', () => {
                        if (confirm('¬øEst√°s seguro de anular este movimiento? Se marcar√° como anulado pero permanecer√° visible.')) {
                            anularMovimiento(movimiento.id);
                            showToast('Movimiento anulado', 'success');
                            renderMovimientosList();
                        }
                    });
                }
            }

            function editarMovimiento(movimiento) {
                // Guardar el ID del movimiento que se est√° editando
                editingMovimientoId = movimiento.id;
                
                // Cargar el movimiento en el formulario de operaciones
                formData = JSON.parse(JSON.stringify(movimiento));
                delete formData.id;
                delete formData.fechaCreacion;
                delete formData.anulado;
                delete formData.fechaAnulacion;
                delete formData.fechaModificacion;
                
                saveFormState();
                loadModule('operaciones');
                showToast('Movimiento cargado para editar. Modifica y guarda para actualizar.', 'info');
            }

            /**
             * =================================================================
             * M√ìDULO DE PENDIENTES
             * =================================================================
             */
            function renderPendientesModule() {
                return `
                    <div class="operations-container">
                        <div class="form-card">
                            <div class="form-header">
                                <h2 class="form-title">‚è≥ Pendientes</h2>
                            </div>
                            <div id="pendientesListContainer"></div>
                        </div>
                    </div>
                `;
            }

            function initPendientesModule() {
                renderPendientesList();
            }

            function renderPendientesList() {
                const container = document.getElementById('pendientesListContainer');
                if (!container) return;
                
                const movimientos = getMovimientos();
                
                // Filtrar solo pendientes (no anulados y estado pendiente)
                const pendientes = movimientos.filter(m => 
                    !m.anulado && 
                    (m.estado === 'pendiente_retiro' || m.estado === 'pendiente_entrega')
                );
                
                if (pendientes.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay operaciones pendientes.</p>';
                    return;
                }
                
                // Agrupar por cliente
                const pendientesPorCliente = {};
                pendientes.forEach(mov => {
                    const clienteId = mov.cliente || 'sin_cliente';
                    if (!pendientesPorCliente[clienteId]) {
                        const clienteCompleto = getClienteCompleto(clienteId);
                        pendientesPorCliente[clienteId] = {
                            clienteId: clienteId,
                            clienteNombre: getClienteNombre(clienteId),
                            clienteDireccion: clienteCompleto?.direccion || '',
                            clienteTelefono: clienteCompleto?.telefono || '',
                            clienteTelefonoRespaldo: clienteCompleto?.telefonoRespaldo || '',
                            movimientos: [],
                            totalRetiro: 0,
                            totalEntrega: 0,
                            monedasRetiro: {},
                            monedasEntrega: {}
                        };
                    }
                    
                    pendientesPorCliente[clienteId].movimientos.push(mov);
                    
                    // Calcular totales por tipo
                    const monto = safeParseFloat(mov.monto || mov.total || 0);
                    const moneda = mov.moneda || mov.monedaTC || 'ARS';
                    
                    if (mov.estado === 'pendiente_retiro') {
                        pendientesPorCliente[clienteId].totalRetiro += monto;
                        if (!pendientesPorCliente[clienteId].monedasRetiro[moneda]) {
                            pendientesPorCliente[clienteId].monedasRetiro[moneda] = 0;
                        }
                        pendientesPorCliente[clienteId].monedasRetiro[moneda] += monto;
                    } else if (mov.estado === 'pendiente_entrega') {
                        pendientesPorCliente[clienteId].totalEntrega += monto;
                        if (!pendientesPorCliente[clienteId].monedasEntrega[moneda]) {
                            pendientesPorCliente[clienteId].monedasEntrega[moneda] = 0;
                        }
                        pendientesPorCliente[clienteId].monedasEntrega[moneda] += monto;
                    }
                });
                
                // Renderizar por cliente
                container.innerHTML = Object.values(pendientesPorCliente).map(grupo => {
                    const fechaCreacion = new Date(grupo.movimientos[0].fechaCreacion);
                    const fechaFormateada = fechaCreacion.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    
                    let resumenHTML = '';
                    if (grupo.totalRetiro > 0) {
                        const monedasRetiroStr = Object.entries(grupo.monedasRetiro)
                            .map(([moneda, total]) => {
                                const monedaLabel = monedas.find(m => m.value === moneda)?.label || moneda;
                                return `${monedaLabel} ${total.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                            })
                            .join(', ');
                        resumenHTML += `<p style="color: var(--error-color); font-size: 14px; font-weight: 600; margin: 8px 0 4px 0;">üî¥ RETIRAR: ${monedasRetiroStr}</p>`;
                    }
                    if (grupo.totalEntrega > 0) {
                        const monedasEntregaStr = Object.entries(grupo.monedasEntrega)
                            .map(([moneda, total]) => {
                                const monedaLabel = monedas.find(m => m.value === moneda)?.label || moneda;
                                return `${monedaLabel} ${total.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                            })
                            .join(', ');
                        resumenHTML += `<p style="color: var(--success-color); font-size: 14px; font-weight: 600; margin: 4px 0 8px 0;">üü¢ ENTREGAR: ${monedasEntregaStr}</p>`;
                    }
                    
                    // Informaci√≥n de contacto y direcci√≥n
                    let contactoHTML = '';
                    if (grupo.clienteTelefono) {
                        contactoHTML += `<p style="color: var(--text-primary); font-size: 14px; margin: 8px 0 4px 0;"><strong>üìû Contacto:</strong> ${grupo.clienteTelefono}`;
                        if (grupo.clienteTelefonoRespaldo) {
                            contactoHTML += ` / ${grupo.clienteTelefonoRespaldo}`;
                        }
                        contactoHTML += `</p>`;
                    }
                    
                    let direccionHTML = '';
                    if (grupo.clienteDireccion) {
                        direccionHTML = `<p style="color: var(--text-primary); font-size: 14px; margin: 4px 0 8px 0;"><strong>üìç D√≥nde ${grupo.totalRetiro > 0 && grupo.totalEntrega > 0 ? 'retirar/entregar' : grupo.totalRetiro > 0 ? 'retirar' : 'entregar'}:</strong> ${grupo.clienteDireccion}</p>`;
                    }
                    
                    return `
                        <div class="pendiente-cliente-card" style="padding: 16px; margin-bottom: 16px; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); align-items: center; overflow: hidden;">
                                <div style="min-width: 0; overflow: hidden;">
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${grupo.clienteNombre}</h3>
                                    <p style="color: var(--text-secondary); font-size: 12px; margin: 2px 0;">${grupo.movimientos.length} operaci√≥n${grupo.movimientos.length > 1 ? 'es' : ''}</p>
                                </div>
                                <div style="font-size: 12px; min-width: 0; overflow: hidden;">
                                    ${grupo.clienteTelefono ? `<div style="color: var(--text-primary); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìû ${grupo.clienteTelefono}</div>` : ''}
                                    ${grupo.clienteTelefonoRespaldo ? `<div style="color: var(--text-secondary); font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${grupo.clienteTelefonoRespaldo}</div>` : ''}
                                </div>
                                <div style="font-size: 12px; color: var(--text-primary); min-width: 0; overflow: hidden;">
                                    ${grupo.clienteDireccion ? `<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìç ${grupo.clienteDireccion}</div>` : ''}
                                </div>
                                <div style="text-align: right; min-width: 0; overflow: hidden; flex-shrink: 0;">
                                    ${grupo.totalRetiro > 0 ? `<div style="color: var(--error-color); font-size: 13px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üî¥ ${Object.entries(grupo.monedasRetiro).map(([m, t]) => `${monedas.find(mon => mon.value === m)?.label || m} ${t.toFixed(2)}`).join(', ')}</div>` : ''}
                                    ${grupo.totalEntrega > 0 ? `<div style="color: var(--success-color); font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üü¢ ${Object.entries(grupo.monedasEntrega).map(([m, t]) => `${monedas.find(mon => mon.value === m)?.label || m} ${t.toFixed(2)}`).join(', ')}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="pendientes-operaciones-list">
                                ${grupo.movimientos.map(mov => {
                                    const fechaMov = new Date(mov.fechaCreacion);
                                    const fechaMovFormateada = fechaMov.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                                    const horaMov = fechaMov.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                                    const operacionLabel = mov.operacion ? mov.operacion.replace('_', ' ') : '';
                                    const subOperacionLabel = mov.subOperacion || '';
                                    const montoMov = safeParseFloat(mov.monto || mov.total || 0);
                                    const monedaMov = mov.moneda || mov.monedaTC || 'PESO';
                                    const monedaLabel = monedas.find(m => m.value === monedaMov)?.label || monedaMov;
                                    const tipoPendiente = mov.estado === 'pendiente_retiro' ? 'RETIRO' : 'ENTREGA';
                                    const colorTipo = mov.estado === 'pendiente_retiro' ? 'var(--error-color)' : 'var(--success-color)';
                                    
                                    // Obtener informaci√≥n de wallet
                                    let walletNombre = '';
                                    if (mov.estado === 'pendiente_retiro') {
                                        const walletRetiro = mov.walletCompra || mov.walletTC || mov.walletBase || '';
                                        if (walletRetiro && walletRetiro !== 'pago_mixto') {
                                            walletNombre = getWalletNombre(walletRetiro) || '';
                                        }
                                    } else if (mov.estado === 'pendiente_entrega') {
                                        const walletEntrega = mov.walletCompra || mov.walletTC || mov.walletProfit || '';
                                        if (walletEntrega && walletEntrega !== 'pago_mixto') {
                                            walletNombre = getWalletNombre(walletEntrega) || '';
                                        }
                                    }
                                    
                                    return `
                                        <div class="pendiente-operacion-row" style="display: grid; grid-template-columns: auto 2fr 1fr 1fr auto; gap: 12px; padding: 10px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 8px; align-items: center; border-left: 3px solid ${colorTipo}; overflow: hidden;">
                                            <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: ${colorTipo === 'var(--error-color)' ? 'var(--error-surface)' : 'var(--success-surface)'}; color: ${colorTipo}; font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                                                ${tipoPendiente}
                                            </span>
                                            <div style="min-width: 0; overflow: hidden;">
                                                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${operacionLabel} ${subOperacionLabel ? '> ' + subOperacionLabel : ''}</div>
                                                ${walletNombre ? `<div style="font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üí≥ ${walletNombre}</div>` : ''}
                                                ${mov.detalle ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${mov.detalle.substring(0, 40)}${mov.detalle.length > 40 ? '...' : ''}</div>` : ''}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary); min-width: 0; white-space: nowrap;">${fechaMovFormateada}<br>${horaMov}</div>
                                            <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${monedaLabel} ${montoMov.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                            <button type="button" class="btn-submit" style="font-size: 11px; padding: 6px 12px; white-space: nowrap; flex-shrink: 0;" data-mov-id="${mov.id}" data-action="finalizar">
                                                Finalizar
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Event listeners para finalizar
                container.addEventListener('click', (e) => {
                    if (e.target.dataset.action === 'finalizar') {
                        const movimientoId = e.target.dataset.movId;
                        if (confirm('¬øMarcar esta operaci√≥n como finalizada? Desaparecer√° de la lista de pendientes.')) {
                            updateMovimiento(movimientoId, { estado: 'realizado' });
                            showToast('Operaci√≥n marcada como finalizada', 'success');
                            renderPendientesList();
                        }
                    }
                });
            }

            function renderClientesList() {
                const container = document.getElementById('clientesListContainer');
                if (!container) return;
                
                const clientes = getClientes();
                
                if (clientes.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay clientes registrados.</p>';
                    return;
                }
                
                container.innerHTML = clientes.map(cliente => {
                    const diasTranscurridos = calcularDiasDesdeUltimaOperacion(cliente.ultimaOperacion);
                    const fechaFormateada = formatearFechaUltimaOperacion(cliente.ultimaOperacion);
                    const colorDias = diasTranscurridos === null ? 'var(--text-secondary)' : 
                                     diasTranscurridos === 0 ? 'var(--success-color)' : 
                                     diasTranscurridos <= 7 ? 'var(--text-primary)' : 
                                     diasTranscurridos <= 30 ? 'var(--warning)' : 'var(--error-color)';
                    
                    return `
                    <div class="form-card" style="padding: 20px; margin-bottom: 16px; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; overflow: hidden;">
                            <div style="flex: 1; min-width: 0; overflow: hidden;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap;">
                                    <h3 style="font-size: 18px; font-weight: 600; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${cliente.nombre}</h3>
                                    <span style="font-size: 11px; padding: 2px 8px; border-radius: 12px; background: ${cliente.tipo === 'prestamista' ? 'var(--accent-surface)' : cliente.tipo === 'cuenta_corriente' ? 'var(--success-surface)' : 'var(--bg-surface-variant)'}; color: ${cliente.tipo === 'prestamista' ? 'var(--accent-primary)' : cliente.tipo === 'cuenta_corriente' ? 'var(--success-color)' : 'var(--text-secondary)'};">
                                        ${cliente.tipo === 'prestamista' ? 'Prestamista' : cliente.tipo === 'cuenta_corriente' ? 'Cuenta Corriente' : 'Diario'}
                                    </span>
                                </div>
                                ${cliente.documento ? `<p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">üÜî DNI: ${cliente.documento}</p>` : ''}
                                ${cliente.telefono ? `<p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">üìû ${cliente.telefono}</p>` : ''}
                                ${cliente.telefonoRespaldo ? `<p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">üì± Respaldo: ${cliente.telefonoRespaldo}</p>` : ''}
                                ${cliente.email ? `<p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">‚úâÔ∏è ${cliente.email}</p>` : ''}
                                ${cliente.direccion ? `<p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">üìç ${cliente.direccion}</p>` : ''}
                                ${cliente.recomendado ? `<p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">üë§ Recomendado de: ${cliente.recomendado}</p>` : ''}
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">
                                        <strong style="color: var(--text-primary);">√öltima operaci√≥n:</strong> 
                                        <span style="color: ${colorDias}; font-weight: 600;">${fechaFormateada}</span>
                                    </p>
                                    ${diasTranscurridos !== null ? `
                                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                            <strong style="color: var(--text-primary);">D√≠as transcurridos:</strong> 
                                            <span style="color: ${colorDias}; font-weight: 600;">
                                                ${diasTranscurridos === 0 ? 'Hoy' : diasTranscurridos === 1 ? '1 d√≠a' : `${diasTranscurridos} d√≠as`}
                                            </span>
                                        </p>
                                    ` : '<p style="color: var(--text-secondary); font-size: 13px; margin: 0;">Sin operaciones registradas</p>'}
                                </div>
                                ${cliente.notas ? `<p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">${cliente.notas}</p>` : ''}
                            </div>
                            <button type="button" class="btn-remove" data-cliente-id="${cliente.id}" style="margin-left: 16px; flex-shrink: 0;">‚úï</button>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            ID: ${cliente.id}
                        </div>
                    </div>
                    `;
                }).join('');
                
                // Event listener para eliminar
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-remove') || e.target.closest('.btn-remove')) {
                        const btn = e.target.classList.contains('btn-remove') ? e.target : e.target.closest('.btn-remove');
                        const clienteId = btn.dataset.clienteId;
                        const cliente = clientes.find(c => c.id === clienteId);
                        if (cliente && confirm(`¬øEliminar el cliente "${cliente.nombre}"?`)) {
                            deleteCliente(clienteId);
                            showToast('Cliente eliminado', 'success');
                            renderClientesList();
                        }
                    }
                });
            }

            setupMenu();
            updateDateDisplay();
            setupTheme();
            loadModule(localStorage.getItem('activeModule') || 'operaciones');
        });
    </script>
</body>
</html>

