<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>Sistema Financiero - Gesti√≥n Profesional</title>
    <style>
        :root {
            /* Tema OSCURO por defecto (seg√∫n memoria del usuario) */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --button-bg: #77abff;
            --button-text: #f1f5f9;
            --active-bg: #4c85ff;
            --active-text: #ffffff;
            --error-color: #ff453a;
            --success-color: #30d158;
        }
        .light-theme {
            /* Tema CLARO */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e5e5e5;
            --button-bg: #9dc2fe;
            --button-text: #1a1a1a;
            --active-bg: #4c85ff;
            --active-text: #ffffff;
            --error-color: #ff3b30;
            --success-color: #34c759;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-top: 60px;
            padding-bottom: 50px;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        @media (max-width: 480px) {
            body {
                padding-top: 56px;
                padding-bottom: 45px;
            }
        }
        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        @media (max-width: 480px) {
            header {
                padding: 0 12px;
                height: 56px;
            }
        }
        .menu-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }
        .menu-btn:hover {
            color: var(--button-bg);
        }
        .date-display {
            font-size: 14px;
            font-weight: 500;
        }
        @media (max-width: 480px) {
            .date-display {
                font-size: 12px;
            }
        }
        .user-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        @media (max-width: 480px) {
            .user-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        .user-btn:hover {
            border-color: var(--button-bg);
            color: var(--button-bg);
        }
        /* Footer */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 6px 20px;
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 480px) {
            footer {
                padding: 6px 12px;
            }
        }
        .cotizaciones {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: wrap;
        }
        @media (max-width: 480px) {
            .cotizaciones {
                gap: 8px;
            }
        }
        .cotizacion-item {
            text-align: center;
        }
        .cotizacion-label {
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        @media (max-width: 480px) {
            .cotizacion-label {
                font-size: 8px;
            }
        }
        .cotizacion-valores {
            display: flex;
            gap: 8px;
            font-size: 11px;
        }
        @media (max-width: 480px) {
            .cotizacion-valores {
                gap: 5px;
                font-size: 10px;
            }
        }
        .compra, .venta {
            display: flex;
            flex-direction: column;
        }
        .compra span:first-child, .venta span:first-child {
            font-size: 9px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        .compra span:last-child {
            color: var(--success-color);
        }
        .venta span:last-child {
            color: var(--error-color);
        }
        /* Content */
        main {
            padding: 20px;
            min-height: calc(100vh - 120px);
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
        }
        @media (max-width: 600px) {
            main {
                padding: 15px;
            }
        }
        @media (max-width: 480px) {
            main {
                padding: 12px;
            }
        }
        @media (max-width: 400px) {
            main {
                padding: 10px;
            }
        }
        /* Sidebar Menu */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background-color: var(--bg-secondary);
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
            /* CORRECCI√ìN: Usar transform en lugar de left fijo para mejor rendimiento y evitar n√∫meros m√°gicos */
            transform: translateX(-100%);
            transition: transform 0.3s ease, background-color 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }
        @media (max-width: 480px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
            }
        }
        .dark-theme .sidebar {
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.3);
        }
        .sidebar.open {
            /* CORRECCI√ìN: Usar transform en lugar de left para mejor rendimiento */
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s ease;
        }
        .close-btn:hover {
            color: var(--button-bg);
        }
        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .menu-item {
            border-bottom: 1px solid var(--border-color);
        }
        .menu-link {
            display: block;
            padding: 16px 20px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        .menu-link:hover {
            background-color: var(--bg-primary);
            color: var(--button-bg);
            padding-left: 28px;
        }
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1500;
        }
        .overlay.active {
            display: block;
        }
        /* Operations Form */
        .operations-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 15px;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 750px) {
            .operations-container {
                max-width: 100%;
                padding: 0 10px;
            }
        }
        @media (max-width: 480px) {
            .operations-container {
                padding: 0 8px;
            }
        }
        @media (max-width: 400px) {
            .operations-container {
                padding: 0 6px;
            }
        }
        .form-card {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
            width: 100%;
            box-sizing: border-box;
        }
        .dark-theme .form-card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 600px) {
            .form-card {
                padding: 16px;
                margin-bottom: 16px;
                border-radius: 12px;
            }
        }
        @media (max-width: 480px) {
            .form-card {
                padding: 14px;
                margin-bottom: 14px;
                border-radius: 10px;
            }
        }
        @media (max-width: 400px) {
            .form-card {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 8px;
            }
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
            flex-wrap: wrap;
        }
        @media (max-width: 600px) {
            .form-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .form-header .btn-back {
                align-self: flex-start;
            }
            .form-header .form-title {
                text-align: center;
                width: 100%;
            }
        }
        @media (max-width: 480px) {
            .form-header {
                margin-bottom: 20px;
                padding-bottom: 12px;
            }
        }
        .btn-back {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-back:hover {
            background: var(--active-bg);
            transform: scale(1.02);
        }
        @media (max-width: 480px) {
            .btn-back {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        .form-title {
            font-size: 20px;
            font-weight: 600;
        }
        @media (max-width: 480px) {
            .form-title {
                font-size: 18px;
            }
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .form-grid > * {
            min-width: 0;
        }
        @media (min-width: 1200px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1600px) {
            .form-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        /* Mobile: mantener 2 columnas cuando sea posible para reducir scroll */
        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }
        /* Solo en pantallas muy peque√±as usar 1 columna */
        @media (max-width: 360px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dynamic-fields-container > .form-group {
            margin-bottom: 20px;
        }
        .dynamic-fields-container > .form-group:last-child {
            margin-bottom: 0;
        }
        .dynamic-fields-container > div[style*="display: grid"] {
            margin-bottom: 20px;
        }
        .dynamic-fields-container > div[style*="display: grid"]:last-child {
            margin-bottom: 0;
        }
        .form-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-input, .form-select, .form-textarea {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 12px;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }
        @media (max-width: 480px) {
            .form-input, .form-select, .form-textarea {
                padding: 8px 10px;
                font-size: 16px;
            }
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--button-bg);
            background-color: var(--bg-secondary);
        }
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-input:read-only {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }
        /* Button Grid for Operations */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            max-width: 100%;
            gap: 10px;
            margin-bottom: 24px;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        .button-grid > * {
            min-width: 0;
        }
        @media (max-width: 600px) {
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }
        @media (max-width: 480px) {
            .button-grid {
                gap: 6px;
            }
        }
        @media (max-width: 400px) {
            .button-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }
        /* Tabs container para clientes */
        .tabs-container {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            box-sizing: border-box;
        }
        .tabs-container::-webkit-scrollbar {
            display: none;
        }
        .tabs-container .btn-option {
            flex: 1;
            min-width: 120px;
        }
        @media (max-width: 600px) {
            .tabs-container {
                margin-bottom: 16px;
            }
            .tabs-container .btn-option {
                min-width: 100px;
            }
        }
        @media (max-width: 480px) {
            .tabs-container {
                margin-bottom: 12px;
            }
            .tabs-container .btn-option {
                min-width: 90px;
                padding: 8px 10px;
            }
        }
        /* Cliente card/list item */
        .cliente-card, .cliente-row {
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        /* Wallet card/list item */
        .wallet-card, .wallet-row {
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        /* Saldos card */
        .saldos-card {
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* Estilos para pantalla de inicio - Responsive */
        .home-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .home-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        
        .home-calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 8px;
        }
        
        .home-calendar-empty {
            /* Espacio vac√≠o - no necesita estilos */
            display: none;
        }
        
        .home-calendar-day {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 14px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-calendar-today {
            background: var(--button-bg);
            color: white;
            font-weight: 600;
        }
        
        .home-calendar-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .home-calendar-month {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .home-calendar-time {
            font-size: 32px;
            font-weight: 600;
            color: var(--button-bg);
            margin: 10px 0;
        }
        
        .home-calendar-date {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Block de notas siempre ocupa todo el ancho */
        .home-notes-card {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .home-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .home-notes-card {
                grid-column: 1;
            }
            
            .home-calendar-grid {
                gap: 3px;
            }
            
            .home-calendar-day-header {
                font-size: 11px;
                padding: 6px 4px;
            }
            
            .home-calendar-day {
                padding: 6px 4px;
                font-size: 12px;
                min-height: 28px;
            }
            
            .home-calendar-month {
                font-size: 18px;
            }
            
            .home-calendar-time {
                font-size: 28px;
            }
            
            .home-calendar-date {
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .home-grid {
                gap: 12px;
            }
            
            .home-calendar-grid {
                gap: 2px;
            }
            
            .home-calendar-day-header {
                font-size: 10px;
                padding: 5px 2px;
            }
            
            .home-calendar-day {
                padding: 5px 2px;
                font-size: 11px;
                min-height: 24px;
            }
            
            .home-calendar-month {
                font-size: 16px;
            }
            
            .home-calendar-time {
                font-size: 24px;
            }
            
            .home-calendar-date {
                font-size: 12px;
            }
        }
        
        .btn-option {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-option:hover {
            transform: scale(1.02);
        }
        @media (max-width: 600px) {
            .btn-option {
                padding: 4px 8px;
                font-size: 11px;
                min-height: 28px;
            }
        }
        @media (max-width: 400px) {
            .btn-option {
                padding: 3px 6px;
                font-size: 10px;
                min-height: 26px;
            }
        }
        .btn-option.btn-moneda {
            padding: 6px 10px;
            font-size: 12px;
        }
        .btn-option:hover:not(.active) {
            border-color: var(--button-bg);
            background-color: var(--bg-secondary);
            transform: scale(1.02);
        }
        .btn-option.active {
            background-color: var(--active-bg);
            border-color: var(--active-bg);
            color: var(--active-text);
            font-weight: 600;
        }
        /* Theme Switch */
        .theme-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .theme-switch-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
        }
        .theme-switch-label span {
            font-size: 20px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: var(--bg-primary);
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        input:checked + .slider {
            background-color: var(--button-bg);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider:hover {
            opacity: 0.9;
        }
        .calc-btn {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .calc-btn:hover {
            background-color: var(--bg-primary);
            transform: scale(1.05);
        }
        .calc-btn:active {
            transform: scale(0.95);
        }
        @media (max-width: 480px) {
            .calc-btn {
                padding: 12px;
                font-size: 16px;
            }
        }
        .btn-submit {
            background-color: var(--button-bg);
            color: var(--text-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        @media (max-width: 480px) {
            .btn-submit {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        .btn-submit:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .btn-submit:disabled {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-cancel {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        @media (max-width: 480px) {
            .btn-cancel {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        .btn-cancel:hover {
            border-color: var(--error-color);
            color: var(--error-color);
            transform: scale(1.02);
        }
        .form-actions .btn-remove {
            background-color: var(--error-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            width: auto;
            height: auto;
        }
        @media (max-width: 480px) {
            .form-actions .btn-remove {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        .form-actions .btn-remove:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        @media (max-width: 480px) {
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            .form-actions button {
                width: 100%;
            }
        }
        /* Section Title */
        .section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        /* Hidden class */
        .hidden {
            display: none !important;
        }
        /* Input with button */
        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: stretch;
            width: 100%;
            box-sizing: border-box;
        }
        .input-with-button .form-input {
            flex: 1;
            min-width: 0;
        }
        @media (max-width: 480px) {
            .input-with-button {
                gap: 8px;
            }
        }
        .btn-add {
            background-color: var(--button-bg);
            color: var(--text-primary);
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
        }
        @media (max-width: 480px) {
            .btn-add {
                min-width: 40px;
                padding: 8px 12px;
                font-size: 16px;
            }
        }
        .btn-add:hover {
            opacity: 0.9;
        }
        /* Read-only inputs */
        .form-input-readonly {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        /* Wallet buttons container */
        .wallet-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
            max-width: 100%;
            overflow: hidden;
        }
        @media (max-width: 600px) {
            .wallet-buttons-container {
                gap: 6px;
            }
        }
        .moneda-buttons-container {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 4px;
            max-width: 100%;
            overflow: hidden;
        }
        @media (max-width: 500px) {
            .moneda-buttons-container {
                gap: 4px;
            }
        }
        .wallet-step {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            overflow: hidden;
        }
        .wallet-step-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .btn-wallet {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex: 1;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 600px) {
            .btn-wallet {
                padding: 4px 8px;
                font-size: 11px;
                min-height: 28px;
            }
        }
        @media (max-width: 400px) {
            .btn-wallet {
                padding: 3px 6px;
                font-size: 10px;
                min-height: 26px;
            }
        }
        .btn-wallet:hover:not(:disabled) {
            border-color: var(--button-bg);
            background-color: var(--bg-primary);
        }
        .btn-wallet.active {
            background-color: var(--active-bg) !important;
            border-color: var(--active-bg) !important;
            color: var(--active-text) !important;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(76, 133, 255, 0.4);
            opacity: 1 !important;
        }
        .btn-wallet:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .btn-wallet.active:disabled {
            opacity: 0.85 !important;
            background-color: var(--active-bg) !important;
            border-color: var(--active-bg) !important;
            color: var(--active-text) !important;
            box-shadow: 0 2px 6px rgba(76, 133, 255, 0.4);
        }
        /* Mixed payments section */
        .mixed-payments-section {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            overflow: hidden;
        }
        @media (max-width: 600px) {
            .mixed-payments-section {
                padding: 16px;
            }
        }
        @media (max-width: 400px) {
            .mixed-payments-section {
                padding: 12px;
            }
        }
        .mixed-payment-item {
            display: grid;
            grid-template-columns: 1fr 1fr minmax(42px, auto);
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        .mixed-payment-item > * {
            min-width: 0;
        }
        .mixed-payment-item:last-child {
            margin-bottom: 0;
        }
        .mixed-payment-item .btn-remove {
            align-self: end;
            flex-shrink: 0;
            min-width: 42px;
            width: 42px;
        }
        /* Responsive para pantallas peque√±as - X siempre visible */
        @media (max-width: 600px) {
            .mixed-payment-item {
                grid-template-columns: 1fr minmax(42px, auto);
                gap: 12px;
            }
            /* Wallet ocupa toda la primera fila */
            .mixed-payment-item .form-group:first-child {
                grid-column: 1 / -1;
            }
            /* Monto y X en la segunda fila */
            .mixed-payment-item .form-group:nth-child(2) {
                grid-column: 1;
            }
            .mixed-payment-item .btn-remove {
                grid-column: 2;
                min-width: 42px;
                width: 42px;
                height: 42px;
                align-self: end;
            }
        }
        @media (max-width: 400px) {
            .mixed-payment-item {
                gap: 10px;
            }
            .mixed-payment-item .btn-remove {
                min-width: 38px;
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
        }
        #mixedPaymentsList {
            width: 100%;
            box-sizing: border-box;
        }
        .btn-remove {
            background-color: var(--error-color);
            color: white;
            border: none;
            padding: 0;
            width: 42px;
            height: 42px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 400px) {
            .btn-remove {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
        }
        .btn-remove:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }
        .btn-edit {
            background-color: var(--button-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-edit:hover {
            background-color: var(--active-bg);
            transform: scale(1.05);
        }
        .btn-add-payment {
            background-color: var(--button-bg);
            color: var(--text-primary);
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
            transition: all 0.2s;
            width: 100%;
        }
        @media (max-width: 480px) {
            .btn-add-payment {
                padding: 8px 14px;
                font-size: 13px;
            }
        }
        .btn-add-payment:hover {
            opacity: 0.8;
        }
        .mixed-payment-total {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .total-match {
            color: var(--success-color);
        }
        .total-mismatch {
            color: var(--error-color);
        }
        /* Dynamic fields container */
        .dynamic-fields-container {
            margin: 24px 0;
        }
        /* Separator */
        .field-separator {
            height: 1px;
            background-color: var(--border-color);
            margin: 24px 0;
        }
        /* Fecha y D√≠a juntos */
        .fecha-dia-group {
            display: flex;
            gap: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 600px) {
            .fecha-dia-group {
                flex-direction: row;
                gap: 10px;
            }
            .form-group[style*="grid-column: 1 / -1"] > div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }
        @media (max-width: 480px) {
            .fecha-dia-group {
                gap: 8px;
            }
            .form-group[style*="grid-column: 1 / -1"] > div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 6px;
            }
        }
        @media (max-width: 360px) {
            .fecha-dia-group {
                flex-direction: column;
                gap: 12px;
            }
            .form-group[style*="grid-column: 1 / -1"] > div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
            }
        }
        .fecha-dia-group .form-group {
            flex: 1;
            min-width: 0;
        }
        .fecha-dia-group > input {
            flex: 1;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .fecha-dia-group > input[type="date"] {
            flex: 1.2;
            min-width: 0;
            font-size: 16px;
            font-weight: 500;
            max-width: 100%;
        }
        .fecha-dia-group > input[type="text"][name="nombreDia"] {
            flex: 1;
            min-width: 0;
            font-size: 16px;
            font-weight: 500;
            max-width: 100%;
            text-align: center;
        }
        @media (max-width: 600px) {
            .fecha-dia-group > input[type="date"] {
                font-size: 15px;
                min-width: 0;
            }
            .fecha-dia-group > input[type="text"][name="nombreDia"] {
                font-size: 15px;
                min-width: 0;
            }
        }
        @media (max-width: 480px) {
            .fecha-dia-group > input[type="date"] {
                font-size: 14px;
                padding: 8px 8px;
            }
            .fecha-dia-group > input[type="text"][name="nombreDia"] {
                font-size: 14px;
                padding: 8px 8px;
            }
        }
        @media (max-width: 360px) {
            .fecha-dia-group > input[type="date"],
            .fecha-dia-group > input[type="text"][name="nombreDia"] {
                min-width: 100%;
                font-size: 16px;
            }
        }
        /* Movimientos en formato lista */
        .movimiento-row {
            display: grid;
            grid-template-columns: 2.5fr 1.5fr 1fr 1.2fr 1.2fr 1fr 1fr auto;
            gap: 16px;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            align-items: start;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        .movimiento-row:hover {
            background: var(--bg-primary);
        }
        @media (max-width: 1400px) {
            .movimiento-row {
                grid-template-columns: 2fr 1.5fr 1fr 1.2fr 1.2fr 1fr auto;
                gap: 12px;
            }
        }
        @media (max-width: 1200px) {
            .movimiento-row {
                grid-template-columns: 2fr 1.5fr 1fr 1.2fr 1.2fr auto;
                gap: 12px;
            }
        }
        @media (max-width: 900px) {
            .movimiento-row {
                grid-template-columns: 2fr 1.5fr 1fr 1.2fr auto;
                gap: 10px;
            }
        }
        @media (max-width: 700px) {
            .movimiento-row {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            .movimiento-row > div {
                padding: 4px 0;
                width: 100%;
            }
            .movimiento-row > button {
                width: 100%;
                justify-self: stretch;
            }
        }
        @media (max-width: 480px) {
            .movimiento-row {
                padding: 10px;
                gap: 6px;
                border-radius: 6px;
            }
        }

        /* Pendientes en formato lista */
        .pendiente-cliente-card {
            padding: 16px;
            margin-bottom: 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        .pendiente-cliente-card > div:first-child {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }
        .pendiente-operacion-row {
            display: grid;
            grid-template-columns: auto 2fr 1fr 1fr auto auto;
            gap: 12px;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        @media (max-width: 900px) {
            .pendiente-cliente-card > div:first-child {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .pendiente-operacion-row {
                grid-template-columns: auto 2fr 1fr auto;
                gap: 10px;
            }
        }
        @media (max-width: 600px) {
            .pendiente-cliente-card > div:first-child {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            .pendiente-operacion-row {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            .pendiente-operacion-row > * {
                padding: 4px 0;
                width: 100%;
            }
            .pendiente-operacion-row > button {
                width: 100%;
                justify-self: stretch;
            }
        }
        @media (max-width: 480px) {
            .pendiente-cliente-card {
                padding: 12px;
                border-radius: 10px;
            }
            .pendiente-operacion-row {
                padding: 8px;
                gap: 6px;
                border-radius: 6px;
            }
        }

        /* Toast System */
        #toastContainer {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            max-width: 90%;
            width: 300px;
        }
        @media (max-width: 480px) {
            #toastContainer {
                width: calc(100% - 40px);
                bottom: 70px;
            }
        }
        .toast {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(20px);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        @media (max-width: 480px) {
            .toast {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            border-left: 4px solid var(--success-color);
        }
        .toast.error {
            border-left: 4px solid var(--error-color);
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Men√∫</div>
            <button class="close-btn" id="closeBtn">‚úï</button>
        </div>
        <ul class="menu-list">
            <li class="menu-item">
                <a href="#inicio" class="menu-link">üè† Inicio</a>
            </li>
            <li class="menu-item">
                <a href="#pendientes" class="menu-link">Pendientes</a>
            </li>
            <li class="menu-item">
                <a href="#operaciones" class="menu-link">Operaciones</a>
            </li>
            <li class="menu-item">
                <a href="#clientes" class="menu-link">Clientes</a>
            </li>
            <li class="menu-item">
                <a href="#movimientos" class="menu-link">Movimientos</a>
            </li>
            <li class="menu-item">
                <a href="#saldos" class="menu-link">Saldos</a>
            </li>
            <li class="menu-item">
                <a href="#comisiones" class="menu-link">Comisiones</a>
            </li>
            <li class="menu-item">
                <a href="#cuentas-corrientes" class="menu-link">Cuentas Corrientes</a>
            </li>
            <li class="menu-item">
                <a href="#configuracion" class="menu-link">Configuraci√≥n</a>
            </li>
        </ul>
    </nav>
    <header>
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <div class="date-display" id="dateDisplay"></div>
        <button class="user-btn">üë§ Usuario</button>
    </header>
    <main id="mainContent">
    </main>
    <footer>
        <div class="cotizaciones">
            <div class="cotizacion-item">
                <div class="cotizacion-label">USD</div>
                <div class="cotizacion-valores">
                    <div class="compra">
                        <span>Compra</span>
                        <span>1,050</span>
                    </div>
                    <div class="venta">
                        <span>Venta</span>
                        <span>1,080</span>
                    </div>
                </div>
            </div>
            <div class="cotizacion-item">
                <div class="cotizacion-label">USDT</div>
                <div class="cotizacion-valores">
                    <div class="compra">
                        <span>Compra</span>
                        <span>1,045</span>
                    </div>
                    <div class="venta">
                        <span>Venta</span>
                        <span>1,075</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <div id="toastContainer"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            /**
             * =================================================================
             * VARIABLES GLOBALES (declaradas primero para evitar errores de referencia)
             * =================================================================
             */
            let formData = {};
            let editingMovimientoId = null; // ID del movimiento que se est√° editando
            let lastEditedField = null; // Campo editado m√°s recientemente para arbitraje bidireccional
            let navigationHistory = []; // Historial de navegaci√≥n para el bot√≥n Volver
            
            // Variables globales para m√≥dulos espec√≠ficos
            let tipoClienteSeleccionado = 'diario';
            let clienteEditandoId = null;
            let tipoButtons = {};
            let viewingPendienteDetail = null;
            let cuentaCorrienteSeleccionada = null; // Para rastrear si estamos viendo un detalle en pendientes

            /**
             * =================================================================
             * M√ìDULO DE CARGA Y NAVEGACI√ìN PRINCIPAL
             * =================================================================
             */
            function loadModule(module, addToHistory = true) {
                const mainContent = safeGetElementById('mainContent');
                if (!mainContent) return;
                
                // Limpiar todos los timeouts e intervals del m√≥dulo anterior
                clearAllTimeouts();
                clearAllIntervals();
                
                // Obtener el m√≥dulo actual antes de cambiar
                const currentModule = safeLocalStorageOperation('get', 'activeModule') || '';
                
                // Agregar al historial solo si:
                // 1. Es una navegaci√≥n normal (addToHistory = true)
                // 2. Hay un m√≥dulo actual v√°lido (no vac√≠o)
                // 3. El m√≥dulo actual es diferente al nuevo m√≥dulo
                // 4. El m√≥dulo actual no es la pantalla de inicio (no agregamos inicio al historial)
                if (addToHistory && currentModule && currentModule !== module && currentModule !== '' && currentModule !== 'inicio') {
                    // Solo agregar si el √∫ltimo elemento del historial no es el mismo m√≥dulo actual
                    // (evitar duplicados consecutivos)
                    if (navigationHistory.length === 0 || navigationHistory[navigationHistory.length - 1] !== currentModule) {
                        navigationHistory.push(currentModule);
                        // Limitar el historial a 20 elementos
                        if (navigationHistory.length > 20) {
                            navigationHistory.shift();
                        }
                    }
                }
                
                safeLocalStorageOperation('set', 'activeModule', module);
                
                // Resetear estado de edici√≥n al cambiar de m√≥dulo
                if (module === 'operaciones') {
                    // Resetear solo si no estamos editando (para no perder datos al cambiar de pesta√±a y volver)
                    if (editingMovimientoId === null) {
                        clearFormState(); // clearFormState() ya llama a getInitialFormState() internamente
                    }
                } else {
                    // Si cambiamos a otro m√≥dulo, resetear todo
                    editingMovimientoId = null;
                }
                switch(module) {
                    case 'inicio':
                    case 'home':
                        mainContent.innerHTML = renderHomeScreen();
                        initHomeScreen();
                        break;
                    case 'pendientes':
                        mainContent.innerHTML = renderPendientesModule();
                        initPendientesModule();
                        break;
                    case 'operaciones':
                        mainContent.innerHTML = renderOperationsModule();
                        initOperationsModule();
                        break;
                    case 'clientes':
                        mainContent.innerHTML = renderClientesModule();
                        initClientesModule();
                        break;
                    case 'movimientos':
                        mainContent.innerHTML = renderMovimientosModule();
                        initMovimientosModule();
                        break;
                    case 'saldos':
                        mainContent.innerHTML = renderSaldosModule();
                        initSaldosModule();
                        break;
                    case 'cuentas-corrientes':
                        mainContent.innerHTML = renderCuentasCorrientesModule();
                        initCuentasCorrientesModule();
                        break;
                    case 'configuracion':
                        mainContent.innerHTML = `
                            <div class="operations-container">
                                <div class="form-card">
                                    <div class="form-header">
                                        <button type="button" class="btn-back" onclick="window.goBack()" title="Volver">‚Üê Volver</button>
                                        <h2 class="form-title">Configuraci√≥n</h2>
                                        <div style="width: 100px;"></div>
                                    </div>
                                    <div class="theme-switch-container">
                                        <div class="theme-switch-label">
                                            <span id="themeIcon">üåô</span>
                                            <span id="themeText">Tema Oscuro</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="themeToggle">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        `;
                        initConfiguracion();
                        break;
                    default:
                        mainContent.innerHTML = renderHomeScreen();
                        initHomeScreen();
                }
            }

            /**
             * =================================================================
             * PANTALLA DE INICIO
             * =================================================================
             */
            function renderHomeScreen() {
                const hoy = new Date();
                const mes = hoy.getMonth();
                const a√±o = hoy.getFullYear();
                const primerDia = new Date(a√±o, mes, 1).getDay();
                const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
                const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const nombresDias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                
                let calendarioHTML = '<div class="home-calendar-grid">';
                // D√≠as de la semana
                nombresDias.forEach(dia => {
                    calendarioHTML += `<div class="home-calendar-day-header">${dia}</div>`;
                });
                // Espacios vac√≠os antes del primer d√≠a
                for (let i = 0; i < primerDia; i++) {
                    calendarioHTML += '<div class="home-calendar-empty"></div>';
                }
                // D√≠as del mes
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const esHoy = dia === hoy.getDate();
                    calendarioHTML += `
                        <div class="home-calendar-day ${esHoy ? 'home-calendar-today' : ''}">
                            ${dia}
                        </div>
                    `;
                }
                calendarioHTML += '</div>';

                return `
                    <div class="operations-container" style="max-width: 100%; padding: 20px;">
                        <div class="home-grid">
                            <!-- Cotizaciones -->
                            <div class="form-card" style="padding: 20px;">
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">üí± Cotizaciones</h3>
                                <div style="display: grid; gap: 15px;">
                                    <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; margin-bottom: 10px; font-size: 16px;">D√≥lar Blue</div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Compra</div>
                                                <div style="font-size: 18px; font-weight: 600; color: var(--success-color);" id="blueCompra">1,050</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Venta</div>
                                                <div style="font-size: 18px; font-weight: 600; color: var(--error-color);" id="blueVenta">1,080</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <div style="font-weight: 600; margin-bottom: 10px; font-size: 16px;">USDT</div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Compra</div>
                                                <div style="font-size: 18px; font-weight: 600; color: var(--success-color);" id="usdtCompra">1,045</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Venta</div>
                                                <div style="font-size: 18px; font-weight: 600; color: var(--error-color);" id="usdtVenta">1,075</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Calculadora -->
                            <div class="form-card" style="padding: 20px;">
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">üî¢ Calculadora</h3>
                                <div style="background: var(--bg-primary); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color);">
                                    <input type="text" id="calcDisplay" readonly style="width: 100%; padding: 15px; font-size: 24px; text-align: right; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); margin-bottom: 15px; font-weight: 600;" value="0">
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                        <button type="button" class="calc-btn" data-action="clear" style="grid-column: span 2;">C</button>
                                        <button type="button" class="calc-btn" data-action="backspace">‚å´</button>
                                        <button type="button" class="calc-btn" data-action="divide">√∑</button>
                                        <button type="button" class="calc-btn" data-value="7">7</button>
                                        <button type="button" class="calc-btn" data-value="8">8</button>
                                        <button type="button" class="calc-btn" data-value="9">9</button>
                                        <button type="button" class="calc-btn" data-action="multiply">√ó</button>
                                        <button type="button" class="calc-btn" data-value="4">4</button>
                                        <button type="button" class="calc-btn" data-value="5">5</button>
                                        <button type="button" class="calc-btn" data-value="6">6</button>
                                        <button type="button" class="calc-btn" data-action="subtract">‚àí</button>
                                        <button type="button" class="calc-btn" data-value="1">1</button>
                                        <button type="button" class="calc-btn" data-value="2">2</button>
                                        <button type="button" class="calc-btn" data-value="3">3</button>
                                        <button type="button" class="calc-btn" data-action="add">+</button>
                                        <button type="button" class="calc-btn" data-value="0" style="grid-column: span 2;">0</button>
                                        <button type="button" class="calc-btn" data-action="decimal">.</button>
                                        <button type="button" class="calc-btn" data-action="equals" style="background: var(--button-bg); color: white;">=</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Calendario y Hora -->
                            <div class="form-card" style="padding: 20px;">
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">üìÖ Calendario</h3>
                                <div style="background: var(--bg-primary); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color);">
                                    <div class="home-calendar-header">
                                        <div class="home-calendar-month">${nombresMeses[mes]} ${a√±o}</div>
                                        <div class="home-calendar-time" id="horaDisplay">00:00:00</div>
                                        <div class="home-calendar-date" id="fechaDisplay">${hoy.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
                                    </div>
                                    ${calendarioHTML}
                                </div>
                            </div>

                            <!-- Block de Notas -->
                            <div class="form-card home-notes-card" style="padding: 20px;">
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">üìù Block de Notas</h3>
                                <textarea id="homeNotes" style="width: 100%; min-height: 200px; padding: 15px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Escribe tus notas aqu√≠..."></textarea>
                            </div>
                        </div>
                    </div>
                `;
            }

            function initHomeScreen() {
                // Inicializar calculadora
                let calcValue = '0';
                let calcPreviousValue = null;
                let calcOperation = null;
                const calcDisplay = document.getElementById('calcDisplay');
                const calcButtons = document.querySelectorAll('.calc-btn');

                if (calcDisplay && calcButtons.length > 0) {
                    calcButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const action = btn.dataset.action;
                            const value = btn.dataset.value;

                            if (value) {
                                if (calcValue === '0') {
                                    calcValue = value;
                                } else {
                                    calcValue += value;
                                }
                                calcDisplay.value = calcValue;
                            } else if (action === 'clear') {
                                calcValue = '0';
                                calcPreviousValue = null;
                                calcOperation = null;
                                calcDisplay.value = calcValue;
                            } else if (action === 'backspace') {
                                calcValue = calcValue.slice(0, -1) || '0';
                                calcDisplay.value = calcValue;
                            } else if (action === 'decimal') {
                                if (!calcValue.includes('.')) {
                                    calcValue += '.';
                                    calcDisplay.value = calcValue;
                                }
                            } else if (['add', 'subtract', 'multiply', 'divide'].includes(action)) {
                                if (calcPreviousValue !== null && calcOperation) {
                                    calcValue = String(calculate(calcPreviousValue, calcValue, calcOperation));
                                    calcDisplay.value = calcValue;
                                }
                                calcPreviousValue = calcValue;
                                calcValue = '0';
                                calcOperation = action;
                            } else if (action === 'equals') {
                                if (calcPreviousValue !== null && calcOperation) {
                                    calcValue = String(calculate(calcPreviousValue, calcValue, calcOperation));
                                    calcDisplay.value = calcValue;
                                    calcPreviousValue = null;
                                    calcOperation = null;
                                }
                            }
                        });
                    });

                    function calculate(a, b, op) {
                        const numA = parseFloat(a);
                        const numB = parseFloat(b);
                        switch(op) {
                            case 'add': return numA + numB;
                            case 'subtract': return numA - numB;
                            case 'multiply': return numA * numB;
                            case 'divide': return numB !== 0 ? numA / numB : 0;
                            default: return numB;
                        }
                    }
                }

                // Actualizar hora cada segundo
                const horaDisplay = safeGetElementById('horaDisplay');
                const fechaDisplay = safeGetElementById('fechaDisplay');
                if (horaDisplay) {
                    const updateHora = () => {
                        try {
                            const ahora = new Date();
                            const horas = String(ahora.getHours()).padStart(2, '0');
                            const minutos = String(ahora.getMinutes()).padStart(2, '0');
                            const segundos = String(ahora.getSeconds()).padStart(2, '0');
                            if (horaDisplay) {
                                horaDisplay.textContent = `${horas}:${minutos}:${segundos}`;
                            }
                            if (fechaDisplay) {
                                fechaDisplay.textContent = ahora.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                            }
                        } catch (error) {
                            console.error('Error al actualizar hora:', error);
                        }
                    };
                    updateHora();
                    safeSetInterval(updateHora, 1000);
                }

                // Cargar y guardar notas
                const homeNotes = document.getElementById('homeNotes');
                if (homeNotes) {
                    const savedNotes = safeLocalStorageOperation('get', 'homeNotes');
                    if (savedNotes) {
                        homeNotes.value = savedNotes;
                    }
                    homeNotes.addEventListener('input', () => {
                        safeLocalStorageOperation('set', 'homeNotes', homeNotes.value);
                    });
                }
            }
            
            // Funci√≥n para volver atr√°s usando el historial
            function goBack() {
                // Funci√≥n auxiliar para abrir el men√∫ de forma robusta
                const openMenu = () => {
                    // Usar requestAnimationFrame para asegurar que el DOM est√© listo
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            const sidebar = document.getElementById('sidebar');
                            const overlay = document.getElementById('overlay');
                            if (sidebar && overlay) {
                                sidebar.classList.add('open');
                                overlay.classList.add('active');
                                // CORRECCI√ìN: No establecer display directamente, dejar que CSS lo maneje
                                // overlay.style.display se maneja con la clase 'active'
                            }
                        }, 300);
                    });
                };
                
                // Si hay historial, ir al m√≥dulo anterior
                if (navigationHistory.length > 0) {
                    const previousModule = navigationHistory.pop();
                    loadModule(previousModule, false); // false = no agregar al historial al volver
                    // Si el m√≥dulo anterior es la pantalla principal, abrir el men√∫
                    if (previousModule === '' || previousModule === 'inicio') {
                        openMenu();
                    }
                } else {
                    // Si no hay historial, siempre volver a inicio y abrir men√∫
                    const currentModule = safeLocalStorageOperation('get', 'activeModule') || '';
                    // Si no estamos ya en inicio, cargar inicio
                    if (currentModule !== 'inicio' && currentModule !== '') {
                        loadModule('inicio', false);
                        // Abrir el men√∫ despu√©s de cargar inicio
                        openMenu();
                    } else {
                        // Si ya estamos en inicio, solo abrir el men√∫
                        openMenu();
                    }
                }
            }

            // Hacer loadModule y goBack accesibles globalmente
            window.loadModule = loadModule;
            window.goBack = goBack;

            /**
             * =================================================================
             * UTILIDADES Y CONFIGURACI√ìN GLOBAL
             * =================================================================
             */
            const operaciones = {
                TRANSACCIONES: { icon: 'üí±', subMenu: ['COMPRA', 'VENTA', 'ARBITRAJE'] },
                CUENTAS_CORRIENTES: { icon: 'üè¶', subMenu: ['INGRESO', 'EGRESO', 'COMPRA', 'VENTA', 'ARBITRAJE'] },
                WALLET: { icon: 'üí≥', subMenu: ['INGRESO', 'SALIDA', 'PRESTAMO', 'DEVOLUCION', 'MOV ENTRE CUENTAS', 'CREAR WALLET', 'LISTA DE WALLETS'] },
                ADMINISTRATIVAS: { icon: '‚öôÔ∏è', subMenu: ['AJUSTE', 'GASTO'] },
                PRESTAMISTAS: { icon: 'ü§ù', subMenu: ['PRESTAMO', 'RETIRO'] }
            };
            const monedas = [
                { value: 'ARS', label: 'ARS' }, { value: 'USD', label: 'USD' }, { value: 'EUR', label: 'EUR' },
                { value: 'USDT', label: 'USDT' }, { value: 'BRL', label: 'BRL' }, { value: 'GBP', label: 'GBP' },
                { value: 'CLP', label: 'CLP' }
            ];
            const estados = [
                { value: 'pendiente_retiro', label: 'P. Retiro' }, { value: 'pendiente_entrega', label: 'P. Entrega' },
                { value: 'realizado', label: 'Finalizado' }
            ];

            function getInitialFormState() {
                const hoy = new Date();
                const fechaHoy = hoy.toISOString().split('T')[0];
                const nombreDiaHoy = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][hoy.getDay()];
                return {
                    fecha: fechaHoy, nombreDia: nombreDiaHoy, cliente: '', operacion: '',
                    subOperacion: '', detalle: '', monto: '', moneda: '', tc: '', total: '', estado: 'pendiente_retiro',
                    por: '', nombreOtro: '', walletCompra: '', walletTC: '', monedaTC: '', proveedorCC: '',
                    comisionTipo: 'porcentaje', comisionValor: '', montoComision: '', monedaComision: '', cuentaComision: '',
                    montoReal: '', interes: '', lapso: '', cuentaSalida: '', cuentaIngreso: '', monedaSalida: '',
                    monedaIngreso: '', comision: '', montoBase: '', monedaBase: '', cotizacionCliente: '',
                    cotizacionReal: '', montoCobrado: '', monedaCobro: '', costoReal: '', profit: '', monedaProfit: '',
                    walletProfit: '', walletBase: '', mixedPayments: [], isMixedPaymentActive: false
                };
            }

            // Operaci√≥n segura de localStorage con manejo de errores mejorado
            function safeLocalStorageOperation(operation, key, value = null) {
                try {
                    if (operation === 'get') {
                        return localStorage.getItem(key);
                    } else if (operation === 'set') {
                        // Validar que el valor no sea null o undefined
                        if (value === null || value === undefined) {
                            console.warn(`Intento de guardar valor null/undefined en clave "${key}"`);
                            return false;
                        }
                        
                        // Verificar tama√±o aproximado de los datos ANTES de convertir a string
                        // Estimar tama√±o sin convertir todo a string primero (m√°s eficiente)
                        let estimatedSize = 0;
                        if (typeof value === 'string') {
                            estimatedSize = new Blob([value]).size;
                        } else if (typeof value === 'object') {
                            // Estimar tama√±o del objeto sin stringificar completamente
                            try {
                                const sampleString = JSON.stringify(value).substring(0, 1000);
                                const sampleSize = new Blob([sampleString]).size;
                                // Estimar tama√±o total basado en muestra (aproximado)
                                estimatedSize = sampleSize * (JSON.stringify(value).length / 1000);
                            } catch (e) {
                                // Si falla, convertir completo
                                const dataString = JSON.stringify(value);
                                estimatedSize = new Blob([dataString]).size;
                            }
                        } else {
                            estimatedSize = new Blob([String(value)]).size;
                        }
                        
                        // L√≠mite aproximado de 4.5MB (localStorage tiene l√≠mite de ~5-10MB dependiendo del navegador)
                        if (estimatedSize > 4500000) {
                            if (typeof showToast === 'function') {
                                showToast('Los datos son demasiado grandes para guardar. Intenta eliminar datos antiguos.', 'error');
                            }
                            throw new Error('Datos muy grandes para almacenar');
                        }
                        
                        // Ahora convertir a string y guardar
                        const dataString = typeof value === 'string' ? value : JSON.stringify(value);
                        const finalSize = new Blob([dataString]).size;
                        
                        // Verificaci√≥n final del tama√±o real
                        if (finalSize > 5000000) {
                            if (typeof showToast === 'function') {
                                showToast('Error: Los datos exceden el l√≠mite de almacenamiento', 'error');
                            }
                            return false;
                        }
                        
                        localStorage.setItem(key, dataString);
                        return true;
                    } else if (operation === 'remove') {
                        localStorage.removeItem(key);
                        return true;
                    }
                } catch (error) {
                    console.error(`Error en localStorage.${operation}:`, error);
                    if (error.name === 'QuotaExceededError') {
                        // Intentar limpiar datos antiguos
                        try {
                            // Limpiar datos antiguos de movimientos (mantener solo los √∫ltimos 500)
                            const movimientos = getMovimientos();
                            if (movimientos.length > 500) {
                                const movimientosLimitados = movimientos.slice(0, 500);
                                // Usar directamente localStorage aqu√≠ porque estamos en el catch de QuotaExceededError
                                // y necesitamos limpiar espacio antes de reintentar
                                try {
                                    localStorage.setItem('movimientos', JSON.stringify(movimientosLimitados));
                                    // Notificar al usuario
                                    if (typeof showToast === 'function') {
                                        showToast('Se limpiaron movimientos antiguos para liberar espacio', 'info');
                                    }
                                } catch (cleanError) {
                                    console.error('No se pudo limpiar movimientos:', cleanError);
                                    if (typeof showToast === 'function') {
                                        showToast('Error: No se pudo limpiar espacio. Intenta eliminar datos manualmente.', 'error');
                                    }
                                }
                            }
                            // Reintentar la operaci√≥n original
                            if (operation === 'set') {
                                // Usar directamente localStorage para el reintento ya que estamos en el catch
                                try {
                                    localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
                                    return true;
                                } catch (retryError) {
                                    console.error('Error al reintentar operaci√≥n despu√©s de limpiar:', retryError);
                                    if (typeof showToast === 'function') {
                                        showToast('Error: No se pudo guardar. El almacenamiento est√° lleno.', 'error');
                                    }
                                    return false;
                                }
                            }
                        } catch (e) {
                            console.error('No se pudo limpiar datos antiguos:', e);
                            if (typeof showToast === 'function') {
                                showToast('Error cr√≠tico: Espacio de almacenamiento lleno. Limpia datos antiguos manualmente.', 'error');
                            }
                        }
                        return false;
                    } else {
                        // Otros errores de localStorage
                        if (typeof showToast === 'function') {
                            showToast(`Error al ${operation === 'get' ? 'leer' : operation === 'set' ? 'guardar' : 'eliminar'} datos`, 'error');
                        }
                    }
                    return false;
                }
                return false;
            }
            
            function saveFormState() {
                const success = safeLocalStorageOperation('set', 'formState', formData);
                if (!success) {
                    console.error('No se pudo guardar el estado del formulario');
                    // No mostrar toast aqu√≠ para evitar spam, solo en casos cr√≠ticos
                }
            }

            function loadFormState() {
                try {
                    const savedState = safeLocalStorageOperation('get', 'formState');
                    if (savedState) {
                        // Validar que el string JSON sea v√°lido antes de parsear
                        if (typeof savedState !== 'string' || savedState.trim() === '') {
                            console.warn('Estado del formulario vac√≠o o inv√°lido');
                            formData = getInitialFormState();
                            return false;
                        }
                        
                        // Validar formato JSON b√°sico
                        if (!savedState.startsWith('{') && !savedState.startsWith('[')) {
                            console.error('Estado del formulario no tiene formato JSON v√°lido');
                            if (typeof showToast === 'function') {
                                showToast('Error: Estado guardado corrupto. Se iniciar√° un formulario nuevo.', 'error');
                            }
                            formData = getInitialFormState();
                            return false;
                        }
                        
                        try {
                        formData = JSON.parse(savedState);
                            // Validar que formData sea un objeto v√°lido
                            if (!formData || typeof formData !== 'object' || Array.isArray(formData)) {
                                throw new Error('Estado del formulario inv√°lido: debe ser un objeto');
                            }
                        // Normalizar monedas al cargar
                        formData = normalizeAllMonedas(formData);
                        // Asegurar que mixedPayments siempre sea un array
                        if (!Array.isArray(formData.mixedPayments)) {
                            formData.mixedPayments = [];
                        }
                        // Asegurar que isMixedPaymentActive sea booleano
                        if (typeof formData.isMixedPaymentActive !== 'boolean') {
                            formData.isMixedPaymentActive = false;
                        }
                        return true;
                        } catch (parseError) {
                            console.error('Error al parsear estado del formulario:', parseError);
                            if (typeof showToast === 'function') {
                                showToast('Error al cargar estado guardado. Se iniciar√° un formulario nuevo.', 'error');
                            }
                            formData = getInitialFormState();
                            return false;
                        }
                    }
                    formData = getInitialFormState();
                    return false;
                } catch (error) {
                    console.error('Error al cargar estado del formulario:', error);
                    if (typeof showToast === 'function') {
                        showToast('Error al cargar estado guardado', 'error');
                    }
                    formData = getInitialFormState();
                    return false;
                }
            }

            function clearFormState() {
                safeLocalStorageOperation('remove', 'formState');
                formData = getInitialFormState();
                editingMovimientoId = null;
                walletEditandoId = null;
            }
            
            function showToast(message, type = 'info') {
                // Validar par√°metros
                if (!message || typeof message !== 'string') {
                    console.warn('showToast: mensaje inv√°lido');
                    return;
                }
                
                if (!['success', 'error', 'info', 'warning'].includes(type)) {
                    type = 'info';
                }
                
                const container = safeGetElementById('toastContainer');
                if (!container) {
                    console.warn('showToast: contenedor no encontrado');
                    return;
                }
                
                try {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    const icon = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è');
                    toast.innerHTML = `<span>${icon}</span> ${escapeHTML(message)}`;
                    container.appendChild(toast);
                    
                    // Forzar reflow para que la animaci√≥n funcione
                    toast.offsetHeight;
                    
                    setTimeout(() => { toast.classList.add('show'); }, 10);
                    
                    // Duraci√≥n seg√∫n tipo (errores m√°s tiempo)
                    const duration = type === 'error' ? 5000 : 3000;
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                        toast.addEventListener('transitionend', () => {
                            if (toast.parentNode) {
                                toast.remove();
                            }
                        }, { once: true });
                    }, duration);
                } catch (error) {
                    console.error('Error al mostrar toast:', error);
                }
            }

            /**
             * =================================================================
             * GESTI√ìN DE WALLETS (LocalStorage)
             * =================================================================
             */
            // Cache para wallets
            let walletsCache = null;
            let walletsCacheTimestamp = null;
            const WALLETS_CACHE_DURATION = 2000; // 2 segundos de cache

            function invalidateWalletsCache() {
                walletsCache = null;
                walletsCacheTimestamp = null;
            }

            function getWallets() {
                // Verificar cache
                const now = Date.now();
                if (walletsCache && walletsCacheTimestamp && (now - walletsCacheTimestamp) < WALLETS_CACHE_DURATION) {
                    return walletsCache;
                }
                
                try {
                    const data = safeLocalStorageOperation('get', 'wallets');
                    if (!data) {
                        walletsCache = [];
                        walletsCacheTimestamp = now;
                        return [];
                    }
                    const parsed = JSON.parse(data);
                    // Validar que sea un array
                    if (!Array.isArray(parsed)) {
                        console.error('Datos de wallets inv√°lidos, se retorna array vac√≠o');
                        walletsCache = [];
                        walletsCacheTimestamp = now;
                        return [];
                    }
                    walletsCache = parsed;
                    walletsCacheTimestamp = now;
                    return parsed;
                } catch (error) {
                    console.error('Error al obtener wallets:', error);
                    if (typeof showToast === 'function') {
                        showToast('Error al cargar wallets', 'error');
                    }
                    walletsCache = [];
                    walletsCacheTimestamp = now;
                    return [];
                }
            }

            function saveWallets(wallets) {
                // Validar que wallets sea un array
                if (!Array.isArray(wallets)) {
                    console.error('Intento de guardar wallets inv√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: Datos de wallets inv√°lidos', 'error');
                    }
                    return;
                }
                // Limitar a √∫ltimos 100 wallets para evitar acumulaci√≥n excesiva
                const MAX_WALLETS = 100;
                let walletsLimitados = wallets;
                if (wallets.length > MAX_WALLETS) {
                    walletsLimitados = wallets.slice(0, MAX_WALLETS);
                    if (typeof showToast === 'function') {
                        showToast(`Se mantienen solo las √∫ltimas ${MAX_WALLETS} wallets`, 'info');
                }
                }
                // Invalidar cache al guardar
                invalidateWalletsCache();
                invalidateSaldosCache();
                const success = safeLocalStorageOperation('set', 'wallets', walletsLimitados);
                if (!success) {
                    console.error('No se pudo guardar wallets');
                    if (typeof showToast === 'function') {
                        showToast('Error al guardar wallets', 'error');
                    }
                }
            }

            function addWallet(wallet) {
                // Validar estructura de wallet
                if (!wallet || typeof wallet !== 'object') {
                    console.error('Intento de agregar wallet inv√°lida');
                    if (typeof showToast === 'function') {
                        showToast('Error: Datos de wallet inv√°lidos', 'error');
                    }
                    return;
                }
                
                // Validar campos requeridos
                if (!wallet.id || typeof wallet.id !== 'string' || wallet.id.trim() === '') {
                    console.error('Wallet sin ID v√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: La wallet debe tener un ID v√°lido', 'error');
                    }
                    return;
                }
                
                if (!wallet.nombre || typeof wallet.nombre !== 'string' || wallet.nombre.trim() === '') {
                    console.error('Wallet sin nombre v√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: La wallet debe tener un nombre v√°lido', 'error');
                    }
                    return;
                }
                
                // Sanitizar ID y nombre
                wallet.id = wallet.id.trim();
                wallet.nombre = wallet.nombre.trim();
                
                // Validar tipos
                if (!Array.isArray(wallet.tipos) || wallet.tipos.length === 0) {
                    console.error('Wallet sin tipos v√°lidos');
                    if (typeof showToast === 'function') {
                        showToast('Error: La wallet debe tener al menos un tipo', 'error');
                    }
                    return;
                }
                
                // Validar monedas
                if (!Array.isArray(wallet.monedas) || wallet.monedas.length === 0) {
                    console.error('Wallet sin monedas v√°lidas');
                    if (typeof showToast === 'function') {
                        showToast('Error: La wallet debe tener al menos una moneda', 'error');
                    }
                    return;
                }
                
                // Sanitizar tipos y monedas
                wallet.tipos = wallet.tipos.filter(t => t && typeof t === 'string').map(t => String(t).toLowerCase());
                wallet.monedas = wallet.monedas.filter(m => m && typeof m === 'string').map(m => normalizeMoneda(String(m)));
                
                // Validar que no exista ya
                const wallets = getWallets();
                if (wallets.some(w => w.id === wallet.id)) {
                    console.error('Wallet con ID duplicado:', wallet.id);
                    if (typeof showToast === 'function') {
                        showToast('Error: Ya existe una wallet con ese ID', 'error');
                    }
                    return;
                }
                
                wallets.push(wallet);
                saveWallets(wallets);
            }

            function deleteWallet(walletId) {
                if (!walletId) {
                    console.error('Intento de eliminar wallet sin ID');
                    return;
                }
                
                // Verificar que la wallet existe
                const wallets = getWallets();
                const wallet = wallets.find(w => w.id === walletId);
                if (!wallet) {
                    if (typeof showToast === 'function') {
                        showToast('La wallet no existe', 'error');
                    }
                    return;
                }
                
                // Verificar si hay movimientos que usan esta wallet
                const movimientos = getMovimientosCached();
                const movimientosConWallet = movimientos.filter(m => {
                    if (!m.anulado) {
                        const walletCompraId = parseWalletId(m.walletCompra || '').wallet;
                        const walletTCId = parseWalletId(m.walletTC || '').wallet;
                        const walletBaseId = parseWalletId(m.walletBase || '').wallet;
                        const walletProfitId = parseWalletId(m.walletProfit || '').wallet;
                        const cuentaSalidaId = parseWalletId(m.cuentaSalida || '').wallet;
                        const cuentaIngresoId = parseWalletId(m.cuentaIngreso || '').wallet;
                        return walletCompraId === walletId || walletTCId === walletId || 
                               walletBaseId === walletId || walletProfitId === walletId ||
                               cuentaSalidaId === walletId || cuentaIngresoId === walletId ||
                               (m.mixedPayments && Array.isArray(m.mixedPayments) && 
                                m.mixedPayments.some(p => parseWalletId(p.wallet || '').wallet === walletId));
                    }
                    return false;
                });
                
                if (movimientosConWallet.length > 0) {
                    if (typeof showToast === 'function') {
                        showToast(`No se puede eliminar la wallet porque tiene ${movimientosConWallet.length} movimiento(s) asociado(s)`, 'error');
                    }
                    return;
                }
                
                const walletsFiltradas = wallets.filter(w => w.id !== walletId);
                saveWallets(walletsFiltradas);
                
                if (typeof showToast === 'function') {
                    showToast(`Wallet "${wallet.nombre}" eliminada correctamente`, 'success');
                }
            }

            /**
             * =================================================================
             * GESTI√ìN DE CLIENTES (LocalStorage)
             * =================================================================
             */
            // Cache para clientes
            let clientesCache = null;
            let clientesCacheTimestamp = null;
            const CLIENTES_CACHE_DURATION = 2000; // 2 segundos de cache

            function invalidateClientesCache() {
                clientesCache = null;
                clientesCacheTimestamp = null;
            }

            function getClientes() {
                // Verificar cache
                const now = Date.now();
                if (clientesCache && clientesCacheTimestamp && (now - clientesCacheTimestamp) < CLIENTES_CACHE_DURATION) {
                    return clientesCache;
                }
                
                try {
                    const data = safeLocalStorageOperation('get', 'clientes');
                    if (!data) {
                        clientesCache = [];
                        clientesCacheTimestamp = now;
                        return [];
                    }
                    const parsed = JSON.parse(data);
                    // Validar que sea un array
                    if (!Array.isArray(parsed)) {
                        console.error('Datos de clientes inv√°lidos, se retorna array vac√≠o');
                        clientesCache = [];
                        clientesCacheTimestamp = now;
                        return [];
                    }
                    clientesCache = parsed;
                    clientesCacheTimestamp = now;
                    return parsed;
                } catch (error) {
                    console.error('Error al obtener clientes:', error);
                    if (typeof showToast === 'function') {
                        showToast('Error al cargar clientes', 'error');
                    }
                    clientesCache = [];
                    clientesCacheTimestamp = now;
                    return [];
                }
            }

            function saveClientes(clientes) {
                // Validar que clientes sea un array
                if (!Array.isArray(clientes)) {
                    console.error('Intento de guardar clientes inv√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: Datos de clientes inv√°lidos', 'error');
                    }
                    return;
                }
                // Limitar a √∫ltimos 500 clientes para evitar acumulaci√≥n excesiva
                const MAX_CLIENTES = 500;
                let clientesLimitados = clientes;
                if (clientes.length > MAX_CLIENTES) {
                    clientesLimitados = clientes.slice(0, MAX_CLIENTES);
                    if (typeof showToast === 'function') {
                        showToast(`Se mantienen solo los √∫ltimos ${MAX_CLIENTES} clientes`, 'info');
                }
                }
                // Invalidar caches al guardar clientes
                invalidateClientesCache();
                invalidateBalancesCache();
                const success = safeLocalStorageOperation('set', 'clientes', clientesLimitados);
                if (!success) {
                    console.error('No se pudo guardar clientes');
                    if (typeof showToast === 'function') {
                        showToast('Error al guardar clientes', 'error');
                    }
                }
            }

            function addCliente(cliente) {
                // Validar estructura de cliente
                if (!cliente || typeof cliente !== 'object') {
                    console.error('Intento de agregar cliente inv√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: Datos de cliente inv√°lidos', 'error');
                    }
                    return;
                }
                
                // Validar campos requeridos
                if (!cliente.nombre || typeof cliente.nombre !== 'string' || cliente.nombre.trim() === '') {
                    if (typeof showToast === 'function') {
                        showToast('Error: El nombre del cliente es obligatorio', 'error');
                    }
                    return;
                }
                
                // Sanitizar nombre
                cliente.nombre = cliente.nombre.trim();
                
                // Validar y sanitizar ID si existe
                if (cliente.id && typeof cliente.id !== 'string') {
                    cliente.id = String(cliente.id).trim();
                }
                
                // Validar y sanitizar documento si existe
                if (cliente.documento && typeof cliente.documento !== 'string') {
                    cliente.documento = String(cliente.documento).trim();
                }
                
                // Validar email si est√° presente
                if (cliente.email && cliente.email.trim() !== '') {
                    if (!isValidEmail(cliente.email)) {
                        if (typeof showToast === 'function') {
                            showToast('Error: El formato del email no es v√°lido', 'error');
                        }
                        return;
                    }
                }
                
                // Validar que no exista un cliente con el mismo ID
                const clientes = getClientes();
                if (cliente.id && clientes.some(c => c.id === cliente.id)) {
                    console.error('Cliente con ID duplicado:', cliente.id);
                    if (typeof showToast === 'function') {
                        showToast('Error: Ya existe un cliente con ese ID', 'error');
                    }
                    return;
                }
                
                clientes.push(cliente);
                saveClientes(clientes);
            }

            function deleteCliente(clienteId) {
                if (!clienteId) {
                    console.error('Intento de eliminar cliente sin ID');
                    return;
                }
                
                // Verificar que el cliente existe
                const clientes = getClientes();
                const cliente = clientes.find(c => c.id === clienteId);
                if (!cliente) {
                    if (typeof showToast === 'function') {
                        showToast('El cliente no existe', 'error');
                    }
                    return;
                }
                
                // Verificar si hay movimientos que usan este cliente
                const movimientos = getMovimientosCached();
                // Optimizar filtrado: validar estructura y filtrar anulados primero
                const movimientosConCliente = movimientos.filter(m => {
                    if (!m || typeof m !== 'object') return false;
                    if (m.anulado) return false;
                    return m.cliente === clienteId;
                });
                
                if (movimientosConCliente.length > 0) {
                    if (typeof showToast === 'function') {
                        showToast(`No se puede eliminar el cliente porque tiene ${movimientosConCliente.length} movimiento(s) asociado(s)`, 'error');
                    }
                    return;
                }
                
                const clientesFiltrados = clientes.filter(c => c.id !== clienteId);
                saveClientes(clientesFiltrados);
                
                if (typeof showToast === 'function') {
                    showToast(`Cliente "${cliente.nombre}" eliminado correctamente`, 'success');
                }
            }

            function updateCliente(clienteId, datosActualizados) {
                let clientes = getClientes();
                const index = clientes.findIndex(c => c.id === clienteId);
                if (index !== -1) {
                    clientes[index] = { ...clientes[index], ...datosActualizados };
                    saveClientes(clientes);
                }
            }

            /**
             * =================================================================
             * GESTI√ìN DE MOVIMIENTOS (LocalStorage)
             * =================================================================
             */
            function getMovimientos() {
                try {
                    const data = safeLocalStorageOperation('get', 'movimientos');
                    if (!data) return [];
                    const parsed = JSON.parse(data);
                    // Validar que sea un array
                    if (!Array.isArray(parsed)) {
                        console.error('Datos de movimientos inv√°lidos, se retorna array vac√≠o');
                        return [];
                    }
                    return parsed;
                } catch (error) {
                    console.error('Error al obtener movimientos:', error);
                    if (typeof showToast === 'function') {
                        showToast('Error al cargar movimientos', 'error');
                    }
                    return [];
                }
            }

            function saveMovimientos(movimientos) {
                // Validar que movimientos sea un array
                if (!Array.isArray(movimientos)) {
                    console.error('Intento de guardar movimientos inv√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: Datos de movimientos inv√°lidos', 'error');
                    }
                    return;
                }
                // Invalidar caches al guardar
                invalidateMovimientosCache();
                invalidateSaldosCache();
                const success = safeLocalStorageOperation('set', 'movimientos', movimientos);
                if (!success) {
                    console.error('No se pudo guardar movimientos');
                    if (typeof showToast === 'function') {
                        showToast('Error al guardar movimientos', 'error');
                    }
                }
            }

            function addMovimiento(movimiento) {
                // Validar estructura b√°sica del movimiento
                if (!movimiento || typeof movimiento !== 'object') {
                    console.error('Intento de agregar movimiento inv√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: Datos de movimiento inv√°lidos', 'error');
                    }
                    return null;
                }
                
                // Validar campos requeridos
                if (!movimiento.operacion || !movimiento.subOperacion) {
                    console.error('Movimiento sin operaci√≥n o sub-operaci√≥n');
                    if (typeof showToast === 'function') {
                        showToast('Error: El movimiento debe tener operaci√≥n y tipo', 'error');
                    }
                    return null;
                }
                
                // Validar que las monedas est√©n normalizadas
                if (movimiento.moneda) {
                    movimiento.moneda = normalizeMoneda(movimiento.moneda);
                }
                if (movimiento.monedaTC) {
                    movimiento.monedaTC = normalizeMoneda(movimiento.monedaTC);
                }
                if (movimiento.monedaBase) {
                    movimiento.monedaBase = normalizeMoneda(movimiento.monedaBase);
                }
                if (movimiento.monedaProfit) {
                    movimiento.monedaProfit = normalizeMoneda(movimiento.monedaProfit);
                }
                
                // Validar que los IDs de wallets/clientes sean strings v√°lidos si existen
                if (movimiento.cliente && typeof movimiento.cliente !== 'string') {
                    movimiento.cliente = String(movimiento.cliente);
                }
                
                // Validar que mixedPayments sea un array si existe
                if (movimiento.mixedPayments && !Array.isArray(movimiento.mixedPayments)) {
                    console.warn('mixedPayments no es un array, se convierte a array vac√≠o');
                    movimiento.mixedPayments = [];
                }
                
                // Validar estructura de mixedPayments si existe
                if (movimiento.mixedPayments && Array.isArray(movimiento.mixedPayments)) {
                    movimiento.mixedPayments = movimiento.mixedPayments.filter(p => {
                        return p && typeof p === 'object' && p.wallet && p.monto;
                    }).map(p => ({
                        wallet: String(p.wallet || ''),
                        monto: String(p.monto || '0')
                    }));
                }
                
                // Validar fecha si existe
                if (movimiento.fecha) {
                    try {
                        if (!isValidDate(movimiento.fecha + 'T00:00:00')) {
                            console.error('Fecha inv√°lida en movimiento:', movimiento.fecha);
                            if (typeof showToast === 'function') {
                                showToast('Error: La fecha del movimiento no es v√°lida', 'error');
                            }
                            return null;
                        }
                    } catch (dateError) {
                        console.error('Error al validar fecha del movimiento:', dateError);
                        if (typeof showToast === 'function') {
                            showToast('Error al validar la fecha del movimiento', 'error');
                        }
                        return null;
                    }
                }
                
                // Normalizar todas las monedas en el movimiento completo
                normalizeAllMonedas(movimiento);
                
                // Invalidar cache antes de obtener movimientos
                invalidateMovimientosCache();
                let movimientos = getMovimientos();
                
                // Limitar a √∫ltimos 1000 movimientos para evitar acumulaci√≥n excesiva
                const MAX_MOVIMIENTOS = 1000;
                if (movimientos.length >= MAX_MOVIMIENTOS) {
                    // Mantener solo los √∫ltimos 999 movimientos (antes de agregar el nuevo)
                    movimientos = movimientos.slice(0, MAX_MOVIMIENTOS - 1);
                    if (typeof showToast === 'function') {
                        showToast(`Se mantienen solo los √∫ltimos ${MAX_MOVIMIENTOS} movimientos`, 'info');
                    }
                }
                
                // Normalizar monedas antes de guardar
                const movimientoNormalizado = normalizeAllMonedas({ ...movimiento });
                
                // Validar fecha
                if (!movimientoNormalizado.fecha || !isValidDate(movimientoNormalizado.fecha + 'T00:00:00')) {
                    // Si no hay fecha v√°lida, usar la fecha actual
                    const hoy = new Date();
                    movimientoNormalizado.fecha = hoy.toISOString().split('T')[0];
                    movimientoNormalizado.nombreDia = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][hoy.getDay()];
                }
                
                // Generar ID √∫nico para el movimiento
                let id;
                try {
                    const uuid = generateUUID();
                    if (!uuid || typeof uuid !== 'string') {
                        throw new Error('UUID inv√°lido');
                    }
                    id = 'MOV_' + uuid;
                } catch (error) {
                    console.error('Error al generar ID de movimiento:', error);
                    // Fallback: timestamp + random
                    id = 'MOV_' + Date.now().toString(36) + Math.random().toString(36).substring(2);
                }
                const nuevoMovimiento = { 
                    ...movimientoNormalizado, 
                    id, 
                    fechaCreacion: new Date().toISOString(), 
                    anulado: false 
                };
                
                // Validar que el movimiento tenga estructura v√°lida antes de guardar
                if (!nuevoMovimiento.operacion || !nuevoMovimiento.subOperacion) {
                    console.error('Movimiento sin operaci√≥n o subOperaci√≥n v√°lida');
                    if (typeof showToast === 'function') {
                        showToast('Error: El movimiento debe tener operaci√≥n y tipo', 'error');
                    }
                    return null;
                }
                
                movimientos.unshift(nuevoMovimiento);
                const success = saveMovimientos(movimientos);
                
                if (!success) {
                    console.error('Error al guardar movimiento');
                    if (typeof showToast === 'function') {
                        showToast('Error al guardar el movimiento', 'error');
                    }
                    return null;
                }
                
                return id;
            }

            function updateMovimiento(movimientoId, datosActualizados) {
                // Validar ID del movimiento
                if (!movimientoId || typeof movimientoId !== 'string') {
                    console.error('Intento de actualizar movimiento sin ID v√°lido');
                    if (typeof showToast === 'function') {
                        showToast('Error: ID de movimiento inv√°lido', 'error');
                    }
                    return false;
                }
                
                // Validar que los datos sean v√°lidos
                if (!datosActualizados || typeof datosActualizados !== 'object') {
                    console.error('Intento de actualizar movimiento con datos inv√°lidos');
                    if (typeof showToast === 'function') {
                        showToast('Error: Datos de actualizaci√≥n inv√°lidos', 'error');
                    }
                    return false;
                }
                
                // Invalidar cache antes de obtener movimientos
                invalidateMovimientosCache();
                invalidateSaldosCache(); // Invalidar cache de saldos al actualizar movimiento
                let movimientos = getMovimientos();
                
                if (!Array.isArray(movimientos)) {
                    console.error('Error: movimientos no es un array');
                    if (typeof showToast === 'function') {
                        showToast('Error: No se pudieron cargar los movimientos', 'error');
                    }
                    return false;
                }
                
                const index = movimientos.findIndex(m => m && m.id === movimientoId);
                if (index === -1) {
                    console.error('Movimiento no encontrado para actualizar:', movimientoId);
                    if (typeof showToast === 'function') {
                        showToast('Error: Movimiento no encontrado', 'error');
                    }
                    return false;
                }
                
                // Validar que el movimiento existente sea v√°lido
                if (!movimientos[index] || typeof movimientos[index] !== 'object') {
                    console.error('Movimiento en √≠ndice inv√°lido:', index);
                    if (typeof showToast === 'function') {
                        showToast('Error: Movimiento corrupto', 'error');
                    }
                    return false;
                }
                
                try {
                    // Normalizar monedas antes de actualizar
                    const datosNormalizados = normalizeAllMonedas({ ...datosActualizados });
                    
                    // Validar fecha si se actualiza
                    if (datosNormalizados.fecha) {
                        try {
                            if (!isValidDate(datosNormalizados.fecha + 'T00:00:00')) {
                                console.error('Fecha inv√°lida en actualizaci√≥n de movimiento');
                                if (typeof showToast === 'function') {
                                    showToast('Error: La fecha no es v√°lida', 'error');
                                }
                                return false;
                            }
                        } catch (dateError) {
                            console.error('Error al validar fecha:', dateError);
                            if (typeof showToast === 'function') {
                                showToast('Error al validar la fecha', 'error');
                            }
                            return false;
                        }
                    }
                    
                    // Validar estructura de mixedPayments si existe
                    if (datosNormalizados.mixedPayments !== undefined) {
                        if (!Array.isArray(datosNormalizados.mixedPayments)) {
                            datosNormalizados.mixedPayments = [];
                        } else {
                            datosNormalizados.mixedPayments = datosNormalizados.mixedPayments.filter(p => {
                                return p && typeof p === 'object' && p.wallet && p.monto;
                            }).map(p => ({
                                wallet: String(p.wallet || ''),
                                monto: String(p.monto || '0')
                            }));
                        }
                    }
                    
                    // Actualizar movimiento preservando campos importantes
                    movimientos[index] = { 
                        ...movimientos[index], 
                        ...datosNormalizados, 
                        id: movimientoId, // Preservar ID original
                        fechaModificacion: new Date().toISOString(),
                        // Preservar fechaCreacion si existe
                        fechaCreacion: movimientos[index].fechaCreacion || new Date().toISOString()
                    };
                    
                    const success = saveMovimientos(movimientos);
                    if (!success) {
                        if (typeof showToast === 'function') {
                            showToast('Error al guardar los cambios', 'error');
                        }
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error al actualizar movimiento:', error);
                    if (typeof showToast === 'function') {
                        showToast('Error al actualizar el movimiento', 'error');
                    }
                    return false;
                }
            }

            function anularMovimiento(movimientoId) {
                if (!movimientoId) {
                    console.error('Intento de anular movimiento sin ID');
                    if (typeof showToast === 'function') {
                        showToast('Error: ID de movimiento inv√°lido', 'error');
                    }
                    return;
                }
                
                // Invalidar cache antes de obtener movimientos
                invalidateMovimientosCache();
                invalidateSaldosCache(); // Invalidar cache de saldos al anular movimiento
                let movimientos = getMovimientos();
                const index = movimientos.findIndex(m => m.id === movimientoId);
                
                if (index === -1) {
                    if (typeof showToast === 'function') {
                        showToast('Movimiento no encontrado', 'error');
                    }
                    return;
                }
                
                const movimiento = movimientos[index];
                
                // Verificar si ya est√° anulado
                if (movimiento.anulado) {
                    if (typeof showToast === 'function') {
                        showToast('El movimiento ya est√° anulado', 'info');
                    }
                    return;
                }
                
                    movimientos[index].anulado = true;
                    movimientos[index].fechaAnulacion = new Date().toISOString();
                    saveMovimientos(movimientos);
                
                // Refrescar lista si estamos en el m√≥dulo de movimientos
                if (safeGetElementById('movimientosListContainer')) {
                    renderMovimientosList(window.currentMovimientosPage || 1);
                }
                
                // Refrescar saldos si estamos en el m√≥dulo de saldos
                if (safeGetElementById('saldosListContainer')) {
                    renderSaldosList();
                }
                
                if (typeof showToast === 'function') {
                    showToast('Movimiento anulado correctamente', 'success');
                }
            }

            function getClienteNombre(clienteId) {
                if (!clienteId || typeof clienteId !== 'string') return 'Sin cliente';
                try {
                    const clientes = getClientes();
                    if (!Array.isArray(clientes)) return `Cliente ${clienteId}`;
                    const cliente = clientes.find(c => c && c.id === clienteId);
                    if (!cliente || !cliente.nombre) return `Cliente ${clienteId}`;
                    return String(cliente.nombre);
                } catch (error) {
                    console.error('Error al obtener nombre de cliente:', error);
                    return `Cliente ${clienteId}`;
                }
            }

            function getClienteCompleto(clienteId) {
                if (!clienteId || typeof clienteId !== 'string') return null;
                try {
                    const clientes = getClientes();
                    if (!Array.isArray(clientes)) return null;
                    const cliente = clientes.find(c => c && c.id === clienteId);
                    if (!cliente || typeof cliente !== 'object') return null;
                    return cliente;
                } catch (error) {
                    console.error('Error al obtener cliente completo:', error);
                    return null;
                }
            }

            function getWalletNombre(walletId) {
                if (!walletId || typeof walletId !== 'string' || walletId === 'pago_mixto') return null;
                try {
                    const parsed = parseWalletId(walletId);
                    if (!parsed || !parsed.wallet) return null;
                    const wallets = getWallets();
                    if (!Array.isArray(wallets)) return null;
                    const wallet = wallets.find(w => w && w.id === parsed.wallet);
                    if (!wallet || !wallet.nombre) return null;
                    return String(wallet.nombre);
                } catch (error) {
                    console.error('Error al obtener nombre de wallet:', error);
                    return null;
                }
            }

            function actualizarUltimaOperacionCliente(clienteId) {
                if (!clienteId || typeof clienteId !== 'string') {
                    console.warn('actualizarUltimaOperacionCliente: clienteId inv√°lido');
                    return;
                }
                
                try {
                    const fechaActual = new Date().toISOString();
                    updateCliente(clienteId, { ultimaOperacion: fechaActual });
                } catch (error) {
                    console.error('Error al actualizar √∫ltima operaci√≥n del cliente:', error);
                }
            }

            function calcularDiasDesdeUltimaOperacion(fechaUltimaOperacion) {
                if (!fechaUltimaOperacion) return null;
                try {
                    // Parsear la fecha asegur√°ndonos de usar UTC para evitar problemas de zona horaria
                    let fechaUltima;
                    if (typeof fechaUltimaOperacion === 'string' && fechaUltimaOperacion.includes('T')) {
                        // Si ya tiene formato ISO con hora, usar directamente
                        fechaUltima = new Date(fechaUltimaOperacion);
                    } else if (typeof fechaUltimaOperacion === 'string') {
                        // Si es solo fecha, agregar hora UTC para evitar problemas de zona horaria
                        fechaUltima = new Date(fechaUltimaOperacion + 'T00:00:00.000Z');
                    } else {
                        fechaUltima = new Date(fechaUltimaOperacion);
                    }
                    
                const fechaActual = new Date();
                    
                    // Validar que las fechas sean v√°lidas
                    if (isNaN(fechaUltima.getTime()) || isNaN(fechaActual.getTime())) {
                        console.error('Fecha inv√°lida en calcularDiasDesdeUltimaOperacion');
                        return null;
                    }
                    
                    // Normalizar ambas fechas a UTC medianoche para comparar solo d√≠as (sin horas y sin zona horaria)
                    const fechaUltimaUTC = new Date(Date.UTC(
                        fechaUltima.getUTCFullYear(), 
                        fechaUltima.getUTCMonth(), 
                        fechaUltima.getUTCDate()
                    ));
                    const fechaActualUTC = new Date(Date.UTC(
                        fechaActual.getUTCFullYear(), 
                        fechaActual.getUTCMonth(), 
                        fechaActual.getUTCDate()
                    ));
                    
                    const diferencia = fechaActualUTC - fechaUltimaUTC;
                    // F√≥rmula correcta: ms * s * m * h = milisegundos en un d√≠a
                    // 1000ms * 60s * 60m * 24h = 86400000 ms por d√≠a
                const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
                return dias;
                } catch (error) {
                    console.error('Error al calcular d√≠as desde √∫ltima operaci√≥n:', error);
                    return null;
                }
            }

            function formatearFechaUltimaOperacion(fechaUltimaOperacion) {
                if (!fechaUltimaOperacion) return 'Nunca';
                
                try {
                    const fecha = new Date(fechaUltimaOperacion);
                    
                    // Validar que la fecha sea v√°lida
                    if (isNaN(fecha.getTime())) {
                        console.error('Fecha inv√°lida en formatearFechaUltimaOperacion:', fechaUltimaOperacion);
                        return 'Fecha inv√°lida';
                    }
                    
                    const hoy = new Date();
                    const ayer = new Date(hoy);
                    ayer.setDate(ayer.getDate() - 1);
                    
                    // Comparar solo fecha (sin hora)
                    const fechaSinHora = new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());
                    const hoySinHora = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                    const ayerSinHora = new Date(ayer.getFullYear(), ayer.getMonth(), ayer.getDate());
                    
                    if (fechaSinHora.getTime() === hoySinHora.getTime()) {
                        return 'Hoy';
                    } else if (fechaSinHora.getTime() === ayerSinHora.getTime()) {
                        return 'Ayer';
                    } else {
                        return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    }
                } catch (error) {
                    console.error('Error en formatearFechaUltimaOperacion:', error);
                    return 'Error al formatear fecha';
                }
            }

            /**
             * =================================================================
             * UTILIDADES CENTRALIZADAS
             * =================================================================
             */
            // Generar UUID con fallback para navegadores antiguos
            function generateUUID() {
                try {
                    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                        const uuid = crypto.randomUUID();
                        if (uuid && typeof uuid === 'string' && uuid.length > 0) {
                            return uuid;
                        }
                    }
                    
                    // Fallback para navegadores antiguos
                    const fallbackUUID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                    
                    if (fallbackUUID && typeof fallbackUUID === 'string' && fallbackUUID.length > 0) {
                        return fallbackUUID;
                    }
                    
                    // √öltimo fallback: timestamp + random
                    return Date.now().toString(36) + Math.random().toString(36).substring(2);
                } catch (error) {
                    console.error('Error al generar UUID:', error);
                    // Fallback de emergencia: timestamp + random
                    return Date.now().toString(36) + Math.random().toString(36).substring(2);
                }
            }
            
            // Normalizaci√≥n centralizada de monedas
            function normalizeMoneda(moneda) {
                // Validar entrada
                if (!moneda || typeof moneda !== 'string') {
                    return 'ARS'; // Valor por defecto
                }
                
                const monedaUpper = moneda.trim().toUpperCase();
                
                // Si ya est√° normalizada, retornar directamente
                const monedasNormalizadas = ['ARS', 'USD', 'EUR', 'BRL', 'GBP'];
                if (monedasNormalizadas.includes(monedaUpper)) {
                    return monedaUpper;
                }
                
                // Mapa de normalizaciones
                const normalizaciones = {
                    'PESO': 'ARS',
                    'EURO': 'EUR',
                    'REAL': 'BRL',
                    'LIBRA': 'GBP'
                };
                
                return normalizaciones[monedaUpper] || monedaUpper;
            }
            
            // Normalizar todas las monedas en un objeto de datos
            function normalizeAllMonedas(data) {
                if (!data || typeof data !== 'object' || Array.isArray(data)) return data;
                
                try {
                    const fields = ['moneda', 'monedaTC', 'monedaBase', 'monedaCobro', 'monedaProfit', 'monedaComision'];
                    fields.forEach(field => {
                        if (data.hasOwnProperty(field) && data[field]) {
                            const normalized = normalizeMoneda(data[field]);
                            if (normalized) {
                                data[field] = normalized;
                            }
                        }
                    });
                    return data;
                } catch (error) {
                    console.error('Error en normalizeAllMonedas:', error);
                    return data;
                }
            }
            
            // Validar entrada num√©rica
            function validateNumericInput(value, min = 0, max = 999999999) {
                if (value === null || value === undefined) return false;
                
                try {
                    const num = safeParseFloat(value);
                    if (isNaN(num) || !isFinite(num) || num < min || num > max) {
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('Error en validateNumericInput:', error);
                    return false;
                }
            }
            
            // Validar fecha
            function isValidDate(dateString) {
                if (!dateString) return false;
                try {
                    // Validar formato b√°sico (YYYY-MM-DD o similar)
                    const dateRegex = /^\d{4}-\d{2}-\d{2}/;
                    if (!dateRegex.test(dateString)) {
                        return false;
                    }
                    
                const date = new Date(dateString);
                    // Verificar que sea una fecha v√°lida y que no sea Invalid Date
                    if (!(date instanceof Date) || isNaN(date.getTime())) {
                        return false;
                    }
                    
                    // Verificar que el string parseado corresponde a una fecha v√°lida
                    // (evitar fechas como "2025-13-45" que se parsean pero son inv√°lidas)
                    const parts = dateString.split('T')[0].split('-');
                    if (parts.length !== 3) return false;
                    
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10);
                    const day = parseInt(parts[2], 10);
                    
                    // Validar rangos razonables
                    if (year < 1900 || year > 2100) return false;
                    if (month < 1 || month > 12) return false;
                    if (day < 1 || day > 31) return false;
                    
                    // Verificar que la fecha parseada coincida con los componentes
                    if (date.getFullYear() !== year || 
                        date.getMonth() !== month - 1 || 
                        date.getDate() !== day) {
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    return false;
                }
            }
            
            // Validar formato de email
            function isValidEmail(email) {
                if (!email || email.trim() === '') return true; // Email opcional
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email.trim());
            }
            
            // Validaci√≥n segura de elementos DOM
            function safeGetElementById(id) {
                if (!id) {
                    console.warn('safeGetElementById: ID no proporcionado');
                    return null;
                }
                try {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.warn(`safeGetElementById: Elemento con ID "${id}" no encontrado`);
                    }
                    return element;
                } catch (error) {
                    console.error(`Error al obtener elemento con ID "${id}":`, error);
                    return null;
                }
            }
            
            // Helper para querySelector con validaci√≥n
            function safeQuerySelector(selector) {
                if (!selector) {
                    console.warn('safeQuerySelector: Selector no proporcionado');
                    return null;
                }
                try {
                    const element = document.querySelector(selector);
                    if (!element) {
                        console.warn(`safeQuerySelector: Elemento con selector "${selector}" no encontrado`);
                    }
                    return element;
                } catch (error) {
                    console.error('safeQuerySelector: Error en selector:', error);
                    return null;
                }
            }
            
            // Funci√≥n de sanitizaci√≥n para prevenir XSS
            function escapeHTML(str) {
                if (str === null || str === undefined) return '';
                if (typeof str !== 'string') {
                    str = String(str);
                }
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            // Funci√≥n para redondear a 2 decimales evitando problemas de floating point
            function roundToTwo(num) {
                // Validar entrada
                if (num === null || num === undefined) return 0;
                
                // Convertir a n√∫mero si es string
                const parsed = typeof num === 'string' ? parseFloat(num) : Number(num);
                
                // Validar que sea un n√∫mero v√°lido
                if (isNaN(parsed) || !isFinite(parsed)) return 0;
                
                // Manejar n√∫meros muy grandes o muy peque√±os
                if (Math.abs(parsed) > Number.MAX_SAFE_INTEGER) {
                    console.warn('roundToTwo: n√∫mero muy grande, puede perder precisi√≥n');
                    return parsed;
                }
                
                // Redondear usando m√©todo seguro
                try {
                    return Number(Math.round(parseFloat(parsed) + 'e+2') + 'e-2');
                } catch (error) {
                    console.error('Error en roundToTwo:', error);
                    // Fallback: usar toFixed
                    return parseFloat(parsed.toFixed(2));
                }
            }
            
            // Constante global para campos num√©ricos (evita duplicaci√≥n)
            const NUMERIC_FIELDS = ['monto', 'tc', 'total', 'montoBase', 'cotizacionCliente', 'cotizacionReal', 'montoCobrado', 'costoReal', 'profit', 'interes', 'lapso', 'comisionValor', 'montoComision'];
            
            // Funci√≥n helper para formatear campos num√©ricos (consolida c√≥digo duplicado)
            function formatNumericFields(fields = NUMERIC_FIELDS, skipReadOnly = true) {
                fields.forEach(fieldName => {
                    const input = document.querySelector(`[name="${fieldName}"]`);
                    if (input && (!skipReadOnly || !input.readOnly) && formData[fieldName]) {
                        const formatted = formatNumberWithThousands(formData[fieldName]);
                        if (formatted && input.value !== formatted) {
                            input.value = formatted;
                        }
                    }
                });
            }
            
            // Divisi√≥n segura de wallet ID (maneja IDs con m√∫ltiples _)
            function parseWalletId(walletValue) {
                // Validar entrada
                if (!walletValue || typeof walletValue !== 'string') {
                    return { wallet: '', type: '' };
                }
                
                // Caso especial para pago mixto
                if (walletValue === 'pago_mixto') {
                    return { wallet: 'pago_mixto', type: '' };
                }
                
                try {
                    // Usar lastIndexOf para obtener el √∫ltimo _ (tipo siempre est√° al final)
                    const lastUnderscore = walletValue.lastIndexOf('_');
                    if (lastUnderscore === -1) {
                        return { wallet: walletValue.trim(), type: '' };
                    }
                    
                    const wallet = walletValue.substring(0, lastUnderscore).trim();
                    const type = walletValue.substring(lastUnderscore + 1).trim();
                    
                    return {
                        wallet: wallet || walletValue, // Si wallet est√° vac√≠o, devolver el valor original
                        type: type
                    };
                } catch (error) {
                    console.error('Error en parseWalletId:', error);
                    return { wallet: walletValue, type: '' };
                }
            }
            
            // Helper para obtener solo el ID de wallet sin el tipo
            function getWalletIdOnly(walletId) {
                if (!walletId || typeof walletId !== 'string') return null;
                if (walletId === 'pago_mixto') return null;
                const parsed = parseWalletId(walletId);
                return parsed.wallet || null;
            }
            
            // Sistema de limpieza de timeouts e intervals
            const activeTimeouts = new Set();
            const activeIntervals = new Set();
            
            function safeSetTimeout(callback, delay) {
                // Validar par√°metros
                if (typeof callback !== 'function') {
                    console.error('safeSetTimeout: callback debe ser una funci√≥n');
                    return null;
                }
                if (typeof delay !== 'number' || delay < 0 || !isFinite(delay)) {
                    console.error('safeSetTimeout: delay debe ser un n√∫mero positivo');
                    return null;
                }
                
                try {
                    const timeoutId = setTimeout(() => {
                        activeTimeouts.delete(timeoutId);
                        try {
                            callback();
                        } catch (error) {
                            console.error('Error en callback de setTimeout:', error);
                        }
                    }, delay);
                    activeTimeouts.add(timeoutId);
                    return timeoutId;
                } catch (error) {
                    console.error('Error al crear setTimeout:', error);
                    return null;
                }
            }
            
            function safeSetInterval(callback, delay) {
                // Validar par√°metros
                if (typeof callback !== 'function') {
                    console.error('safeSetInterval: callback debe ser una funci√≥n');
                    return null;
                }
                if (typeof delay !== 'number' || delay < 0 || !isFinite(delay)) {
                    console.error('safeSetInterval: delay debe ser un n√∫mero positivo');
                    return null;
                }
                
                try {
                    const intervalId = setInterval(() => {
                        try {
                            callback();
                        } catch (error) {
                            console.error('Error en callback de setInterval:', error);
                        }
                    }, delay);
                    activeIntervals.add(intervalId);
                    return intervalId;
                } catch (error) {
                    console.error('Error al crear setInterval:', error);
                    return null;
                }
            }
            
            function clearAllTimeouts() {
                try {
                    activeTimeouts.forEach(id => {
                        if (id !== null && id !== undefined) {
                            clearTimeout(id);
                        }
                    });
                    activeTimeouts.clear();
                } catch (error) {
                    console.error('Error al limpiar timeouts:', error);
                    activeTimeouts.clear();
                }
            }
            
            function clearAllIntervals() {
                try {
                    activeIntervals.forEach(id => {
                        if (id !== null && id !== undefined) {
                            clearInterval(id);
                        }
                    });
                    activeIntervals.clear();
                } catch (error) {
                    console.error('Error al limpiar intervals:', error);
                    activeIntervals.clear();
                }
            }
            
            // Debounce para formateo num√©rico
            const formatDebounceTimers = new Map();
            function debounceFormat(fieldName, callback, delay = 300) {
                // Validar par√°metros
                if (!fieldName || typeof fieldName !== 'string') {
                    console.error('debounceFormat: fieldName debe ser un string');
                    return;
                }
                if (typeof callback !== 'function') {
                    console.error('debounceFormat: callback debe ser una funci√≥n');
                    return;
                }
                if (typeof delay !== 'number' || delay < 0) {
                    delay = 300;
                }
                
                try {
                    // Limpiar timer anterior si existe
                    if (formatDebounceTimers.has(fieldName)) {
                        const oldTimer = formatDebounceTimers.get(fieldName);
                        if (oldTimer !== null && oldTimer !== undefined) {
                            clearTimeout(oldTimer);
                        }
                    }
                    
                    // Crear nuevo timer
                    const timer = safeSetTimeout(() => {
                        formatDebounceTimers.delete(fieldName);
                        try {
                            callback();
                        } catch (error) {
                            console.error('Error en callback de debounceFormat:', error);
                        }
                    }, delay);
                    
                    if (timer !== null) {
                        formatDebounceTimers.set(fieldName, timer);
                    }
                } catch (error) {
                    console.error('Error en debounceFormat:', error);
                }
            }
            
            /**
             * =================================================================
             * L√ìGICA DE C√ÅLCULOS (PRESERVADA COMPLETA DEL ORIGINAL)
             * =================================================================
             */
            function safeParseFloat(value, defaultValue = 0, allowNegative = false) {
                // Validar entrada
                if (value === null || value === undefined) return defaultValue;
                
                // Si ya es un n√∫mero v√°lido, retornarlo directamente (con validaciones)
                if (typeof value === 'number') {
                    if (isNaN(value) || !isFinite(value)) return defaultValue;
                    if (!allowNegative && value < 0) return defaultValue;
                    return value;
                }
                
                // Convertir a string y eliminar espacios
                let str = String(value).trim();
                
                // Si el string est√° vac√≠o despu√©s de trim, retornar defaultValue
                if (str === '' || str === '-') return defaultValue;
                
                // Manejar notaci√≥n cient√≠fica (ej: "1e5", "1.5e-3", "1E+10")
                const scientificNotationRegex = /^[-+]?(\d+\.?\d*|\.\d+)[eE][-+]?\d+$/;
                if (scientificNotationRegex.test(str)) {
                    const num = parseFloat(str);
                    if (!isNaN(num) && isFinite(num)) {
                        // Si no se permiten negativos y el n√∫mero es negativo, retornar defaultValue
                        if (!allowNegative && num < 0) {
                            return defaultValue;
                        }
                        return num;
                    }
                }
                
                // Guardar si es negativo
                const isNegative = str.startsWith('-');
                // Eliminar s√≠mbolos de moneda y caracteres no num√©ricos (excepto punto, coma y guion al inicio)
                str = str.replace(/[^\d.,-]/g, '');
                // Si no se permite negativo, eliminar el guion
                if (!allowNegative && str.startsWith('-')) {
                    str = str.substring(1);
                }
                // Eliminar separadores de miles (puntos que no son decimales)
                // Si hay coma, los puntos son miles. Si hay punto y no coma, el punto es decimal
                const hasComa = str.includes(',');
                const hasPunto = str.includes('.');
                if (hasComa) {
                    // Formato con coma decimal: eliminar todos los puntos (son miles)
                    str = str.replace(/\./g, '');
                    // Reemplazar coma decimal por punto
                    str = str.replace(',', '.');
                } else if (hasPunto) {
                    // Formato con punto: verificar si es decimal o miles
                    // Si hay m√°s de un punto, los primeros son miles
                    const puntos = str.split('.');
                    if (puntos.length > 2) {
                        // M√∫ltiples puntos = separadores de miles, el √∫ltimo es decimal
                        str = puntos.slice(0, -1).join('') + '.' + puntos[puntos.length - 1];
                    }
                    // Si hay un solo punto, asumimos que es decimal (ya est√° bien)
                }
                // Restaurar signo negativo si estaba al inicio y se permite
                if (allowNegative && isNegative && !str.startsWith('-')) {
                    str = '-' + str;
                }
                
                // Validar que el string no est√© vac√≠o despu√©s de procesamiento
                if (str === '' || str === '-') return defaultValue;
                
                try {
                    const parsed = parseFloat(str);
                    
                    // Validar resultado
                    if (isNaN(parsed) || !isFinite(parsed)) {
                        return defaultValue;
                    }
                    
                    // Validar negativos si no se permiten
                    if (!allowNegative && parsed < 0) {
                        return defaultValue;
                    }
                    
                    return parsed;
                } catch (error) {
                    console.error('Error en safeParseFloat:', error);
                    return defaultValue;
                }
            }
            
            function formatNumberWithThousands(value, allowNegative = false) {
                if (!value && value !== 0) return '';
                const num = safeParseFloat(value, 0, allowNegative);
                if (isNaN(num)) return '';
                // Permitir mostrar el valor 0
                // Validar que sea realmente un n√∫mero
                if (typeof num !== 'number' || !isFinite(num)) return '';
                
                // Para n√∫meros muy grandes o muy peque√±os, usar notaci√≥n cient√≠fica
                const absNum = Math.abs(num);
                if (absNum > 0 && (absNum >= 1e15 || absNum < 1e-6)) {
                    // Usar notaci√≥n cient√≠fica para n√∫meros extremos
                    return num.toExponential(2);
                }
                
                // Formatear con separadores de miles (punto) y coma decimal
                // Usar siempre 2 decimales para n√∫meros con decimales, 0 para enteros
                const hasDecimals = (Math.abs(num) % 1) !== 0;
                const isNegative = num < 0;
                try {
                    // Usar toLocaleString con opciones espec√≠ficas para mantener precisi√≥n
                    const formatted = absNum.toLocaleString('es-ES', { 
                        minimumFractionDigits: hasDecimals ? 2 : 0, 
                        maximumFractionDigits: 2,
                        useGrouping: true
                    });
                    return isNegative ? '-' + formatted : formatted;
                } catch (error) {
                    console.error('Error al formatear n√∫mero:', error);
                    // Fallback: formateo manual para mantener precisi√≥n
                    const fixed = hasDecimals ? absNum.toFixed(2) : Math.round(absNum).toString();
                    const parts = fixed.split('.');
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    return isNegative ? '-' + parts.join(',') : parts.join(',');
                }
            }
            
            function calculateTotal() {
                try {
                    // Validar que los valores necesarios existan
                const subOp = String(formData.subOperacion || '').trim();
                const monedaRaw = String(formData.moneda || '').trim();
                const moneda = normalizeMoneda(monedaRaw); // Normalizar PESO -> ARS
                const monto = safeParseFloat(formData.monto);
                const tc = safeParseFloat(formData.tc);
                
                    // Validaciones mejoradas
                    if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                        formData.total = '';
                        return;
                    }
                    if (!tc || tc <= 0 || isNaN(tc) || !isFinite(tc)) {
                        formData.total = '';
                        return;
                    }
                
                    // Validar que la moneda est√© seleccionada
                    if (!moneda) {
                        formData.total = '';
                        return;
                    }
                    
                    // Validar que el tipo de cambio sea positivo
                    if (tc < 0) {
                        if (typeof showToast === 'function') {
                            showToast('El tipo de cambio no puede ser negativo', 'error');
                        }
                        formData.total = '';
                        return;
                    }
                    
                    // L√≥gica de c√°lculo seg√∫n el tipo de operaci√≥n y moneda
                    // Si es VENTA y la moneda vendida es ARS, dividir en lugar de multiplicar
                    // Si es COMPRA y la moneda comprada es ARS, tambi√©n dividir
                const esVentaConARS = subOp === 'VENTA' && moneda === 'ARS';
                const esCompraConARS = subOp === 'COMPRA' && moneda === 'ARS';
                
                    let resultado;
                if (esVentaConARS || esCompraConARS) {
                        // Cuando operamos con ARS, dividimos para obtener la cantidad en la otra moneda
                        // Ejemplo: Vendo 1000 ARS a TC 1000 ‚Üí Recibo 1 USD
                        resultado = monto / tc;
                } else {
                        // Para otras operaciones (venta/compra de otras monedas), multiplicar
                        // Ejemplo: Vendo 100 USD a TC 1000 ‚Üí Recibo 100000 ARS
                        resultado = monto * tc;
                    }
                    
                    // Validar que el resultado sea v√°lido
                    if (!isFinite(resultado) || isNaN(resultado)) {
                        console.error('Error en c√°lculo de total: resultado inv√°lido', { monto, tc, resultado });
                        formData.total = '';
                        if (typeof showToast === 'function') {
                            showToast('Error al calcular el total', 'error');
                        }
                        return;
                    }
                    
                    formData.total = roundToTwo(resultado).toFixed(2);
                } catch (error) {
                    console.error('Error en calculateTotal:', error);
                    formData.total = '';
                    if (typeof showToast === 'function') {
                        showToast('Error al calcular el total', 'error');
                    }
                }
            }
            
            function calculatePrestamo() {
                const monto = safeParseFloat(formData.monto);
                const interes = safeParseFloat(formData.interes);
                const lapso = safeParseFloat(formData.lapso);
                
                // Validar que los valores sean v√°lidos
                if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                    formData.total = '';
                    formData.interesCalculado = '';
                    return;
                }
                if (!interes || interes < 0 || isNaN(interes) || !isFinite(interes)) {
                    formData.total = '';
                    formData.interesCalculado = '';
                    return;
                }
                if (!lapso || lapso <= 0 || isNaN(lapso) || !isFinite(lapso)) {
                    formData.total = '';
                    formData.interesCalculado = '';
                    return;
                }
                
                // Calcular inter√©s: (monto * inter√©s anual * d√≠as) / (365 * 100)
                // El inter√©s se calcula pero NO se suma al monto inicial todav√≠a
                // El total es el monto que prestamos (salida), el inter√©s se pagar√° cuando se devuelva
                let interesTotal = 0;
                try {
                    interesTotal = (monto * interes * lapso) / (365 * 100);
                    // Validar resultado
                    if (!isFinite(interesTotal) || isNaN(interesTotal)) {
                        console.error('Error en c√°lculo de inter√©s: resultado inv√°lido', { monto, interes, lapso });
                        formData.total = '';
                        formData.interesCalculado = '';
                        return;
                    }
                } catch (error) {
                    console.error('Error al calcular inter√©s:', error);
                    formData.total = '';
                    formData.interesCalculado = '';
                    return;
                }
                
                // El total a mostrar es el monto prestado (el inter√©s se pagar√° despu√©s)
                // Pero mostramos tambi√©n el inter√©s calculado para referencia
                formData.total = roundToTwo(monto).toFixed(2);
                
                // Guardar el inter√©s calculado en un campo separado si existe
                if (formData.hasOwnProperty('interesCalculado')) {
                    formData.interesCalculado = roundToTwo(interesTotal).toFixed(2);
                }
            }
            
            function calculateArbitraje() {
                const montoBase = safeParseFloat(formData.montoBase);
                const cotizacionCliente = safeParseFloat(formData.cotizacionCliente);
                const montoCobrado = safeParseFloat(formData.montoCobrado);
                const cotizacionReal = safeParseFloat(formData.cotizacionReal);
                const costoReal = safeParseFloat(formData.costoReal);

                // Validar valores antes de calcular
                if (isNaN(montoBase) || !isFinite(montoBase)) montoBase = 0;
                if (isNaN(cotizacionCliente) || !isFinite(cotizacionCliente)) cotizacionCliente = 0;
                if (isNaN(montoCobrado) || !isFinite(montoCobrado)) montoCobrado = 0;
                if (isNaN(cotizacionReal) || !isFinite(cotizacionReal)) cotizacionReal = 0;
                if (isNaN(costoReal) || !isFinite(costoReal)) costoReal = 0;
                
                // L√ìGICA BIDIRECCIONAL basada en lastEditedField
                // Primera ecuaci√≥n: Monto Base √ó Cotizaci√≥n Cliente = Monto Cobrado
                try {
                    if (lastEditedField === 'montoBase') {
                        if (cotizacionCliente > 0 && !isNaN(cotizacionCliente) && isFinite(cotizacionCliente)) {
                            const resultado = montoBase * cotizacionCliente;
                            if (isFinite(resultado) && !isNaN(resultado)) {
                                formData.montoCobrado = roundToTwo(resultado).toFixed(2);
                            }
                        }
                    } else if (lastEditedField === 'cotizacionCliente') {
                        if (montoBase > 0 && !isNaN(montoBase) && isFinite(montoBase)) {
                            const resultado = montoBase * cotizacionCliente;
                            if (isFinite(resultado) && !isNaN(resultado)) {
                                formData.montoCobrado = roundToTwo(resultado).toFixed(2);
                            }
                        }
                    } else if (lastEditedField === 'montoCobrado') {
                        if (montoBase > 0 && !isNaN(montoBase) && isFinite(montoBase) && montoBase !== 0) {
                            const resultado = montoCobrado / montoBase;
                            if (isFinite(resultado) && !isNaN(resultado)) {
                                formData.cotizacionCliente = roundToTwo(resultado).toFixed(2);
                            }
                        } else if (cotizacionCliente > 0 && !isNaN(cotizacionCliente) && isFinite(cotizacionCliente) && cotizacionCliente !== 0) {
                            const resultado = montoCobrado / cotizacionCliente;
                            if (isFinite(resultado) && !isNaN(resultado)) {
                                formData.montoBase = roundToTwo(resultado).toFixed(2);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error en primera ecuaci√≥n de arbitraje:', error);
                }

                // Segunda ecuaci√≥n: Monto Base √ó Cotizaci√≥n Real = Costo Real
                const montoBaseFinal = safeParseFloat(formData.montoBase);
                const costoRealParsed = safeParseFloat(formData.costoReal);
                
                // Validar valores
                const montoBaseValid = !isNaN(montoBaseFinal) && isFinite(montoBaseFinal) && montoBaseFinal > 0;
                const cotizacionRealValid = !isNaN(cotizacionReal) && isFinite(cotizacionReal) && cotizacionReal > 0;
                const costoRealParsedValid = !isNaN(costoRealParsed) && isFinite(costoRealParsed) && costoRealParsed > 0;
                
                try {
                    if (lastEditedField === 'montoBase' || lastEditedField === 'cotizacionReal') {
                        if (montoBaseValid && cotizacionRealValid) {
                            const resultado = montoBaseFinal * cotizacionReal;
                            if (isFinite(resultado) && !isNaN(resultado)) {
                                formData.costoReal = roundToTwo(resultado).toFixed(2);
                            }
                        }
                    } else if (lastEditedField === 'costoReal') {
                        if (montoBaseValid && montoBaseFinal !== 0) {
                            const resultado = costoRealParsed / montoBaseFinal;
                            if (isFinite(resultado) && !isNaN(resultado)) {
                                formData.cotizacionReal = roundToTwo(resultado).toFixed(2);
                            }
                        } else if (cotizacionRealValid && cotizacionReal !== 0 && costoRealParsedValid) {
                            const resultado = costoRealParsed / cotizacionReal;
                            if (isFinite(resultado) && !isNaN(resultado)) {
                                formData.montoBase = roundToTwo(resultado).toFixed(2);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error en segunda ecuaci√≥n de arbitraje:', error);
                }

                // Calcular Profit si tengo montoCobrado y costoReal
                const montoCobradoFinal = safeParseFloat(formData.montoCobrado);
                const costoRealFinal = safeParseFloat(formData.costoReal);
                
                // Validar que ambos valores sean positivos y v√°lidos antes de calcular
                const montoCobradoValid = montoCobradoFinal > 0 && !isNaN(montoCobradoFinal) && isFinite(montoCobradoFinal);
                const costoRealValid = costoRealFinal > 0 && !isNaN(costoRealFinal) && isFinite(costoRealFinal);
                
                if (montoCobradoValid && costoRealValid) {
                    try {
                        const profitCalculado = montoCobradoFinal - costoRealFinal;
                        if (isFinite(profitCalculado) && !isNaN(profitCalculado)) {
                            formData.profit = roundToTwo(profitCalculado).toFixed(2);
                        } else {
                            formData.profit = '';
                        }
                    } catch (error) {
                        console.error('Error al calcular profit:', error);
                        formData.profit = '';
                    }
                } else {
                    // Si los valores no son v√°lidos, limpiar profit
                    formData.profit = '';
                }

                // Actualizar campos en el DOM
                const montoCobradoInput = safeQuerySelector('[name="montoCobrado"]');
                const cotizacionClienteInput = safeQuerySelector('[name="cotizacionCliente"]');
                const montoBaseInput = safeQuerySelector('[name="montoBase"]');
                const cotizacionRealInput = safeQuerySelector('[name="cotizacionReal"]');
                const costoRealInput = safeQuerySelector('[name="costoReal"]');
                const profitInput = safeQuerySelector('[name="profit"]');

                if (montoCobradoInput) montoCobradoInput.value = formData.montoCobrado || '';
                if (cotizacionClienteInput) cotizacionClienteInput.value = formData.cotizacionCliente || '';
                if (montoBaseInput) montoBaseInput.value = formData.montoBase || '';
                if (cotizacionRealInput) cotizacionRealInput.value = formData.cotizacionReal || '';
                if (costoRealInput) costoRealInput.value = formData.costoReal || '';
                if (profitInput) profitInput.value = formData.profit || '';
            }

            function calculateComisionAndTotal() {
                const monto = safeParseFloat(formData.monto);
                const comisionValor = safeParseFloat(formData.comisionValor);
                let montoComision = 0;

                // Validar que los valores sean v√°lidos
                if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                    formData.montoComision = '';
                    if (formData.operacion === 'CUENTAS_CORRIENTES' && ['INGRESO', 'EGRESO'].includes(formData.subOperacion)) {
                        formData.total = '';
                    }
                    return;
                }

                if (formData.comisionTipo === 'porcentaje') {
                    // Validar que el porcentaje est√© entre 0 y 100
                    if (isNaN(comisionValor) || !isFinite(comisionValor) || comisionValor < 0 || comisionValor > 100) {
                        if (comisionValor < 0 || comisionValor > 100) {
                            showToast('El porcentaje de comisi√≥n debe estar entre 0 y 100', 'error');
                        }
                        formData.montoComision = '';
                        return;
                    }
                    try {
                        montoComision = (monto * comisionValor) / 100;
                        if (!isFinite(montoComision) || isNaN(montoComision)) {
                            formData.montoComision = '';
                            return;
                        }
                        formData.monedaComision = formData.moneda;
                    } catch (error) {
                        console.error('Error al calcular comisi√≥n porcentual:', error);
                        formData.montoComision = '';
                        return;
                    }
                } else {
                    // Validar que la comisi√≥n fija sea positiva y v√°lida
                    if (isNaN(comisionValor) || !isFinite(comisionValor) || comisionValor < 0) {
                        if (comisionValor < 0) {
                            showToast('La comisi√≥n fija no puede ser negativa', 'error');
                        }
                        formData.montoComision = '';
                        return;
                    }
                    try {
                        montoComision = comisionValor;
                        if (!isFinite(montoComision) || isNaN(montoComision)) {
                            formData.montoComision = '';
                            return;
                        }
                    } catch (error) {
                        console.error('Error al calcular comisi√≥n fija:', error);
                        formData.montoComision = '';
                        return;
                    }
                }
                
                try {
                    formData.montoComision = roundToTwo(montoComision).toFixed(2);
                } catch (error) {
                    console.error('Error al formatear montoComision:', error);
                    formData.montoComision = '';
                }
                
                if (formData.operacion === 'CUENTAS_CORRIENTES' && ['INGRESO', 'EGRESO'].includes(formData.subOperacion)) {
                    try {
                        const totalCalculado = monto + montoComision;
                        if (isFinite(totalCalculado) && !isNaN(totalCalculado)) {
                            formData.total = roundToTwo(totalCalculado).toFixed(2);
                        } else {
                            formData.total = '';
                        }
                    } catch (error) {
                        console.error('Error al calcular total con comisi√≥n:', error);
                        formData.total = '';
                    }
                }
            }

            /**
             * =================================================================
             * RENDERIZADO DIN√ÅMICO DE LA INTERFAZ
             * =================================================================
             */
            function getDynamicFields() {
                const { operacion, subOperacion } = formData;
                if (!operacion || !subOperacion) return '';
                const key = `${operacion}_${subOperacion}`;
                
                const fieldsConfig = {
                    'TRANSACCIONES_COMPRA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Compramos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Comprada</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se recibe</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Pago</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet desde donde se paga</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Pagar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'TRANSACCIONES_VENTA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Vendemos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Vendida</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde sale</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Cobro</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se cobra</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Cobrar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'TRANSACCIONES_ARBITRAJE': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto Base</label><input type="text" inputmode="numeric" class="form-input" name="montoBase" value="${formData.montoBase || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Base</label><div class="moneda-buttons-container" id="monedaBaseButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de Origen (Base)</label><div class="wallet-buttons-container" id="walletBaseButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Cotizaci√≥n Cliente</label><input type="text" inputmode="numeric" class="form-input" name="cotizacionCliente" value="${formData.cotizacionCliente || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Cotizaci√≥n Real</label><input type="text" inputmode="numeric" class="form-input" name="cotizacionReal" value="${formData.cotizacionReal || ''}" placeholder="0.00" step="0.01"></div>
                        </div>
                        <div class="form-grid">
                             <div class="form-group"><label class="form-label">Monto Cobrado</label><input type="text" inputmode="numeric" class="form-input" name="montoCobrado" value="${formData.montoCobrado || ''}" placeholder="0.00" step="0.01"></div>
                             <div class="form-group"><label class="form-label">Moneda de Cobro</label><div class="moneda-buttons-container" id="monedaCobroButtons"></div></div>
                        </div>
                         <div class="field-separator"></div>
                         <div class="form-grid">
                            <div class="form-group"><label class="form-label">Costo Real</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="costoReal" value="${formData.costoReal || ''}" readonly></div>
                            <div class="form-group"><label class="form-label">Profit</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="profit" value="${formData.profit || ''}" readonly></div>
                        </div>
                        <div class="form-grid">
                             <div class="form-group"><label class="form-label">Moneda del Profit</label><div class="moneda-buttons-container" id="monedaProfitButtons"></div></div>
                             <div class="form-group"><label class="form-label">Wallet Destino (Profit)</label><div class="wallet-buttons-container" id="walletProfitButtons"></div></div>
                        </div>`,
                    'CUENTAS_CORRIENTES_INGRESO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto Ingreso</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde ingresa</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-group"><label class="form-label">Comisi√≥n</label><div style="display: flex; gap: 10px;"><button type="button" class="btn-option ${formData.comisionTipo === 'porcentaje' ? 'active' : ''}" id="comisionPorcentajeBtn" style="flex: 1;">%</button><button type="button" class="btn-option ${formData.comisionTipo === 'fijo' ? 'active' : ''}" id="comisionFijoBtn" style="flex: 1;">$</button></div></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Valor Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input" name="comisionValor" value="${formData.comisionValor || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group ${formData.comisionTipo === 'porcentaje' ? 'hidden' : ''}" id="monedaComisionContainer"><label class="form-label">Moneda Comisi√≥n</label><div class="moneda-buttons-container" id="monedaComisionButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Monto Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="montoComision" value="${formData.montoComision || ''}" readonly></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_EGRESO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto Egreso</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde egresa</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-group"><label class="form-label">Comisi√≥n</label><div style="display: flex; gap: 10px;"><button type="button" class="btn-option ${formData.comisionTipo === 'porcentaje' ? 'active' : ''}" id="comisionPorcentajeBtn" style="flex: 1;">%</button><button type="button" class="btn-option ${formData.comisionTipo === 'fijo' ? 'active' : ''}" id="comisionFijoBtn" style="flex: 1;">$</button></div></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Valor Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input" name="comisionValor" value="${formData.comisionValor || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group ${formData.comisionTipo === 'porcentaje' ? 'hidden' : ''}" id="monedaComisionContainer"><label class="form-label">Moneda Comisi√≥n</label><div class="moneda-buttons-container" id="monedaComisionButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Monto Comisi√≥n</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="montoComision" value="${formData.montoComision || ''}" readonly></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_COMPRA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Compramos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Comprada</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se recibe</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Pago</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet desde donde se paga</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Pagar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_VENTA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto que Vendemos</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda Vendida</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde sale</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div class="field-separator"></div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Tipo de Cambio (TC)</label><input type="text" inputmode="numeric" class="form-input" name="tc" value="${formData.tc || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda de Cobro</label><div class="moneda-buttons-container" id="monedaTCButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde se cobra</label><div class="wallet-buttons-container" id="walletTCButtons"></div></div>
                        <div class="form-group" style="margin-top: 24px;"><label class="form-label">Total a Cobrar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>`,
                    'CUENTAS_CORRIENTES_ARBITRAJE': `<p style="color: var(--text-secondary);">Arbitraje para Cuentas Corrientes pendiente de definici√≥n.</p>`,
                    'WALLET_INGRESO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto de Ingreso</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet Destino</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_SALIDA': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto de Salida</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet Origen</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_PRESTAMO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto del Pr√©stamo</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde sale</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_DEVOLUCION': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto de Devoluci√≥n</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet donde ingresa</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_MOV ENTRE CUENTAS': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="field-separator"></div>
                        <div class="form-group"><label class="form-label">Wallet de Salida</label><div class="wallet-buttons-container" id="cuentaSalidaButtons"></div></div>
                        <div class="form-group"><label class="form-label">Wallet de Ingreso</label><div class="wallet-buttons-container" id="cuentaIngresoButtons"></div></div>`,
                    'ADMINISTRATIVAS_GASTO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto del Gasto</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de Origen</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                     'ADMINISTRATIVAS_AJUSTE': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto del Ajuste (positivo o negativo)</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00 o -0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet a ajustar</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-top: 12px; border: 1px solid var(--border-color);">
                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">üí° <strong>Nota:</strong> Usa valores positivos para aumentar el saldo y negativos para disminuirlo.</p>
                        </div>`,
                    'PRESTAMISTAS_PRESTAMO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto del Pr√©stamo</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                         <div class="form-grid">
                            <div class="form-group"><label class="form-label">% Inter√©s Anual</label><input type="text" inputmode="numeric" class="form-input" name="interes" value="${formData.interes || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Lapso (d√≠as)</label><input type="text" inputmode="numeric" class="form-input" name="lapso" value="${formData.lapso || ''}" placeholder="30"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de donde sale</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>
                        <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-top: 12px; border: 1px solid var(--border-color);">
                            <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 8px 0;">üí° <strong>Nota:</strong> Nosotros prestamos el monto. El inter√©s se calcular√° y se pagar√° cuando se devuelva el pr√©stamo.</p>
                            <div class="form-group" style="margin: 0;"><label class="form-label">Monto a Prestar</label><input type="text" inputmode="numeric" class="form-input form-input-readonly" name="total" value="${formData.total || ''}" readonly></div>
                        </div>`,
                    'PRESTAMISTAS_RETIRO': `
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Monto a Retirar</label><input type="text" inputmode="numeric" class="form-input" name="monto" value="${formData.monto || ''}" placeholder="0.00" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Moneda</label><div class="moneda-buttons-container" id="monedaButtons"></div></div>
                        </div>
                        <div class="form-group"><label class="form-label">Wallet de Origen</label><div class="wallet-buttons-container" id="walletCompraButtons"></div></div>`,
                    'WALLET_CREAR WALLET': `
                        <div class="form-group"><label class="form-label">C√≥digo/ID de la Wallet (√∫nico)</label><input type="text" class="form-input" id="walletId" placeholder="ej: W1, JUAN, PROV_X"></div>
                        <div class="form-group"><label class="form-label">Nombre de la Wallet (descriptivo)</label><input type="text" class="form-input" id="walletNombre" placeholder="ej: Cliente Juan P√©rez"></div>
                        <div class="form-group"><label class="form-label">Tipo de Wallet</label><div style="display: flex; gap: 15px; margin-top: 10px;"><label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="walletTipoEfectivo" style="width: 18px; height: 18px; cursor: pointer;"><span style="color: var(--text-primary);">Efectivo</span></label><label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="walletTipoDigital" style="width: 18px; height: 18px; cursor: pointer;"><span style="color: var(--text-primary);">Digital</span></label></div></div>
                        <div class="form-group"><label class="form-label">Monedas que Opera</label><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;" id="walletMonedasCheckboxes">${monedas.map(m => `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" value="${m.value}" class="wallet-moneda-checkbox" style="width: 18px; height: 18px; cursor: pointer;"><span style="color: var(--text-primary); font-size: 13px;">${m.label}</span></label>`).join('')}</div></div>
                        <div style="margin-top: 30px;"><button type="button" class="btn-submit" id="saveWalletBtn" style="width: 100%;">Guardar Wallet</button></div>`,
                    'WALLET_LISTA DE WALLETS': `<div id="walletsListContainer"></div>`
                };
                return fieldsConfig[key] || `<p style="color: var(--text-secondary);">Configuraci√≥n de campos para ${operacion} > ${subOperacion} no encontrada.</p>`;
            }
            
            function renderOperationsModule() {
                const titulo = editingMovimientoId ? 'üí± Editar Operaci√≥n Financiera' : 'üí± Nueva Operaci√≥n Financiera';
                return `
                    <div class="operations-container">
                        <div class="form-card">
                            <div class="form-header">
                                <button type="button" class="btn-back" onclick="window.goBack()" title="Volver">‚Üê Volver</button>
                                <h2 class="form-title">${titulo}</h2>
                                <div style="width: 100px;"></div>
                            </div>
                            <form id="operationsForm">
                                <div class="form-grid">
                                    <div class="form-group" style="grid-column: 1 / -1;"><label class="form-label" for="fecha">Fecha y D√≠a</label><div class="fecha-dia-group"><input type="date" class="form-input" id="fecha" name="fecha" value="${formData.fecha}" required><input type="text" class="form-input" id="nombreDia" name="nombreDia" value="${formData.nombreDia || ''}" readonly></div></div>
                                </div>
                                <div class="form-group"><label class="form-label section-title">Paso 1: Seleccionar Operaci√≥n</label><div class="button-grid" id="operationButtons"></div></div>
                                <div class="form-group ${!formData.operacion ? 'hidden' : ''}" id="subOperationContainer"><label class="form-label section-title">Paso 2: Seleccionar Tipo</label><div class="button-grid" id="subOperationButtons"></div></div>
                                <div class="form-group hidden" id="clienteContainer" style="margin-bottom: 20px;"><label class="form-label" for="cliente">Cliente</label><div class="input-with-button"><select class="form-select" id="cliente" name="cliente" required><option value="">Seleccionar cliente...</option>${getClientes().map(c => `<option value="${escapeHTML(c.id)}" ${formData.cliente === c.id ? 'selected' : ''}>${escapeHTML(c.nombre)}${c.documento ? ' - ' + escapeHTML(c.documento) : ''}</option>`).join('')}</select><button type="button" class="btn-add" id="addClientBtn" title="Crear nuevo cliente">+</button></div></div>
                                <div class="form-group hidden" id="detalleContainer" style="margin-bottom: 32px;"><label class="form-label" for="detalle">Detalle</label><textarea class="form-textarea" id="detalle" name="detalle" placeholder="Descripci√≥n de la operaci√≥n">${escapeHTML(formData.detalle || '')}</textarea></div>
                                <div class="dynamic-fields-container" id="dynamicFieldsContainer"></div>
                                <div id="mixedPaymentsContainer" class="${formData.isMixedPaymentActive ? '' : 'hidden'}"></div>
                                <div class="form-grid ${['WALLET', 'ADMINISTRATIVAS'].includes(formData.operacion) ? 'hidden' : ''}" id="estadoPorContainer">
                                    <div class="form-group"><label class="form-label" for="estado">Estado</label><select class="form-select" id="estado" name="estado">${estados.map(e => `<option value="${escapeHTML(e.value)}" ${formData.estado === e.value ? 'selected' : ''}>${escapeHTML(e.label)}</option>`).join('')}</select></div>
                                    <div class="form-group"><label class="form-label" for="por">Por</label><input type="text" class="form-input" id="por" name="por" value="${formData.por || ''}" placeholder="Nombre"></div>
                                </div>
                                ${formData.subOperacion !== 'CREAR WALLET' && formData.subOperacion !== 'LISTA DE WALLETS' ? '<div class="form-actions"><button type="button" class="btn-cancel" id="cancelBtn">Cancelar</button><button type="submit" class="btn-submit">Guardar Operaci√≥n</button></div>' : ''}
                            </form>
                        </div>
                    </div>`;
            }

            function renderButtonSet(containerId, dataKey, items, cssClass = 'btn-option') {
                const container = document.getElementById(containerId);
                if (!container) return;
                const isOperation = items.length > 0 && items[0].subMenu;
                
                // Obtener el valor actual - asegurarse de que sea string para comparaci√≥n exacta
                const currentValue = String(formData[dataKey] || '');
                
                // Limpiar contenedor completamente
                container.innerHTML = '';
                
                // Crear funci√≥n handler √∫nica para este grupo
                const handleButtonClick = (selectedValue, clickedButton) => {
                    // SIEMPRE desactivar TODOS los botones del contenedor primero
                    // Usar querySelectorAll para obtener TODOS los botones, sin importar la clase
                    const allButtons = container.querySelectorAll('button');
                    allButtons.forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Activar solo el bot√≥n clickeado
                    clickedButton.classList.add('active');
                    formData[dataKey] = selectedValue;
                    
                    // Verificaci√≥n adicional: asegurar que solo este bot√≥n est√© activo
                    const stillActive = container.querySelectorAll('.active');
                    if (stillActive.length > 1) {
                        stillActive.forEach(b => {
                            if (b !== clickedButton) {
                                b.classList.remove('active');
                            }
                        });
                    }
                    
                    if (dataKey === 'operacion') handleOperationChange(selectedValue);
                    else if (dataKey === 'subOperacion') handleSubOperationChange(selectedValue);
                    else updateCalculatedFieldsAndUI();
                    saveFormState();
                };
                
                // Crear botones con onclick directo para evitar listeners duplicados
                items.forEach(item => {
                    const value = isOperation ? item.key : item.value;
                    const label = isOperation ? `${item.icon} ${item.key.replace('_', ' ')}` : item.label;
                    // Comparaci√≥n estricta con string
                    const isActive = String(value) === currentValue;
                    
                    const button = document.createElement('button');
                    button.type = 'button';
                    // Asegurarse de que solo este bot√≥n tenga 'active' si coincide
                    button.className = cssClass + (isActive ? ' active' : '');
                    button.dataset.value = value;
                    button.textContent = label;
                    button.tabIndex = 0; // Hacer navegable con teclado
                    
                    // Usar onclick directo para evitar acumulaci√≥n de listeners
                    button.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleButtonClick(value, button);
                    };
                    
                    container.appendChild(button);
                });
                
                // Verificaci√≥n final: FORZAR que solo UN bot√≥n est√© activo
                const activeButtons = container.querySelectorAll('.active');
                if (activeButtons.length > 1) {
                    // Si hay m√∫ltiples activos, desactivar TODOS primero
                    activeButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Luego activar solo el que coincide con currentValue (si existe)
                    if (currentValue) {
                        const correctButton = container.querySelector(`[data-value="${currentValue}"]`);
                        if (correctButton) {
                            correctButton.classList.add('active');
                        }
                    }
                } else if (activeButtons.length === 0 && currentValue) {
                    // Si no hay ninguno activo pero hay un valor, activarlo
                    const correctButton = container.querySelector(`[data-value="${currentValue}"]`);
                    if (correctButton) {
                        correctButton.classList.add('active');
                    }
                }
            }
            
            /**
             * =================================================================
             * MANEJO DE L√ìGICA Y EVENTOS DEL FORMULARIO
             * =================================================================
             */
            function handleOperationChange(operation) {
                formData.subOperacion = '';
                
                // Limpiar estado de edici√≥n de wallet si existe
                walletEditandoId = null;
                
                // LIMPIAR TODOS los contenedores de campos din√°micos
                const dynamicContainer = document.getElementById('dynamicFieldsContainer');
                if (dynamicContainer) {
                    dynamicContainer.innerHTML = '';
                }
                
                const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                if (mixedPaymentsContainer) {
                    mixedPaymentsContainer.innerHTML = '';
                    mixedPaymentsContainer.classList.add('hidden');
                }
                
                // Resetear estado de pagos mixtos
                formData.isMixedPaymentActive = false;
                formData.mixedPayments = [];
                
                // Ocultar contenedores que no aplican
                document.getElementById('clienteContainer')?.classList.add('hidden');
                
                // Ocultar campo Detalle al cambiar la operaci√≥n principal
                const detalleContainer = document.getElementById('detalleContainer');
                if (detalleContainer) {
                    detalleContainer.classList.add('hidden');
                }
                
                // Renderizar suboperaciones
                const subOpContainer = document.getElementById('subOperationContainer');
                if (subOpContainer) {
                    const subOps = operaciones[operation].subMenu.map(sub => ({ value: sub, label: sub }));
                    subOpContainer.classList.remove('hidden');
                    renderButtonSet('subOperationButtons', 'subOperacion', subOps);
                }
            }

            function handleSubOperationChange(subOperation) {
                const dynamicContainer = document.getElementById('dynamicFieldsContainer');
                const clienteContainer = document.getElementById('clienteContainer');
                const estadoPorContainer = document.getElementById('estadoPorContainer');
                const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                const detalleContainer = document.getElementById('detalleContainer');
                
                // PRIMERO: Limpiar completamente todos los contenedores
                if (dynamicContainer) {
                    dynamicContainer.innerHTML = '';
                }
                
                if (mixedPaymentsContainer) {
                    mixedPaymentsContainer.innerHTML = '';
                    mixedPaymentsContainer.classList.add('hidden');
                }
                
                // Resetear pagos mixtos si no aplica
                if (subOperation !== 'VENTA' && subOperation !== 'COMPRA') {
                    formData.isMixedPaymentActive = false;
                    formData.mixedPayments = [];
                }
                
                // LUEGO: Mostrar/ocultar contenedores seg√∫n corresponda
                if (clienteContainer) {
                    if (['TRANSACCIONES', 'CUENTAS_CORRIENTES', 'PRESTAMISTAS'].includes(formData.operacion)) {
                        clienteContainer.classList.remove('hidden');
                        // Actualizar select de clientes cuando se muestra
                        updateClientesSelect();
                    } else {
                        clienteContainer.classList.add('hidden');
                    }
                }
                
                if (estadoPorContainer) {
                    if (['WALLET', 'ADMINISTRATIVAS'].includes(formData.operacion)) {
                         estadoPorContainer.classList.add('hidden');
                    } else {
                        estadoPorContainer.classList.remove('hidden');
                    }
                }
                
                // Mostrar/ocultar campo Detalle seg√∫n la operaci√≥n y sub-operaci√≥n
                if (detalleContainer) {
                    // Operaciones que necesitan el campo Detalle:
                    // - TRANSACCIONES: COMPRA, VENTA, ARBITRAJE
                    // - CUENTAS_CORRIENTES: INGRESO, EGRESO, COMPRA, VENTA, ARBITRAJE
                    // - WALLET: INGRESO, SALIDA, PRESTAMO, DEVOLUCION, MOV ENTRE CUENTAS
                    // - ADMINISTRATIVAS: AJUSTE, GASTO
                    // - PRESTAMISTAS: PRESTAMO, RETIRO
                    // NO debe aparecer en: WALLET > CREAR WALLET, WALLET > LISTA DE WALLETS
                    const necesitaDetalle = (
                        (formData.operacion === 'TRANSACCIONES' && ['COMPRA', 'VENTA', 'ARBITRAJE'].includes(subOperation)) ||
                        (formData.operacion === 'CUENTAS_CORRIENTES' && ['INGRESO', 'EGRESO', 'COMPRA', 'VENTA', 'ARBITRAJE'].includes(subOperation)) ||
                        (formData.operacion === 'WALLET' && ['INGRESO', 'SALIDA', 'PRESTAMO', 'DEVOLUCION', 'MOV ENTRE CUENTAS'].includes(subOperation)) ||
                        (formData.operacion === 'ADMINISTRATIVAS' && ['AJUSTE', 'GASTO'].includes(subOperation)) ||
                        (formData.operacion === 'PRESTAMISTAS' && ['PRESTAMO', 'RETIRO'].includes(subOperation))
                    ) && !['CREAR WALLET', 'LISTA DE WALLETS'].includes(subOperation);
                    
                    if (necesitaDetalle && formData.operacion && subOperation) {
                        detalleContainer.classList.remove('hidden');
                    } else {
                        detalleContainer.classList.add('hidden');
                    }
                }

                // FINALMENTE: Renderizar los nuevos campos
                if (dynamicContainer) {
                    dynamicContainer.innerHTML = getDynamicFields();
                    initAllDynamicFields();
                }
                
                if (subOperation === 'LISTA DE WALLETS') renderWalletsList();
                
                // Ocultar/mostrar bot√≥n "Guardar Operaci√≥n" seg√∫n la suboperaci√≥n
                const formActions = document.querySelector('.form-actions');
                if (formActions) {
                    if (subOperation === 'CREAR WALLET' || subOperation === 'LISTA DE WALLETS') {
                        formActions.style.display = 'none';
                    } else {
                        formActions.style.display = '';
                    }
                }
                
                updateCalculatedFieldsAndUI();
            }

            function initAllDynamicFields() {
                // Asegurar que los campos de moneda est√©n limpios antes de renderizar
                ['moneda', 'monedaTC', 'monedaBase', 'monedaCobro', 'monedaProfit', 'monedaComision'].forEach(key => {
                    // Si el valor no es una de las monedas v√°lidas, limpiarlo
                    const validValues = monedas.map(m => m.value);
                    if (formData[key] && !validValues.includes(formData[key])) {
                        formData[key] = '';
                    }
                });
                
                // Formatear todos los campos num√©ricos con separadores de miles
                formatNumericFields();
                
                initWalletButtons('walletCompraButtons', 'walletCompra');
                initWalletButtons('walletTCButtons', 'walletTC', true);
                initWalletButtons('walletBaseButtons', 'walletBase');
                initWalletButtons('walletProfitButtons', 'walletProfit');
                initWalletButtons('cuentaSalidaButtons', 'cuentaSalida');
                initWalletButtons('cuentaIngresoButtons', 'cuentaIngreso');
                
                ['monedaButtons', 'monedaTCButtons', 'monedaBaseButtons', 'monedaCobroButtons', 'monedaProfitButtons', 'monedaComisionButtons']
                    .forEach(id => {
                        const key = id.replace('Buttons', '');
                        // Limpiar el contenedor antes de renderizar
                        const container = document.getElementById(id);
                        if (container) {
                            container.innerHTML = '';
                        }
                        renderButtonSet(id, key, monedas, 'btn-option btn-moneda');
                    });
                
                initComisionEvents();
                initWalletManagement();
                if (formData.isMixedPaymentActive) {
                    const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                    if (mixedPaymentsContainer) {
                        renderMixedPayments();
                    }
                }
            }

            function updateCalculatedFieldsAndUI() {
                const { operacion, subOperacion } = formData;
                let calculated = false;

                if ((operacion === 'TRANSACCIONES' || operacion === 'CUENTAS_CORRIENTES') && (subOperacion === 'COMPRA' || subOperacion === 'VENTA')) {
                    calculateTotal(); calculated = true;
                } else if (operacion === 'TRANSACCIONES' && subOperacion === 'ARBITRAJE') {
                    calculateArbitraje(); calculated = true;
                } else if (operacion === 'PRESTAMISTAS' && subOperacion === 'PRESTAMO') {
                    calculatePrestamo(); calculated = true;
                } else if (operacion === 'CUENTAS_CORRIENTES' && (subOperacion === 'INGRESO' || subOperacion === 'EGRESO')) {
                    calculateComisionAndTotal(); calculated = true;
                }
                
                if (calculated) {
                    // Formatear solo los campos calculados que no est√°n siendo editados
                    const calculatedFields = ['total', 'montoBase', 'costoReal', 'profit', 'montoComision'];
                    calculatedFields.forEach(fieldName => {
                        const input = document.querySelector(`[name="${fieldName}"]`);
                        if (input && document.activeElement !== input) {
                            const value = formData[fieldName] || '';
                            input.value = formatNumberWithThousands(value);
                        }
                    });
                }
                updateMixedPaymentsTotal();
            }

            function initOperationsModule() {
                const form = document.getElementById('operationsForm');
                if (!form) return;

                loadFormState();
                
                // Inicializar fecha y nombreDia ANTES de formatear otros campos
                const fechaInput = form.querySelector('[name="fecha"]');
                const nombreDiaInput = form.querySelector('[name="nombreDia"]');
                
                const updateDayName = () => {
                    if (fechaInput && nombreDiaInput) {
                        let fechaValor = fechaInput.value;
                        
                        // Si no hay fecha en el input, usar la fecha actual
                        if (!fechaValor) {
                            const hoy = new Date();
                            fechaValor = hoy.toISOString().split('T')[0];
                            fechaInput.value = fechaValor;
                            formData.fecha = fechaValor;
                        }
                        
                        // Calcular y establecer el nombre del d√≠a
                        if (fechaValor && isValidDate(fechaValor + 'T00:00:00')) {
                            try {
                                const fecha = new Date(fechaValor + 'T00:00:00');
                                // Validar que la fecha sea v√°lida
                                if (isNaN(fecha.getTime())) {
                                    throw new Error('Fecha inv√°lida');
                                }
                                const nombreDia = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][fecha.getDay()];
                                if (nombreDiaInput) {
                                    nombreDiaInput.value = nombreDia;
                                }
                                formData.nombreDia = nombreDia;
                            } catch (error) {
                                console.error('Error al calcular nombre del d√≠a:', error);
                                if (typeof showToast === 'function') {
                                    showToast('Error al calcular el d√≠a de la semana', 'error');
                                }
                                // Establecer un valor por defecto
                                if (nombreDiaInput) {
                                    nombreDiaInput.value = '';
                                }
                                formData.nombreDia = '';
                            }
                        } else if (fechaValor) {
                            console.error('Fecha inv√°lida:', fechaValor);
                            if (typeof showToast === 'function') {
                                showToast('La fecha ingresada no es v√°lida', 'error');
                            }
                        }
                    }
                };
                
                // Configurar event listener para cambios de fecha
                if (fechaInput && nombreDiaInput) {
                    // Remover listener anterior si existe para evitar duplicados
                    if (fechaInput._updateDayNameHandler) {
                        fechaInput.removeEventListener('change', fechaInput._updateDayNameHandler);
                    }
                    // Crear handler nombrado para poder removerlo despu√©s
                    fechaInput._updateDayNameHandler = () => { 
                        updateDayName(); 
                        saveFormState(); 
                    };
                    fechaInput.addEventListener('change', fechaInput._updateDayNameHandler);
                    
                    // Ejecutar inmediatamente para inicializar el campo
                    // CORRECCI√ìN: Eliminados timeouts innecesarios - el DOM es s√≠ncrono despu√©s de innerHTML
                    updateDayName();
                }
                
                // CORRECCI√ìN: Formatear campos num√©ricos inmediatamente despu√©s de cargar el estado
                // El DOM ya est√° disponible despu√©s de innerHTML, no necesitamos timeout
                requestAnimationFrame(() => {
                    formatNumericFields();
                });

                const operationItems = Object.entries(operaciones).map(([key, value]) => ({ key, ...value }));
                renderButtonSet('operationButtons', 'operacion', operationItems);
                
                // Actualizar select de clientes
                updateClientesSelect();
                
                if (formData.operacion) {
                    handleOperationChange(formData.operacion);
                    if (formData.subOperacion) {
                        const subBtn = document.querySelector(`#subOperationButtons [data-value="${formData.subOperacion}"]`);
                        if (subBtn) subBtn.classList.add('active');
                        handleSubOperationChange(formData.subOperacion);
                    } else {
                        // Si no hay sub-operaci√≥n, ocultar el campo detalle
                        const detalleContainer = document.getElementById('detalleContainer');
                        if (detalleContainer) {
                            detalleContainer.classList.add('hidden');
                        }
                    }
                }
                
                // Limpiar listeners anteriores si existen
                if (form._inputHandler) {
                    form.removeEventListener('input', form._inputHandler);
                }
                if (form._blurHandler) {
                    form.removeEventListener('blur', form._blurHandler, true);
                }
                if (form._changeHandler) {
                    form.removeEventListener('change', form._changeHandler);
                }
                if (form._submitHandler) {
                    form.removeEventListener('submit', form._submitHandler);
                }
                if (form._keydownHandler) {
                    form.removeEventListener('keydown', form._keydownHandler);
                }
                
                // Crear handlers nombrados para poder removerlos
                form._inputHandler = (e) => {
                    // Validar que el target tenga la propiedad name
                    if (!e.target || !e.target.name) return;
                    
                    // Actualizar lastEditedField para arbitraje bidireccional
                    const arbitrajeFields = ['montoBase', 'cotizacionCliente', 'montoCobrado', 'cotizacionReal', 'costoReal'];
                    if (arbitrajeFields.includes(e.target.name)) {
                        lastEditedField = e.target.name;
                    }
                    const name = e.target.name;
                    const numericFields = ['monto', 'tc', 'montoBase', 'cotizacionCliente', 'cotizacionReal', 'montoCobrado', 'costoReal', 'interes', 'lapso', 'comisionValor'];
                    
                    if (name && formData.hasOwnProperty(name)) {
                        // Para campos num√©ricos, formatear mientras se escribe
                        if (numericFields.includes(name)) {
                            // Guardar posici√≥n del cursor
                            const cursorPosition = e.target.selectionStart;
                            const originalLength = e.target.value.length;
                            
                            // Permitir negativos solo para ajuste
                            const allowNegative = name === 'monto' && formData.operacion === 'ADMINISTRATIVAS' && formData.subOperacion === 'AJUSTE';
                            
                            // Parsear y formatear el valor
                            const numericValue = safeParseFloat(e.target.value, 0, allowNegative);
                            if (!isNaN(numericValue) && (numericValue >= 0 || allowNegative)) {
                                // Formatear con separadores de miles
                                const formatted = formatNumberWithThousands(numericValue, allowNegative);
                                
                                // Actualizar el valor formateado
                                e.target.value = formatted;
                                
                                // Restaurar posici√≥n del cursor ajustada por los separadores
                                const newLength = formatted.length;
                                const lengthDiff = newLength - originalLength;
                                const newCursorPosition = Math.max(0, Math.min(formatted.length, cursorPosition + lengthDiff));
                                e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                                
                                // Guardar el valor num√©rico sin formatear para c√°lculos
                                formData[name] = numericValue > 0 ? numericValue.toString() : '';
                            } else if (e.target.value === '' || e.target.value === '-') {
                                // Permitir campo vac√≠o o signo negativo al inicio
                                formData[name] = '';
                            } else {
                                // Si no es un n√∫mero v√°lido, mantener el valor anterior
                                const previousValue = formData[name] || '';
                                e.target.value = previousValue ? formatNumberWithThousands(safeParseFloat(previousValue, 0, allowNegative), allowNegative) : '';
                            }
                        } else {
                            // Para campos no num√©ricos, guardar directamente
                            formData[name] = e.target.value;
                        }
                        
                        if (numericFields.includes(name)) {
                            updateCalculatedFieldsAndUI();
                        }
                        saveFormState();
                    }
                };
                form.addEventListener('input', form._inputHandler);
                
                // Formatear campos num√©ricos cuando pierden el foco
                form._blurHandler = (e) => {
                    // Validar que el target tenga la propiedad name
                    if (!e.target || !e.target.name) return;
                    
                    const name = e.target.name;
                    const numericFields = ['monto', 'tc', 'montoBase', 'cotizacionCliente', 'cotizacionReal', 'montoCobrado', 'costoReal', 'interes', 'lapso', 'comisionValor', 'total', 'profit', 'montoComision'];
                    if (numericFields.includes(name) && !e.target.readOnly && e.target.value) {
                        // Permitir negativos solo para ajuste
                        const allowNegative = name === 'monto' && formData.operacion === 'ADMINISTRATIVAS' && formData.subOperacion === 'AJUSTE';
                        const numValue = safeParseFloat(e.target.value, 0, allowNegative);
                        if (!isNaN(numValue) && (numValue > 0 || (allowNegative && numValue !== 0))) {
                            const formatted = formatNumberWithThousands(numValue, allowNegative);
                            if (formatted && e.target.value !== formatted) {
                                e.target.value = formatted;
                            }
                        }
                    }
                };
                form.addEventListener('blur', form._blurHandler, true);
                
                form._changeHandler = (e) => {
                    // Validar que el target tenga la propiedad name
                    if (!e.target || !e.target.name) return;
                    
                    const name = e.target.name;
                    if (name === 'cliente' && formData.hasOwnProperty(name)) {
                        formData[name] = e.target.value;
                        saveFormState();
                    }
                };
                form.addEventListener('change', form._changeHandler);

                // Funci√≥n para encontrar el elemento m√°s cercano en una direcci√≥n
                function findNearestElement(currentElement, direction, focusableElements) {
                    const currentRect = currentElement.getBoundingClientRect();
                    const currentCenterX = currentRect.left + currentRect.width / 2;
                    const currentCenterY = currentRect.top + currentRect.height / 2;
                    
                    let bestElement = null;
                    let bestDistance = Infinity;
                    
                    focusableElements.forEach(element => {
                        if (element === currentElement || element.disabled || element.offsetParent === null) return;
                        
                        const rect = element.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        
                        let dx = centerX - currentCenterX;
                        let dy = centerY - currentCenterY;
                        let distance = Math.sqrt(dx * dx + dy * dy);
                        
                        let isInDirection = false;
                        
                        switch(direction) {
                            case 'up':
                                isInDirection = dy < 0 && Math.abs(dx) < currentRect.width * 1.5;
                                break;
                            case 'down':
                                isInDirection = dy > 0 && Math.abs(dx) < currentRect.width * 1.5;
                                break;
                            case 'left':
                                isInDirection = dx < 0 && Math.abs(dy) < currentRect.height * 1.5;
                                break;
                            case 'right':
                                isInDirection = dx > 0 && Math.abs(dy) < currentRect.height * 1.5;
                                break;
                        }
                        
                        if (isInDirection && distance < bestDistance) {
                            bestDistance = distance;
                            bestElement = element;
                        }
                    });
                    
                    return bestElement;
                }
                
                // Navegaci√≥n con teclado: Enter y flechas (direcci√≥n visual)
                form._keydownHandler = (e) => {
                    // Obtener todos los elementos interactivos
                    const focusableElements = Array.from(form.querySelectorAll(
                        'input:not([type="hidden"]):not([readonly]), select, textarea, button:not([type="submit"])'
                    ));
                    
                    // Enter: activar bot√≥n si es un bot√≥n, sino avanzar al siguiente
                    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.type !== 'submit') {
                        e.preventDefault();
                        
                        if (e.target.tagName === 'BUTTON' || e.target.classList.contains('btn-option')) {
                            // Si es un bot√≥n, activarlo
                            e.target.click();
                        } else {
                            // Si es un input/select, avanzar al siguiente
                            const currentIndex = focusableElements.indexOf(e.target);
                            if (currentIndex < focusableElements.length - 1) {
                                focusableElements[currentIndex + 1].focus();
                            }
                        }
                    }
                    
                    // Flechas: navegaci√≥n visual en todas las direcciones
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                        
                        let direction = '';
                        if (e.key === 'ArrowUp') direction = 'up';
                        else if (e.key === 'ArrowDown') direction = 'down';
                        else if (e.key === 'ArrowLeft') direction = 'left';
                        else if (e.key === 'ArrowRight') direction = 'right';
                        
                        const nearestElement = findNearestElement(e.target, direction, focusableElements);
                        if (nearestElement) {
                            nearestElement.focus();
                        }
                    }
                };
                
                form.addEventListener('keydown', form._keydownHandler);
                
                form._submitHandler = (e) => {
                    e.preventDefault();
                    
                    // Validaciones espec√≠ficas seg√∫n el tipo de operaci√≥n
                    const { operacion, subOperacion } = formData;
                    
                    // Validar campos requeridos seg√∫n el tipo de operaci√≥n
                    if (!operacion || !subOperacion) {
                        showToast('Debes seleccionar una operaci√≥n y tipo', 'error');
                        return;
                    }
                    
                    // Validar monto para operaciones que lo requieren
                    const monto = safeParseFloat(formData.monto);
                    if (['WALLET_INGRESO', 'WALLET_SALIDA', 'WALLET_MOV ENTRE CUENTAS'].includes(`${operacion}_${subOperacion}`)) {
                        if (!monto || monto <= 0) {
                            showToast('El monto debe ser mayor a cero', 'error');
                            return;
                        }
                    }
                    
                    // Validar moneda
                    if (!formData.moneda) {
                        showToast('Debes seleccionar una moneda', 'error');
                        return;
                    }
                    
                    // Validar wallet seg√∫n el tipo de operaci√≥n
                    if (operacion === 'WALLET') {
                        if (subOperacion === 'INGRESO' || subOperacion === 'SALIDA' || subOperacion === 'PRESTAMO' || subOperacion === 'DEVOLUCION') {
                            if (!formData.walletCompra || formData.walletCompra === 'pago_mixto') {
                                showToast('Debes seleccionar una wallet v√°lida', 'error');
                                return;
                            }
                            // Validar que la wallet exista
                            const walletId = parseWalletId(formData.walletCompra).wallet;
                            if (walletId && walletId !== 'pago_mixto') {
                                const wallets = getWallets();
                                if (!wallets.some(w => w.id === walletId)) {
                                    showToast('La wallet seleccionada no existe', 'error');
                                    return;
                                }
                            }
                        } else if (subOperacion === 'MOV ENTRE CUENTAS') {
                            if (!formData.cuentaSalida || !formData.cuentaIngreso) {
                                showToast('Debes seleccionar wallet de salida e ingreso', 'error');
                                return;
                            }
                            const walletSalidaId = parseWalletId(formData.cuentaSalida).wallet;
                            const walletIngresoId = parseWalletId(formData.cuentaIngreso).wallet;
                            if (walletSalidaId === walletIngresoId) {
                                showToast('Las wallets de salida e ingreso deben ser diferentes', 'error');
                                return;
                            }
                            // Validar que las wallets existan
                            const wallets = getWallets();
                            if (walletSalidaId && !wallets.some(w => w.id === walletSalidaId)) {
                                showToast('La wallet de salida no existe', 'error');
                                return;
                            }
                            if (walletIngresoId && !wallets.some(w => w.id === walletIngresoId)) {
                                showToast('La wallet de ingreso no existe', 'error');
                                return;
                            }
                        }
                    }
                    
                    // Validar wallet para ADMINISTRATIVAS
                    if (operacion === 'ADMINISTRATIVAS') {
                        if (!formData.walletCompra || formData.walletCompra === 'pago_mixto') {
                            showToast('Debes seleccionar una wallet v√°lida', 'error');
                            return;
                        }
                        // Validar que la wallet exista
                        const walletId = parseWalletId(formData.walletCompra).wallet;
                        if (walletId && walletId !== 'pago_mixto') {
                            const wallets = getWallets();
                            if (!wallets.some(w => w.id === walletId)) {
                                showToast('La wallet seleccionada no existe', 'error');
                                return;
                            }
                        }
                    }
                    
                    // Validar wallets para TRANSACCIONES y CUENTAS_CORRIENTES
                    if ((operacion === 'TRANSACCIONES' || operacion === 'CUENTAS_CORRIENTES') && 
                        (subOperacion === 'COMPRA' || subOperacion === 'VENTA')) {
                        // Validar walletCompra y walletTC
                        if (!formData.walletCompra || formData.walletCompra === 'pago_mixto') {
                            showToast('Debes seleccionar una wallet v√°lida', 'error');
                            return;
                        }
                        if (!formData.walletTC || formData.walletTC === 'pago_mixto') {
                            showToast('Debes seleccionar una wallet de pago/cobro v√°lida', 'error');
                            return;
                        }
                        // Validar que las wallets existan
                        const wallets = getWallets();
                        const walletCompraId = parseWalletId(formData.walletCompra).wallet;
                        const walletTCId = parseWalletId(formData.walletTC).wallet;
                        if (walletCompraId && walletCompraId !== 'pago_mixto' && !wallets.some(w => w.id === walletCompraId)) {
                            showToast('La wallet seleccionada no existe', 'error');
                            return;
                        }
                        if (walletTCId && walletTCId !== 'pago_mixto' && !wallets.some(w => w.id === walletTCId)) {
                            showToast('La wallet de pago/cobro seleccionada no existe', 'error');
                            return;
                        }
                        // Validar tipo de cambio
                        const tc = safeParseFloat(formData.tc);
                        if (!tc || tc <= 0) {
                            showToast('El tipo de cambio debe ser mayor a cero', 'error');
                            return;
                        }
                    }
                    
                    // Validar cliente para operaciones que lo requieren
                    if ((operacion === 'TRANSACCIONES' || operacion === 'CUENTAS_CORRIENTES' || operacion === 'PRESTAMISTAS') && !formData.cliente) {
                        showToast('Debes seleccionar un cliente', 'error');
                        return;
                    }
                    
                    // Validar cliente existe
                    if (formData.cliente) {
                        const clientes = getClientes();
                        const clienteExiste = clientes.some(c => c.id === formData.cliente);
                        if (!clienteExiste) {
                            showToast('El cliente seleccionado no existe. Por favor selecciona un cliente v√°lido.', 'error');
                            return;
                        }
                    }
                    
                    // Validar fecha si est√° presente
                    if (formData.fecha) {
                        try {
                            if (!isValidDate(formData.fecha + 'T00:00:00')) {
                                showToast('La fecha ingresada no es v√°lida. Por favor ingresa una fecha v√°lida.', 'error');
                                return;
                            }
                        } catch (dateError) {
                            console.error('Error al validar fecha:', dateError);
                            showToast('Error al validar la fecha. Por favor verifica el formato.', 'error');
                            return;
                        }
                    }
                    
                    // Validar monto positivo para operaciones que lo requieren (excepto ajuste)
                    const requiereMontoPositivo = operacion !== 'ADMINISTRATIVAS' || subOperacion !== 'AJUSTE';
                    if (formData.monto && requiereMontoPositivo) {
                        const montoValidado = safeParseFloat(formData.monto);
                        if (montoValidado <= 0) {
                            showToast('El monto debe ser mayor a cero', 'error');
                            return;
                        }
                    }
                    
                    // Validar campos requeridos espec√≠ficos seg√∫n operaci√≥n
                    if (operacion === 'TRANSACCIONES' || operacion === 'CUENTAS_CORRIENTES') {
                        if ((subOperacion === 'COMPRA' || subOperacion === 'VENTA') && !formData.tc) {
                            showToast('El tipo de cambio es obligatorio para esta operaci√≥n', 'error');
                            return;
                        }
                    }
                    
                    if (operacion === 'PRESTAMISTAS' && subOperacion === 'PRESTAMO') {
                        if (!formData.interes || safeParseFloat(formData.interes) <= 0) {
                            showToast('El inter√©s es obligatorio y debe ser mayor a cero', 'error');
                            return;
                        }
                        if (!formData.lapso || safeParseFloat(formData.lapso) <= 0) {
                            showToast('El lapso es obligatorio y debe ser mayor a cero', 'error');
                            return;
                        }
                    }
                    
                    if (operacion === 'TRANSACCIONES' && subOperacion === 'ARBITRAJE') {
                        if (!formData.montoBase || safeParseFloat(formData.montoBase) <= 0) {
                            showToast('El monto base es obligatorio para arbitraje', 'error');
                            return;
                        }
                        if (!formData.cotizacionCliente || safeParseFloat(formData.cotizacionCliente) <= 0) {
                            showToast('La cotizaci√≥n del cliente es obligatoria para arbitraje', 'error');
                            return;
                        }
                    }
                    
                    // Crear copia del formData para guardar
                    const movimientoData = JSON.parse(JSON.stringify(formData));
                    
                    // Normalizar todas las monedas en movimientoData
                    normalizeAllMonedas(movimientoData);
                    
                    // Mostrar indicador de guardado (para UX mejorada)
                    const submitBtn = form.querySelector('button[type="submit"]');
                    let originalText = '';
                    let originalDisabled = false;
                    if (submitBtn) {
                        originalText = submitBtn.textContent;
                        originalDisabled = submitBtn.disabled;
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Guardando...';
                    }
                    
                    try {
                        // Si estamos editando, actualizar el movimiento existente
                        if (editingMovimientoId) {
                            const updateSuccess = updateMovimiento(editingMovimientoId, movimientoData);
                            if (!updateSuccess) {
                                throw new Error('No se pudo actualizar el movimiento');
                            }
                            showToast('Movimiento actualizado con √©xito', 'success');
                            editingMovimientoId = null;
                        } else {
                            // Si es nuevo, crear el movimiento
                            const movimientoId = addMovimiento(movimientoData);
                            
                            // Validar que el movimiento se cre√≥ correctamente
                            if (!movimientoId) {
                                throw new Error('No se pudo crear el movimiento');
                            }
                            
                            // Actualizar √∫ltima operaci√≥n del cliente si hay uno seleccionado
                            if (formData.cliente) {
                                actualizarUltimaOperacionCliente(formData.cliente);
                            }
                            
                            showToast('Operaci√≥n guardada con √©xito', 'success');
                        }
                        
                        clearFormState();
                    } catch (error) {
                        console.error('Error al guardar movimiento:', error);
                        showToast('Error al guardar la operaci√≥n. Por favor intenta nuevamente.', 'error');
                    } finally {
                        // Restaurar bot√≥n en cualquier caso
                        if (submitBtn) {
                            submitBtn.disabled = originalDisabled;
                            submitBtn.textContent = originalText;
                        }
                    }
                    loadModule('operaciones');
                };
                form.addEventListener('submit', form._submitHandler);
                
                const cancelBtn = safeGetElementById('cancelBtn');
                if (cancelBtn && !cancelBtn._cancelClickHandler) {
                    cancelBtn._cancelClickHandler = () => {
                        if (confirm('¬øDeseas cancelar? Se perder√°n los datos.')) {
                            clearFormState();
                            loadModule('operaciones');
                        }
                    };
                    cancelBtn.addEventListener('click', cancelBtn._cancelClickHandler);
                }
                
                const addClientBtn = safeGetElementById('addClientBtn');
                if (addClientBtn && !addClientBtn._addClientClickHandler) {
                    addClientBtn._addClientClickHandler = () => {
                        // Abrir m√≥dulo de clientes
                        loadModule('clientes');
                        // Cerrar sidebar si est√° abierto
                        const sidebar = safeGetElementById('sidebar');
                        const overlay = safeGetElementById('overlay');
                        if (sidebar && overlay) {
                            sidebar.classList.remove('open');
                            overlay.classList.remove('active');
                        }
                    };
                    addClientBtn.addEventListener('click', addClientBtn._addClientClickHandler);
                }
            }
            
            function initWalletButtons(containerId, fieldName, includesPagoMixto = false) {
                const container = safeGetElementById(containerId);
                if (!container) return;
                
                // Limpiar listeners anteriores para evitar memory leaks
                if (container._walletClickHandler) {
                    container.removeEventListener('click', container._walletClickHandler);
                    delete container._walletClickHandler;
                }
                
                const currentValue = formData[fieldName] || '';
                const parsed = parseWalletId(currentValue);
                const currentWallet = parsed.wallet;
                const currentType = parsed.type;
                const wallets = getWallets();
                const tipoLabel = ['VENTA', 'INGRESO'].includes(formData.subOperacion) ? 'Cobro' : 'Pago';
                
                // Guardar referencia a wallets para uso en el handler
                container._wallets = wallets;

                let html = `
                    <div class="wallet-step-label">Paso 1: Seleccionar Wallet</div>
                    <div class="wallet-step" id="${containerId}_wallets">
                        ${wallets.length === 0 ? `<p style="color: var(--text-secondary); font-size: 13px;">No hay wallets creadas.</p>` : 
                            wallets.map(w => `<button type="button" class="btn-wallet ${currentWallet === w.id ? 'active' : ''}" data-wallet="${escapeHTML(w.id)}">${escapeHTML(w.nombre)}</button>`).join('')}
                        ${includesPagoMixto ? `<button type="button" class="btn-wallet ${currentValue === 'pago_mixto' ? 'active' : ''}" data-wallet="pago_mixto">${tipoLabel} Mixto</button>` : ''}
                    </div>
                    <div class="wallet-step-label">Paso 2: Tipo de ${tipoLabel}</div>
                    <div class="wallet-step" id="${containerId}_types">
                        ${(() => {
                            const selectedWallet = wallets.find(w => w.id === currentWallet);
                            const canBeEfectivo = selectedWallet && selectedWallet.tipos && selectedWallet.tipos.includes('efectivo');
                            const canBeDigital = selectedWallet && selectedWallet.tipos && selectedWallet.tipos.includes('digital');
                            return `
                        <button type="button" class="btn-wallet ${currentType === 'efectivo' ? 'active' : ''}" data-type="efectivo" ${!currentWallet || currentValue === 'pago_mixto' || !canBeEfectivo ? 'disabled' : ''}>Efectivo</button>
                        <button type="button" class="btn-wallet ${currentType === 'digital' ? 'active' : ''}" data-type="digital" ${!currentWallet || currentValue === 'pago_mixto' || !canBeDigital ? 'disabled' : ''}>Digital</button>`;
                        })()}
                    </div>`;
                container.innerHTML = html;

                // Crear handler nombrado y guardarlo para poder removerlo despu√©s
                container._walletClickHandler = (e) => {
                    if (e.target.classList.contains('btn-wallet')) {
                        const walletsContainer = e.target.closest(`#${containerId}_wallets`);
                        const typesContainer = e.target.closest(`#${containerId}_types`);
                        const walletId = walletsContainer && walletsContainer.contains(e.target) ? e.target.dataset.wallet : null;
                        const type = typesContainer && typesContainer.contains(e.target) ? e.target.dataset.type : null;

                        if (walletId) {
                            formData[fieldName] = walletId === 'pago_mixto' ? 'pago_mixto' : walletId;
                            const wasMixed = formData.isMixedPaymentActive;
                            formData.isMixedPaymentActive = walletId === 'pago_mixto';
                            
                            // Si se desactiva el pago mixto, limpiar mixedPayments
                            if (wasMixed && !formData.isMixedPaymentActive) {
                                formData.mixedPayments = [];
                            }
                        } else if (type) {
                            const parsed = parseWalletId(formData[fieldName] || '');
                            const selectedWallet = parsed.wallet;
                            if(selectedWallet && selectedWallet !== 'pago_mixto') {
                                formData[fieldName] = `${selectedWallet}_${type}`;
                            }
                        }
                        
                        saveFormState();
                        // Optimizaci√≥n: actualizar solo el HTML necesario en lugar de re-renderizar todo
                        const walletsContainerUpdate = document.getElementById(`${containerId}_wallets`);
                        const typesContainerUpdate = document.getElementById(`${containerId}_types`);
                        const walletsUpdate = container._wallets || getWallets();
                        
                        // Actualizar estado visual de botones sin re-renderizar completo
                        if (walletsContainerUpdate) {
                            walletsContainerUpdate.querySelectorAll('.btn-wallet').forEach(btn => {
                                const isActive = btn.dataset.wallet === formData[fieldName] || 
                                               (formData[fieldName] === 'pago_mixto' && btn.dataset.wallet === 'pago_mixto');
                                btn.classList.toggle('active', isActive);
                            });
                        }
                        
                        if (typesContainerUpdate && formData[fieldName] && formData[fieldName] !== 'pago_mixto') {
                            const parsed = parseWalletId(formData[fieldName]);
                            typesContainerUpdate.querySelectorAll('.btn-wallet').forEach(btn => {
                                btn.classList.toggle('active', btn.dataset.type === parsed.type);
                                const selectedWallet = walletsUpdate.find(w => w.id === parsed.wallet);
                                const canBeEfectivo = selectedWallet && selectedWallet.tipos && selectedWallet.tipos.includes('efectivo');
                                const canBeDigital = selectedWallet && selectedWallet.tipos && selectedWallet.tipos.includes('digital');
                                btn.disabled = (btn.dataset.type === 'efectivo' && !canBeEfectivo) || 
                                             (btn.dataset.type === 'digital' && !canBeDigital);
                            });
                        }
                        
                        const mixedPaymentsContainer = document.getElementById('mixedPaymentsContainer');
                        if (mixedPaymentsContainer) {
                            mixedPaymentsContainer.classList.toggle('hidden', !formData.isMixedPaymentActive);
                            if (formData.isMixedPaymentActive) renderMixedPayments();
                        }
                    }
                };
                container.addEventListener('click', container._walletClickHandler);
            }

            function initWalletManagement() {
                const saveBtn = document.getElementById('saveWalletBtn');
                if (saveBtn) {
                    // Limpiar listener anterior si existe
                    if (saveBtn._saveWalletHandler) {
                        saveBtn.removeEventListener('click', saveBtn._saveWalletHandler);
                    }
                    
                    // Crear handler nombrado
                    saveBtn._saveWalletHandler = () => {
                        const idInput = safeGetElementById('walletId');
                        const nombreInput = safeGetElementById('walletNombre');
                        
                        if (!idInput || !nombreInput) {
                            showToast('Error: No se encontraron los campos del formulario', 'error');
                            return;
                        }
                        
                        const id = idInput.value.trim();
                        const nombre = nombreInput.value.trim();
                        
                        // Sanitizar ID de wallet (solo letras, n√∫meros y guiones bajos)
                        const sanitizedId = id.replace(/[^a-zA-Z0-9_]/g, '');
                        if (sanitizedId !== id) {
                            showToast('El ID contiene caracteres inv√°lidos. Se han removido caracteres especiales.', 'warning');
                            idInput.value = sanitizedId;
                        }
                        
                        const tipos = [...document.querySelectorAll('#walletTipoEfectivo, #walletTipoDigital')].filter(cb => cb.checked).map(cb => cb.id.replace('walletTipo', '').toLowerCase());
                        const monedas = [...document.querySelectorAll('.wallet-moneda-checkbox:checked')].map(cb => cb.value);

                        // Usar ID sanitizado si se modific√≥
                        const finalId = sanitizedId || id;
                        
                        if (!finalId || !nombre || tipos.length === 0 || monedas.length === 0) {
                            showToast('Todos los campos son obligatorios.', 'error');
                            return;
                        }
                        
                        // Si estamos editando
                        if (walletEditandoId) {
                            // Verificar que el ID no cambi√≥ o que no existe otro con ese ID
                            if (finalId !== walletEditandoId && getWallets().some(w => w.id === finalId)) {
                                showToast('Ya existe una wallet con ese ID.', 'error');
                                return;
                            }
                            
                            // Actualizar la wallet existente
                            const wallets = getWallets();
                            const walletIndex = wallets.findIndex(w => w.id === walletEditandoId);
                            if (walletIndex !== -1) {
                                wallets[walletIndex] = { ...wallets[walletIndex], nombre, tipos, monedas };
                                if (finalId !== walletEditandoId) {
                                    wallets[walletIndex].id = finalId;
                                }
                                saveWallets(wallets);
                                showToast(`Wallet "${nombre}" actualizada con √©xito.`, 'success');
                                walletEditandoId = null;
                                
                                // Limpiar formulario
                                const walletIdInput = safeGetElementById('walletId');
                                if (walletIdInput) walletIdInput.disabled = false;
                                handleSubOperationChange('CREAR WALLET');
                                renderWalletsList();
                            }
                        } else {
                            // Crear nueva wallet
                            // Validar ID de wallet
                            if (!finalId || finalId.trim() === '') {
                                showToast('El ID de la wallet no puede estar vac√≠o.', 'error');
                                return;
                            }
                            
                            // Validar formato del ID (solo letras, n√∫meros y guiones bajos)
                            const idRegex = /^[a-zA-Z0-9_]+$/;
                            if (!idRegex.test(finalId.trim())) {
                                showToast('El ID de la wallet solo puede contener letras, n√∫meros y guiones bajos.', 'error');
                                return;
                            }
                            
                            // Validar que no exista ya una wallet con ese ID
                            if (getWallets().some(w => w.id === finalId.trim())) {
                                showToast('Ya existe una wallet con ese ID.', 'error');
                                return;
                            }
                            
                            // Validar nombre
                            if (!nombre || nombre.trim() === '') {
                                showToast('El nombre de la wallet no puede estar vac√≠o.', 'error');
                                return;
                            }
                            
                            // Validar tipos
                            if (!tipos || !Array.isArray(tipos) || tipos.length === 0) {
                                showToast('Debes seleccionar al menos un tipo de wallet.', 'error');
                                return;
                            }
                            
                            // Validar monedas
                            if (!monedas || !Array.isArray(monedas) || monedas.length === 0) {
                                showToast('Debes seleccionar al menos una moneda.', 'error');
                                return;
                            }
                            
                            addWallet({ id: finalId.trim(), nombre: nombre.trim(), tipos, monedas });
                        showToast(`Wallet "${nombre}" creada con √©xito.`, 'success');
                        handleSubOperationChange('CREAR WALLET');
                        }
                    };
                    
                    // Agregar listener
                    saveBtn.addEventListener('click', saveBtn._saveWalletHandler);
                }
            }
        
            function renderWalletsList() {
                const container = safeGetElementById('walletsListContainer');
                if (!container) return;
                const wallets = getWallets();
                container.innerHTML = wallets.length === 0 ? '<p style="color: var(--text-secondary);">No hay wallets creadas.</p>' :
                    wallets.map(w => `
                        <div class="form-card" style="padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1; cursor: pointer;" class="wallet-item" data-wallet-id="${escapeHTML(w.id)}"><h3 style="font-size: 16px;">${escapeHTML(w.nombre)}</h3><p style="color: var(--text-secondary); font-size: 13px;">ID: ${escapeHTML(w.id)}</p></div>
                                <div style="display: flex; gap: 8px;">
                                    <button type="button" class="btn-edit" data-wallet-id="${escapeHTML(w.id)}" title="Editar wallet">‚úèÔ∏è</button>
                                    <button type="button" class="btn-remove" data-wallet-id="${escapeHTML(w.id)}" title="Eliminar wallet">‚úï</button>
                                </div>
                            </div>
                            <div class="form-grid" style="font-size: 13px; margin-top: 15px; margin-bottom: 0;">
                                <div><p>Tipo: ${escapeHTML(w.tipos.join(', '))}</p></div><div><p>Monedas: ${escapeHTML(w.monedas.join(', '))}</p></div>
                            </div>
                        </div>`).join('');

                // Remover event listeners anteriores usando una funci√≥n nombrada
                if (container._walletsClickHandler) {
                    container.removeEventListener('click', container._walletsClickHandler);
                }
                
                // Crear nuevo handler
                container._walletsClickHandler = (e) => {
                    const walletId = e.target.closest('[data-wallet-id]')?.dataset.walletId;
                    if (!walletId) return;
                    
                    if (e.target.classList.contains('btn-remove') || e.target.closest('.btn-remove')) {
                        if (confirm(`¬øEliminar la wallet "${walletId}"?`)) {
                            deleteWallet(walletId);
                            showToast('Wallet eliminada.', 'success');
                            renderWalletsList();
                        }
                    } else if (e.target.classList.contains('btn-edit') || e.target.closest('.btn-edit') || e.target.closest('.wallet-item')) {
                        // Cargar wallet para editar
                        const wallet = getWallets().find(w => w.id === walletId);
                        if (wallet) {
                            editarWallet(wallet);
                        }
                    }
                };
                
                // Agregar event listener
                container.addEventListener('click', container._walletsClickHandler);
            }
            
            // Variable global para wallet en edici√≥n
            let walletEditandoId = null;
            
            function editarWallet(wallet) {
                walletEditandoId = wallet.id;
                
                // Cambiar a la suboperaci√≥n CREAR WALLET y cargar los datos
                formData.operacion = 'WALLET';
                formData.subOperacion = 'CREAR WALLET';
                
                // Renderizar los campos din√°micos
                const dynamicContainer = document.getElementById('dynamicFieldsContainer');
                if (dynamicContainer) {
                    dynamicContainer.innerHTML = getDynamicFields();
                    initAllDynamicFields();
                }
                
                // Cargar datos de la wallet en los campos
                const walletIdInput = document.getElementById('walletId');
                const walletNombreInput = document.getElementById('walletNombre');
                const walletTipoEfectivoCheck = document.getElementById('walletTipoEfectivo');
                const walletTipoDigitalCheck = document.getElementById('walletTipoDigital');
                
                if (walletIdInput) {
                    walletIdInput.value = wallet.id;
                    walletIdInput.disabled = true; // No permitir cambiar el ID
                }
                if (walletNombreInput) walletNombreInput.value = wallet.nombre || '';
                if (walletTipoEfectivoCheck) walletTipoEfectivoCheck.checked = wallet.tipos && wallet.tipos.includes('efectivo');
                if (walletTipoDigitalCheck) walletTipoDigitalCheck.checked = wallet.tipos && wallet.tipos.includes('digital');
                
                // Marcar las monedas seleccionadas
                if (wallet.monedas) {
                    wallet.monedas.forEach(moneda => {
                        const checkbox = document.querySelector(`.wallet-moneda-checkbox[value="${moneda}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Actualizar el bot√≥n de guardar
                const saveBtn = document.getElementById('saveWalletBtn');
                if (saveBtn) {
                    saveBtn.textContent = 'Actualizar Wallet';
                }
                
                // Mostrar mensaje
                showToast('Wallet cargada para editar. Modifica y guarda para actualizar.', 'info');
            }

            function initComisionEvents() {
                const form = document.getElementById('operationsForm');
                if (!form) return;
                const porcentajeBtn = form.querySelector('#comisionPorcentajeBtn');
                const fijoBtn = form.querySelector('#comisionFijoBtn');
                const container = form.querySelector('#monedaComisionContainer');

                // Limpiar listeners anteriores para evitar duplicados
                if (porcentajeBtn && porcentajeBtn._porcentajeClickHandler) {
                    porcentajeBtn.removeEventListener('click', porcentajeBtn._porcentajeClickHandler);
                }
                if (fijoBtn && fijoBtn._fijoClickHandler) {
                    fijoBtn.removeEventListener('click', fijoBtn._fijoClickHandler);
                }

                // Crear handlers nombrados
                if (porcentajeBtn) {
                    porcentajeBtn._porcentajeClickHandler = () => {
                        formData.comisionTipo = 'porcentaje';
                        porcentajeBtn.classList.add('active');
                        fijoBtn?.classList.remove('active');
                        container?.classList.add('hidden');
                        updateCalculatedFieldsAndUI();
                        saveFormState();
                    };
                    porcentajeBtn.addEventListener('click', porcentajeBtn._porcentajeClickHandler);
                }
                
                if (fijoBtn) {
                    fijoBtn._fijoClickHandler = () => {
                        formData.comisionTipo = 'fijo';
                        fijoBtn.classList.add('active');
                        porcentajeBtn?.classList.remove('active');
                        container?.classList.remove('hidden');
                        updateCalculatedFieldsAndUI();
                        saveFormState();
                    };
                    fijoBtn.addEventListener('click', fijoBtn._fijoClickHandler);
                }
            }
            
            function renderMixedPayments() {
                const container = document.getElementById('mixedPaymentsContainer');
                if (!container) return;
                const tipoLabel = formData.subOperacion === 'VENTA' ? 'Cobro' : 'Pago';
                container.innerHTML = `
                    <div class="mixed-payments-section">
                        <h3 style="margin-bottom: 20px; font-size: 16px;">${tipoLabel}s Mixtos</h3>
                        <div id="mixedPaymentsList"></div>
                        <button type="button" class="btn-add-payment" id="addMixedPaymentBtn">+ Agregar ${tipoLabel}</button>
                        <div class="mixed-payment-total"><span>Total Esperado:</span><span id="expectedTotal">0.00</span></div>
                        <div class="mixed-payment-total"><span>Total Agregado:</span><span id="mixedPaymentsTotal" class="total-mismatch">0.00</span></div>
                    </div>`;

                const listContainer = document.getElementById('mixedPaymentsList');
                const addBtn = document.getElementById('addMixedPaymentBtn');
                if (!listContainer) return;
                
                // Limpiar listeners anteriores para evitar memory leaks
                if (listContainer._inputHandler) {
                    listContainer.removeEventListener('input', listContainer._inputHandler);
                }
                if (listContainer._blurHandler) {
                    listContainer.removeEventListener('blur', listContainer._blurHandler, true);
                }
                if (listContainer._clickHandler) {
                    listContainer.removeEventListener('click', listContainer._clickHandler);
                }
                if (addBtn && addBtn._addClickHandler) {
                    addBtn.removeEventListener('click', addBtn._addClickHandler);
                }
                
                const wallets = getWallets();
                // Asegurar que mixedPayments sea un array antes de usar map
                if (!Array.isArray(formData.mixedPayments)) {
                    formData.mixedPayments = [];
                }
                // Asegurar que cada payment sea un objeto v√°lido
                formData.mixedPayments = formData.mixedPayments.map(p => {
                    if (!p || typeof p !== 'object') {
                        return { wallet: '', monto: '' };
                    }
                    return {
                        wallet: p.wallet || '',
                        monto: p.monto || ''
                    };
                });
                listContainer.innerHTML = formData.mixedPayments.map((payment, index) => `
                    <div class="mixed-payment-item">
                        <div class="form-group"><label class="form-label">Wallet</label><select class="form-select" data-index="${index}" data-field="wallet"><option value="">Seleccionar</option>${wallets.map(w => w.tipos.map(t => `<option value="${escapeHTML(w.id)}_${escapeHTML(t)}" ${payment.wallet === `${w.id}_${t}` ? 'selected' : ''}>${escapeHTML(w.nombre)} - ${escapeHTML(t)}</option>`).join('')).join('')}</select></div>
                        <div class="form-group"><label class="form-label">Monto</label><input type="text" inputmode="numeric" class="form-input" data-index="${index}" data-field="monto" value="${formatNumberWithThousands(payment.monto || '')}" placeholder="0.00"></div>
                        <button type="button" class="btn-remove" data-index="${index}">‚úï</button>
                    </div>`).join('');

                // Crear handlers nombrados
                listContainer._inputHandler = (e) => {
                    if(e.target.dataset.index) {
                        const index = parseInt(e.target.dataset.index);
                        // Validar que el √≠ndice sea v√°lido y que el objeto exista
                        if (isNaN(index) || index < 0 || index >= formData.mixedPayments.length) return;
                        if (!formData.mixedPayments[index] || typeof formData.mixedPayments[index] !== 'object') {
                            formData.mixedPayments[index] = { wallet: '', monto: '' };
                        }
                        
                        const field = e.target.dataset.field;
                        if (!field) return;
                        
                        // No formatear mientras se escribe, solo guardar el valor num√©rico
                        if (field === 'monto') {
                            const numValue = safeParseFloat(e.target.value);
                            formData.mixedPayments[index][field] = numValue > 0 ? numValue : 0;
                        } else {
                            formData.mixedPayments[index][field] = e.target.value;
                        }
                        updateMixedPaymentsTotal();
                        saveFormState();
                    }
                };
                
                listContainer._blurHandler = (e) => {
                    if(e.target.dataset.index && e.target.dataset.field === 'monto' && !e.target.readOnly && e.target.value) {
                        const numValue = safeParseFloat(e.target.value);
                        if (!isNaN(numValue) && numValue > 0) {
                            const formatted = formatNumberWithThousands(numValue);
                            if (formatted) {
                                e.target.value = formatted;
                            }
                        }
                    }
                };
                
                listContainer._clickHandler = (e) => {
                    if (e.target.classList.contains('btn-remove')) {
                        const index = parseInt(e.target.dataset.index);
                        // Validar que el √≠ndice sea v√°lido
                        if (!isNaN(index) && index >= 0 && index < formData.mixedPayments.length) {
                            formData.mixedPayments.splice(index, 1);
                            renderMixedPayments();
                            saveFormState();
                        }
                    }
                };
                
                // Agregar listeners
                listContainer.addEventListener('input', listContainer._inputHandler);
                listContainer.addEventListener('blur', listContainer._blurHandler, true);
                listContainer.addEventListener('click', listContainer._clickHandler);
                
                // Handler para el bot√≥n agregar
                if (addBtn) {
                    addBtn._addClickHandler = () => {
                        formData.mixedPayments.push({ wallet: '', monto: '' });
                        renderMixedPayments();
                        saveFormState();
                    };
                    addBtn.addEventListener('click', addBtn._addClickHandler);
                }
                
                updateMixedPaymentsTotal();
            }

            function updateMixedPaymentsTotal() {
                // Asegurar que mixedPayments sea un array antes de usar reduce
                if (!Array.isArray(formData.mixedPayments)) {
                    formData.mixedPayments = [];
                }
                const total = formData.mixedPayments.reduce((sum, p) => sum + safeParseFloat(p.monto || 0), 0);
                const totalEl = document.getElementById('mixedPaymentsTotal');
                const expectedEl = document.getElementById('expectedTotal');
                if (totalEl && expectedEl) {
                    totalEl.textContent = formatNumberWithThousands(total);
                    const expected = safeParseFloat(formData.total || 0);
                    expectedEl.textContent = formatNumberWithThousands(expected);
                    totalEl.classList.toggle('total-match', Math.abs(total - expected) < 0.01);
                    totalEl.classList.toggle('total-mismatch', Math.abs(total - expected) >= 0.01);
                }
            }


            /**
             * =================================================================
             * INICIALIZACI√ìN DE LA APLICACI√ìN
             * =================================================================
             */
            const setupMenu = () => {
                try {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    const menuBtn = document.getElementById('menuBtn');
                    const closeBtn = document.getElementById('closeBtn');
                    
                    if (!sidebar || !overlay || !menuBtn || !closeBtn) {
                        console.error('Error: Elementos del men√∫ no encontrados');
                        return;
                    }
                    
                    const closeMenu = () => { 
                        sidebar.classList.remove('open'); 
                        overlay.classList.remove('active');
                        // CORRECCI√ìN: Resetear display para evitar que quede bloqueado
                        overlay.style.display = '';
                    };
                    
                    // Limpiar listeners anteriores para evitar duplicados
                    if (menuBtn._menuClickHandler) {
                        menuBtn.removeEventListener('click', menuBtn._menuClickHandler);
                    }
                    if (closeBtn._closeClickHandler) {
                        closeBtn.removeEventListener('click', closeBtn._closeClickHandler);
                    }
                    if (overlay._overlayClickHandler) {
                        overlay.removeEventListener('click', overlay._overlayClickHandler);
                    }
                    
                    // Crear handlers nombrados
                    menuBtn._menuClickHandler = () => { 
                        sidebar.classList.add('open'); 
                        overlay.classList.add('active'); 
                    };
                    closeBtn._closeClickHandler = closeMenu;
                    overlay._overlayClickHandler = closeMenu;
                    
                    // Agregar listeners
                    menuBtn.addEventListener('click', menuBtn._menuClickHandler);
                    closeBtn.addEventListener('click', closeBtn._closeClickHandler);
                    overlay.addEventListener('click', overlay._overlayClickHandler);
                    
                    // Limpiar listeners anteriores de los links del men√∫
                    document.querySelectorAll('.menu-link').forEach(link => {
                        if (link._menuLinkHandler) {
                            link.removeEventListener('click', link._menuLinkHandler);
                        }
                        
                        // Crear handler nombrado
                        link._menuLinkHandler = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            closeMenu();
                            // Obtener href del link, no del target (por si se hace click en el texto)
                            const href = link.getAttribute('href') || e.target.closest('a')?.getAttribute('href');
                            if (href) {
                                loadModule(href.substring(1));
                            }
                        };
                        
                        link.addEventListener('click', link._menuLinkHandler);
                    });
                } catch (error) {
                    console.error('Error en setupMenu:', error);
                }
            };

            const updateDateDisplay = () => {
                try {
                    const dateDisplay = document.getElementById('dateDisplay');
                    if (!dateDisplay) {
                        console.error('Error: dateDisplay no encontrado');
                        return;
                    }
                    const now = new Date();
                    const formatted = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    dateDisplay.textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                } catch (error) {
                    console.error('Error en updateDateDisplay:', error);
                }
            };

            const applyTheme = (theme) => {
                document.body.classList.toggle('light-theme', theme === 'light');
                safeLocalStorageOperation('set', 'theme', theme);
            };

            const setupTheme = () => {
                try {
                    const savedTheme = safeLocalStorageOperation('get', 'theme') || 'dark';
                    applyTheme(savedTheme);
                } catch (error) {
                    console.error('Error en setupTheme:', error);
                }
            };

            function initConfiguracion() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                const setThemeUI = (isDark) => {
                    if(themeToggle) themeToggle.checked = !isDark;
                    if(themeIcon) themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                    if(themeText) themeText.textContent = isDark ? 'Tema Oscuro' : 'Tema Claro';
                };
                const currentTheme = safeLocalStorageOperation('get', 'theme') || 'dark';
                setThemeUI(currentTheme === 'dark');
                if(themeToggle) themeToggle.addEventListener('change', (e) => {
                    const newTheme = e.target.checked ? 'light' : 'dark';
                    applyTheme(newTheme);
                    setThemeUI(newTheme === 'dark');
                });
            }

            /**
             * =================================================================
             * M√ìDULO DE CLIENTES
             * =================================================================
             */
            function renderClientesModule() {
                return `
                    <div class="operations-container">
                        <div class="form-card">
                            <div class="form-header">
                                <button type="button" class="btn-back" id="btnVolverClientes" title="Volver">‚Üê Volver</button>
                                <h2 class="form-title">üë• Gesti√≥n de Clientes</h2>
                                <div style="width: 100px;"></div>
                            </div>
                            
                            <!-- Tabs para Crear / Listar -->
                            <div class="tabs-container">
                                <button type="button" class="btn-option active" id="tabCrearCliente" style="border-bottom: 2px solid var(--active-bg); border-radius: 0; margin-bottom: -1px;">Crear Cliente</button>
                                <button type="button" class="btn-option" id="tabListarClientes" style="border-bottom: 2px solid transparent; border-radius: 0; margin-bottom: -1px;">Listar Clientes</button>
                            </div>
                            
                            <!-- Secci√≥n Crear Cliente -->
                            <div id="crearClienteSection">
                                <form id="clienteForm">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label" for="clienteNombre">Nombre y Apellido *</label>
                                            <input type="text" class="form-input" id="clienteNombre" name="nombre" placeholder="Ej: Juan P√©rez" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteDocumento">DNI</label>
                                            <input type="text" class="form-input" id="clienteDocumento" name="documento" placeholder="Ej: 12345678">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteTelefono">Tel√©fono</label>
                                            <input type="text" class="form-input" id="clienteTelefono" name="telefono" placeholder="Ej: +54 11 1234-5678">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteTelefonoRespaldo">Tel√©fono de Respaldo</label>
                                            <input type="text" class="form-input" id="clienteTelefonoRespaldo" name="telefonoRespaldo" placeholder="Ej: +54 11 9876-5432">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteEmail">Email</label>
                                            <input type="email" class="form-input" id="clienteEmail" name="email" placeholder="Ej: cliente@email.com">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteDireccion">Calle, N√∫mero y Timbre</label>
                                            <input type="text" class="form-input" id="clienteDireccion" name="direccion" placeholder="Ej: Av. Corrientes 1234, Timbre 5B">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="clienteRecomendado">Recomendado de</label>
                                            <input type="text" class="form-input" id="clienteRecomendado" name="recomendado" placeholder="Ej: Mar√≠a Gonz√°lez">
                                        </div>
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label class="form-label">Tipo de Cliente *</label>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                                                <button type="button" class="btn-option active" id="tipoClienteDiario" data-tipo="diario">Cliente Diario</button>
                                                <button type="button" class="btn-option" id="tipoClientePrestamista" data-tipo="prestamista">Cliente Prestamista</button>
                                                <button type="button" class="btn-option" id="tipoClienteCuentaCorriente" data-tipo="cuenta_corriente">Cliente Cuenta Corriente</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="clienteNotas">Notas / Observaciones</label>
                                        <textarea class="form-textarea" id="clienteNotas" name="notas" placeholder="Informaci√≥n adicional sobre el cliente" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn-cancel" id="limpiarClienteBtn">Limpiar</button>
                                        <button type="button" class="btn-remove" id="eliminarClienteBtn" style="display: none;">Eliminar Cliente</button>
                                        <button type="submit" class="btn-submit">Guardar Cliente</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Secci√≥n Listar Clientes -->
                            <div id="listarClientesSection" class="hidden">
                                <div id="clientesListContainer"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Variables globales para el m√≥dulo de clientes (ya declaradas arriba)
            
            // Funci√≥n para actualizar el bot√≥n de volver seg√∫n el contexto en el m√≥dulo de clientes
            function actualizarBotonVolverClientes() {
                const btnVolver = document.getElementById('btnVolverClientes');
                if (!btnVolver) return;
                
                const tabCrear = document.getElementById('tabCrearCliente');
                const isEnCrear = tabCrear?.classList.contains('active');
                const isEditando = clienteEditandoId !== null;
                
                // El bot√≥n "Volver" siempre usa goBack() para mantener consistencia
                // Las sub-vistas (crear/editar) no se agregan al historial de m√≥dulos
                btnVolver.onclick = () => {
                    // Si estamos en una sub-vista (crear o editar), primero volver al listado
                    if (isEnCrear || isEditando) {
                        const tabListar = document.getElementById('tabListarClientes');
                        if (tabListar) {
                            tabListar.click();
                            // Resetear estado de edici√≥n
                            if (isEditando) {
                                resetearFormularioCliente();
                            }
                        }
                    } else {
                        // Si estamos en el listado, usar goBack() normal
                        window.goBack();
                    }
                };
                
                // Actualizar el t√≠tulo del bot√≥n seg√∫n el contexto
                if (isEnCrear || isEditando) {
                    btnVolver.title = 'Volver al listado de clientes';
                } else {
                    btnVolver.title = 'Volver';
                }
            }
            
            // Funci√≥n para cargar cliente en el formulario para editar
            function cargarClienteParaEditar(clienteId) {
                const cliente = getClienteCompleto(clienteId);
                if (!cliente) return;
                
                clienteEditandoId = clienteId;
                
                // Cargar datos en el formulario
                const nombreEl = safeGetElementById('clienteNombre');
                const documentoEl = safeGetElementById('clienteDocumento');
                const telefonoEl = safeGetElementById('clienteTelefono');
                const telefonoRespaldoEl = safeGetElementById('clienteTelefonoRespaldo');
                const emailEl = safeGetElementById('clienteEmail');
                const direccionEl = safeGetElementById('clienteDireccion');
                const recomendadoEl = safeGetElementById('clienteRecomendado');
                const notasEl = safeGetElementById('clienteNotas');
                
                if (nombreEl) nombreEl.value = cliente.nombre || '';
                if (documentoEl) documentoEl.value = cliente.documento || '';
                if (telefonoEl) telefonoEl.value = cliente.telefono || '';
                if (telefonoRespaldoEl) telefonoRespaldoEl.value = cliente.telefonoRespaldo || '';
                if (emailEl) emailEl.value = cliente.email || '';
                if (direccionEl) direccionEl.value = cliente.direccion || '';
                if (recomendadoEl) recomendadoEl.value = cliente.recomendado || '';
                if (notasEl) notasEl.value = cliente.notas || '';
                
                // Establecer tipo de cliente
                tipoClienteSeleccionado = cliente.tipo || 'diario';
                // Verificar que tipoButtons est√© inicializado
                if (tipoButtons && typeof tipoButtons === 'object') {
                    Object.values(tipoButtons).forEach(btn => {
                        if (btn) btn.classList.remove('active');
                    });
                    if (tipoButtons[tipoClienteSeleccionado]) {
                        tipoButtons[tipoClienteSeleccionado].classList.add('active');
                    }
                }
                
                // Cambiar texto del bot√≥n y mostrar bot√≥n cancelar y eliminar
                const submitBtn = document.querySelector('#clienteForm button[type="submit"]');
                const limpiarBtn = document.getElementById('limpiarClienteBtn');
                const eliminarBtn = document.getElementById('eliminarClienteBtn');
                if (submitBtn) submitBtn.textContent = 'Actualizar Cliente';
                if (limpiarBtn) {
                    limpiarBtn.textContent = 'Cancelar';
                    limpiarBtn.style.display = 'inline-block';
                }
                if (eliminarBtn) {
                    eliminarBtn.style.display = 'inline-block';
                }
                
                // Cambiar a la pesta√±a de crear
                const tabCrear = document.getElementById('tabCrearCliente');
                const tabListar = document.getElementById('tabListarClientes');
                const sectionCrear = document.getElementById('crearClienteSection');
                const sectionListar = document.getElementById('listarClientesSection');
                
                if (tabCrear && tabListar && sectionCrear && sectionListar) {
                    tabCrear.classList.add('active');
                    tabListar.classList.remove('active');
                    sectionCrear.classList.remove('hidden');
                    sectionListar.classList.add('hidden');
                    tabCrear.style.borderBottomColor = 'var(--active-bg)';
                    tabListar.style.borderBottomColor = 'transparent';
                }
                
                // Scroll al formulario
                document.getElementById('crearClienteSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Actualizar bot√≥n de volver (estamos editando, debe volver al listado)
                actualizarBotonVolverClientes();
            }
            
            // Funci√≥n para resetear el formulario a modo crear
            function resetearFormularioCliente() {
                clienteEditandoId = null;
                const clienteForm = document.getElementById('clienteForm');
                clienteForm?.reset();
                
                // Resetear tipo de cliente
                tipoClienteSeleccionado = 'diario';
                // Verificar que tipoButtons est√© inicializado
                if (tipoButtons && typeof tipoButtons === 'object') {
                    Object.values(tipoButtons).forEach(btn => {
                        if (btn) btn.classList.remove('active');
                    });
                    if (tipoButtons.diario) tipoButtons.diario.classList.add('active');
                }
                
                // Restaurar texto del bot√≥n y ocultar bot√≥n eliminar
                const submitBtn = document.querySelector('#clienteForm button[type="submit"]');
                const limpiarBtn = document.getElementById('limpiarClienteBtn');
                const eliminarBtn = document.getElementById('eliminarClienteBtn');
                if (submitBtn) submitBtn.textContent = 'Guardar Cliente';
                if (limpiarBtn) limpiarBtn.textContent = 'Limpiar';
                if (eliminarBtn) eliminarBtn.style.display = 'none';
                
                // Actualizar bot√≥n de volver (ya no estamos editando)
                actualizarBotonVolverClientes();
            }

            function initClientesModule() {
                // Inicializar tabs
                const tabCrear = document.getElementById('tabCrearCliente');
                const tabListar = document.getElementById('tabListarClientes');
                const sectionCrear = document.getElementById('crearClienteSection');
                const sectionListar = document.getElementById('listarClientesSection');
                
                tabCrear?.addEventListener('click', () => {
                    tabCrear.classList.add('active');
                    tabListar?.classList.remove('active');
                    sectionCrear?.classList.remove('hidden');
                    sectionListar?.classList.add('hidden');
                    tabCrear.style.borderBottomColor = 'var(--active-bg)';
                    tabListar.style.borderBottomColor = 'transparent';
                    actualizarBotonVolverClientes();
                });
                
                tabListar?.addEventListener('click', () => {
                    tabListar.classList.add('active');
                    tabCrear?.classList.remove('active');
                    sectionListar?.classList.remove('hidden');
                    sectionCrear?.classList.add('hidden');
                    tabListar.style.borderBottomColor = 'var(--active-bg)';
                    tabCrear.style.borderBottomColor = 'transparent';
                    renderClientesList();
                    actualizarBotonVolverClientes();
                });
                
                // Inicializar el bot√≥n de volver
                actualizarBotonVolverClientes();
                
                // Inicializar tipoButtons
                tipoButtons = {
                    diario: document.getElementById('tipoClienteDiario'),
                    prestamista: document.getElementById('tipoClientePrestamista'),
                    cuenta_corriente: document.getElementById('tipoClienteCuentaCorriente')
                };
                
                Object.entries(tipoButtons).forEach(([tipo, button]) => {
                    button?.addEventListener('click', () => {
                        tipoClienteSeleccionado = tipo;
                        // Desactivar todos
                        if (tipoButtons && typeof tipoButtons === 'object') {
                            Object.values(tipoButtons).forEach(btn => btn?.classList.remove('active'));
                        }
                        // Activar el seleccionado
                        button.classList.add('active');
                    });
                });
                
                // Formulario de crear/editar cliente
                const clienteForm = document.getElementById('clienteForm');
                clienteForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const nombre = document.getElementById('clienteNombre')?.value.trim();
                    const documento = document.getElementById('clienteDocumento')?.value.trim();
                    const telefono = document.getElementById('clienteTelefono')?.value.trim();
                    const telefonoRespaldo = document.getElementById('clienteTelefonoRespaldo')?.value.trim();
                    const email = document.getElementById('clienteEmail')?.value.trim();
                    const direccion = document.getElementById('clienteDireccion')?.value.trim();
                    const recomendado = document.getElementById('clienteRecomendado')?.value.trim();
                    const notas = document.getElementById('clienteNotas')?.value.trim();
                    
                    if (!nombre) {
                        showToast('El nombre y apellido es obligatorio', 'error');
                        return;
                    }
                    
                    // Validar email si est√° presente
                    if (email && email.trim() !== '') {
                        if (!isValidEmail(email)) {
                            showToast('El formato del email no es v√°lido. Ejemplo: cliente@email.com', 'error');
                            return;
                        }
                    }
                    
                    // Si est√° editando
                    if (clienteEditandoId) {
                        const datosActualizados = {
                            nombre,
                            documento: documento || '',
                            telefono: telefono || '',
                            telefonoRespaldo: telefonoRespaldo || '',
                            email: email || '',
                            direccion: direccion || '',
                            recomendado: recomendado || '',
                            tipo: tipoClienteSeleccionado,
                            notas: notas || ''
                        };
                        
                        updateCliente(clienteEditandoId, datosActualizados);
                        showToast(`Cliente "${nombre}" actualizado exitosamente`, 'success');
                        resetearFormularioCliente();
                        renderClientesList();
                    } else {
                        // Verificar si ya existe un cliente con el mismo nombre
                        const clientes = getClientes();
                        if (clientes.some(c => c.nombre.toLowerCase() === nombre.toLowerCase())) {
                            if (!confirm('Ya existe un cliente con ese nombre. ¬øDeseas agregarlo de todas formas?')) {
                                return;
                            }
                        }
                        
                        // Generar ID aleatorio √∫nico
                        let id;
                        try {
                            const uuid = generateUUID();
                            if (!uuid || typeof uuid !== 'string') {
                                throw new Error('UUID inv√°lido');
                            }
                            id = 'CLI_' + uuid;
                        } catch (error) {
                            console.error('Error al generar ID de cliente:', error);
                            // Fallback: timestamp + random
                            id = 'CLI_' + Date.now().toString(36) + Math.random().toString(36).substring(2);
                        }
                        
                        const nuevoCliente = {
                            id,
                            nombre,
                            documento: documento || '',
                            telefono: telefono || '',
                            telefonoRespaldo: telefonoRespaldo || '',
                            email: email || '',
                            direccion: direccion || '',
                            recomendado: recomendado || '',
                            tipo: tipoClienteSeleccionado,
                            notas: notas || '',
                            fechaCreacion: new Date().toISOString()
                        };
                        
                        addCliente(nuevoCliente);
                        showToast(`Cliente "${nombre}" creado exitosamente`, 'success');
                        resetearFormularioCliente();
                    }
                    
                    // Actualizar select de clientes en operaciones si existe
                    updateClientesSelect();
                });
                
                // Bot√≥n limpiar/cancelar
                document.getElementById('limpiarClienteBtn')?.addEventListener('click', () => {
                    resetearFormularioCliente();
                });
                
                // Bot√≥n eliminar cliente (solo visible en modo edici√≥n)
                document.getElementById('eliminarClienteBtn')?.addEventListener('click', () => {
                    if (!clienteEditandoId) return;
                    
                    const cliente = getClienteCompleto(clienteEditandoId);
                    if (!cliente) return;
                    
                    if (confirm(`¬øEst√°s seguro de que deseas eliminar el cliente "${escapeHTML(cliente.nombre)}"? Esta acci√≥n no se puede deshacer.`)) {
                        deleteCliente(clienteEditandoId);
                        showToast('Cliente eliminado', 'success');
                        resetearFormularioCliente();
                        renderClientesList();
                        updateClientesSelect();
                        
                        // Cambiar a la pesta√±a de listar
                        const tabListar = document.getElementById('tabListarClientes');
                        if (tabListar) tabListar.click();
                    }
                });
                
                // Renderizar lista inicial
                renderClientesList();
            }

            function updateClientesSelect() {
                const clienteSelect = document.getElementById('cliente');
                if (!clienteSelect) return;
                
                const clientes = getClientes();
                const currentValue = clienteSelect.value;
                
                // Filtrar clientes seg√∫n el tipo de operaci√≥n
                let clientesFiltrados = clientes;
                const operacion = formData.operacion;
                
                if (operacion === 'CUENTAS_CORRIENTES') {
                    // Solo clientes de cuenta corriente
                    clientesFiltrados = clientes.filter(c => c.tipo === 'cuenta_corriente');
                } else if (operacion === 'PRESTAMISTAS') {
                    // Solo clientes prestamistas
                    clientesFiltrados = clientes.filter(c => c.tipo === 'prestamista');
                } else if (operacion === 'TRANSACCIONES') {
                    // Solo clientes comunes (diario)
                    clientesFiltrados = clientes.filter(c => c.tipo === 'diario' || !c.tipo);
                }
                
                clienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' + 
                    clientesFiltrados.map(c => `<option value="${escapeHTML(c.id)}">${escapeHTML(c.nombre)}${c.documento ? ' - ' + escapeHTML(c.documento) : ''}</option>`).join('');
                
                // Restaurar valor seleccionado si existe y est√° en la lista filtrada
                if (currentValue && clientesFiltrados.some(c => c.id === currentValue)) {
                    clienteSelect.value = currentValue;
                } else {
                    // Si el cliente actual no est√° en la lista filtrada, limpiar selecci√≥n
                    clienteSelect.value = '';
                    if (formData.cliente) {
                        formData.cliente = '';
                        saveFormState();
                    }
                }
            }

            /**
             * =================================================================
             * M√ìDULO DE MOVIMIENTOS
             * =================================================================
             */
            function renderMovimientosModule() {
                return `
                    <div class="operations-container" style="max-width: 100%;">
                        <div class="form-card">
                            <div class="form-header">
                                <button type="button" class="btn-back" onclick="window.goBack()" title="Volver">‚Üê Volver</button>
                                <h2 class="form-title">üìä Movimientos</h2>
                                <div style="width: 100px;"></div>
                            </div>
                            <div id="movimientosListContainer"></div>
                        </div>
                    </div>
                `;
            }

            // Cache para movimientos (se invalida cuando se modifica)
            let movimientosCache = null;
            let movimientosCacheTimestamp = null;
            const CACHE_DURATION = 1000; // 1 segundo de cache

            function getMovimientosCached() {
                const now = Date.now();
                if (movimientosCache && movimientosCacheTimestamp && (now - movimientosCacheTimestamp) < CACHE_DURATION) {
                    return movimientosCache;
                }
                movimientosCache = getMovimientos();
                movimientosCacheTimestamp = now;
                return movimientosCache;
            }

            function invalidateMovimientosCache() {
                movimientosCache = null;
                movimientosCacheTimestamp = null;
            }

            // Variable global para la p√°gina actual de movimientos
            window.currentMovimientosPage = 1;
            
            window.renderMovimientosListPage = function(page) {
                window.currentMovimientosPage = page;
                renderMovimientosList(page);
            };

            function initMovimientosModule() {
                window.currentMovimientosPage = 1;
                renderMovimientosList(1);
            }

            function renderMovimientosList(page = 1, itemsPerPage = 50) {
                const container = safeGetElementById('movimientosListContainer');
                if (!container) return;
                
                const movimientos = getMovimientosCached();
                const totalMovimientos = movimientos.length;
                
                if (totalMovimientos === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay movimientos registrados.</p>';
                    return;
                }
                
                // Calcular paginaci√≥n
                const totalPages = Math.ceil(totalMovimientos / itemsPerPage);
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, totalMovimientos);
                const movimientosPaginados = movimientos.slice(startIndex, endIndex);
                
                // Renderizar movimientos
                const movimientosHTML = movimientosPaginados.map(mov => {
                    const fecha = new Date(mov.fechaCreacion);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const horaFormateada = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    const clienteNombre = getClienteNombre(mov.cliente);
                    const operacionLabel = mov.operacion ? mov.operacion.replace('_', ' ') : '';
                    const subOperacionLabel = mov.subOperacion || '';
                    
                    // Estado
                    let estadoLabel = '';
                    let estadoColor = 'var(--text-secondary)';
                    if (mov.estado === 'pendiente_retiro') {
                        estadoLabel = 'P. RETIRO';
                        estadoColor = 'var(--error-color)';
                    } else if (mov.estado === 'pendiente_entrega') {
                        estadoLabel = 'P. ENTREGA';
                        estadoColor = 'var(--success-color)';
                    } else if (mov.estado === 'realizado') {
                        estadoLabel = 'FINALIZADO';
                        estadoColor = 'var(--success-color)';
                    } else if (mov.estado) {
                        estadoLabel = mov.estado.toUpperCase();
                    }
                    
                    // Monto y moneda
                    let montoInfo = '';
                    if (mov.monto && mov.moneda) {
                        let moneda = mov.moneda;
                        moneda = normalizeMoneda(moneda);
                        const monedaLabel = monedas.find(m => m.value === moneda)?.label || moneda;
                        montoInfo = `${escapeHTML(monedaLabel)} ${formatNumberWithThousands(mov.monto)}`;
                    }
                    
                    // Total
                    let totalInfo = '';
                    if (mov.total) {
                        let monedaTotal = mov.monedaTC || mov.moneda || 'ARS';
                        monedaTotal = normalizeMoneda(monedaTotal);
                        const monedaTotalLabel = monedas.find(m => m.value === monedaTotal)?.label || monedaTotal;
                        totalInfo = `${monedaTotalLabel} ${formatNumberWithThousands(mov.total)}`;
                    }
                    
                    // Tipo de cambio
                    let tcInfo = '';
                    if (mov.tc) {
                        tcInfo = `TC: ${formatNumberWithThousands(mov.tc)}`;
                    }
                    
                    // Wallet
                    let walletInfo = '';
                    const walletId = mov.walletCompra || mov.walletTC || mov.walletBase || mov.walletProfit || '';
                    if (walletId && walletId !== 'pago_mixto') {
                        const walletNombre = getWalletNombre(walletId);
                        if (walletNombre) {
                            walletInfo = `üí≥ ${escapeHTML(walletNombre)}`;
                        }
                    }
                    
                    return `
                        <div class="movimiento-row" style="display: grid; grid-template-columns: 2.5fr 1.5fr 1fr 1.2fr 1.2fr 1fr 1fr auto; gap: 16px; padding: 16px; margin-bottom: 12px; background: var(--bg-secondary); border-radius: 8px; align-items: start; overflow: hidden; ${mov.anulado ? 'opacity: 0.6; border: 2px solid var(--error-color);' : 'border: 1px solid var(--border-color);'}" data-movimiento-id="${escapeHTML(mov.id)}">
                            ${mov.anulado ? '<div style="grid-column: 1 / -1; background: var(--error-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; width: fit-content; margin-bottom: 8px;">ANULADO</div>' : ''}
                            <div style="cursor: pointer; min-width: 0;" class="movimiento-item">
                                <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(operacionLabel)} ${subOperacionLabel ? '> ' + escapeHTML(subOperacionLabel) : ''}</div>
                                ${mov.detalle ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; line-height: 1.4;">${escapeHTML(mov.detalle.length > 60 ? mov.detalle.substring(0, 60) + '...' : mov.detalle)}</div>` : ''}
                            </div>
                            <div style="min-width: 0;">
                                <div style="font-size: 13px; color: var(--text-primary); font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${clienteNombre}</div>
                                ${walletInfo ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${walletInfo}</div>` : ''}
                            </div>
                            <div style="min-width: 0;">
                                <div style="font-size: 12px; color: var(--text-secondary); white-space: nowrap;">${fechaFormateada}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); white-space: nowrap;">${horaFormateada}</div>
                            </div>
                            <div style="min-width: 0;">
                                ${montoInfo ? `<div style="font-size: 13px; color: var(--text-primary); font-weight: 600; margin-bottom: 2px; white-space: nowrap;">${montoInfo}</div>` : ''}
                                ${totalInfo ? `<div style="font-size: 12px; color: var(--text-primary); white-space: nowrap;">Total: ${totalInfo}</div>` : ''}
                            </div>
                            <div style="min-width: 0;">
                                ${tcInfo ? `<div style="font-size: 11px; color: var(--text-secondary); white-space: nowrap;">${tcInfo}</div>` : ''}
                                ${estadoLabel ? `<div style="font-size: 11px; color: ${estadoColor}; font-weight: 600; margin-top: 4px; white-space: nowrap;">${estadoLabel}</div>` : ''}
                            </div>
                            <div style="min-width: 0; font-size: 11px; color: var(--text-secondary);">
                                ${mov.por ? `<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Por: ${mov.por}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 6px; min-width: 0; flex-shrink: 0; align-items: start;">
                                ${!mov.anulado ? `<button type="button" class="btn-option" style="font-size: 11px; padding: 6px 12px; white-space: nowrap; flex-shrink: 0;" data-action="anular" data-mov-id="${escapeHTML(mov.id)}">Anular</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Controles de paginaci√≥n
                let paginationHTML = '';
                if (totalPages > 1) {
                    paginationHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="color: var(--text-secondary); font-size: 13px;">
                                Mostrando ${startIndex + 1}-${endIndex} de ${totalMovimientos} movimientos
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button type="button" class="btn-option" ${page === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : 'style="padding: 8px 16px;"'} data-page="${page - 1}" onclick="window.renderMovimientosListPage(${page - 1})">
                                    ‚Üê Anterior
                                </button>
                                <span style="color: var(--text-primary); font-size: 13px; padding: 0 12px;">
                                    P√°gina ${page} de ${totalPages}
                                </span>
                                <button type="button" class="btn-option" ${page === totalPages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : 'style="padding: 8px 16px;"'} data-page="${page + 1}" onclick="window.renderMovimientosListPage(${page + 1})">
                                    Siguiente ‚Üí
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = movimientosHTML + paginationHTML;
                
                // Remover event listeners anteriores usando una funci√≥n nombrada
                if (container._movimientosClickHandler) {
                    container.removeEventListener('click', container._movimientosClickHandler);
                }
                
                // Crear nuevo handler
                container._movimientosClickHandler = (e) => {
                    // Manejar clicks en botones de paginaci√≥n
                    if (e.target.dataset.page) {
                        const page = parseInt(e.target.dataset.page);
                        if (page > 0) {
                            window.renderMovimientosListPage(page);
                        }
                        return;
                    }
                    
                    // Manejar clicks en botones de acci√≥n
                    if (e.target.dataset.action === 'anular') {
                        const movimientoId = e.target.dataset.movId;
                        if (confirm('¬øEst√°s seguro de que deseas anular este movimiento?')) {
                            anularMovimiento(movimientoId);
                        }
                        return;
                    }
                    
                    const movimientoCard = e.target.closest('[data-movimiento-id]');
                    if (!movimientoCard) return;
                    
                    const movimientoId = movimientoCard.dataset.movimientoId;
                    const movimientos = getMovimientosCached();
                    const movimiento = movimientos.find(m => m.id === movimientoId);
                    
                    if (!movimiento) return;
                    
                    // Si click en el contenido (no en botones), mostrar detalles
                    if (e.target.classList.contains('movimiento-item') || e.target.closest('.movimiento-item')) {
                        mostrarDetallesMovimiento(movimientoId);
                    }
                };
                
                // Agregar event listener
                container.addEventListener('click', container._movimientosClickHandler);
            }

            function mostrarDetallesMovimiento(movimiento) {
                const clienteNombre = getClienteNombre(movimiento.cliente);
                const fechaCreacion = new Date(movimiento.fechaCreacion);
                const fechaFormateada = fechaCreacion.toLocaleDateString('es-ES', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
                const horaFormateada = fechaCreacion.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                let detallesHTML = `
                    <div class="form-card" style="max-width: 800px; margin: 0 auto;">
                        <div class="form-header">
                            <h2 class="form-title">Detalles del Movimiento</h2>
                            ${movimiento.anulado ? '<div style="background: var(--error-color); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-bottom: 16px;">‚ö†Ô∏è MOVIMIENTO ANULADO</div>' : ''}
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Fecha</label>
                                <input type="text" class="form-input" value="${escapeHTML(fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1) + ' ' + horaFormateada)}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cliente</label>
                                <input type="text" class="form-input" value="${escapeHTML(clienteNombre)}" readonly>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Operaci√≥n</label>
                                <input type="text" class="form-input" value="${escapeHTML(movimiento.operacion ? movimiento.operacion.replace('_', ' ') : '')}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo</label>
                                <input type="text" class="form-input" value="${escapeHTML(movimiento.subOperacion || '')}" readonly>
                            </div>
                        </div>
                `;
                
                // Mostrar campos relevantes seg√∫n el tipo de operaci√≥n
                if (movimiento.monto) {
                    detallesHTML += `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Monto</label>
                                <input type="text" class="form-input" value="${escapeHTML(String(movimiento.monto || ''))}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Moneda</label>
                                <input type="text" class="form-input" value="${escapeHTML(monedas.find(m => m.value === movimiento.moneda)?.label || movimiento.moneda || '')}" readonly>
                            </div>
                        </div>
                    `;
                }
                
                if (movimiento.tc) {
                    detallesHTML += `
                        <div class="form-group">
                            <label class="form-label">Tipo de Cambio</label>
                            <input type="text" class="form-input" value="${escapeHTML(String(movimiento.tc || ''))}" readonly>
                        </div>
                    `;
                }
                
                if (movimiento.total) {
                    detallesHTML += `
                        <div class="form-group">
                            <label class="form-label">Total</label>
                            <input type="text" class="form-input" value="${escapeHTML(String(movimiento.total || ''))}" readonly>
                        </div>
                    `;
                }
                
                if (movimiento.detalle) {
                    detallesHTML += `
                        <div class="form-group">
                            <label class="form-label">Detalle</label>
                            <textarea class="form-textarea" readonly>${escapeHTML(movimiento.detalle || '')}</textarea>
                        </div>
                    `;
                }
                
                detallesHTML += `
                        <div class="form-actions">
                            ${!movimiento.anulado ? `<button type="button" class="btn-edit" id="editarMovimientoBtn" data-mov-id="${escapeHTML(movimiento.id)}">Editar</button>` : ''}
                            ${!movimiento.anulado ? `<button type="button" class="btn-cancel" id="anularMovimientoBtn" data-mov-id="${escapeHTML(movimiento.id)}">Anular Movimiento</button>` : ''}
                            <button type="button" class="btn-submit" id="cerrarDetallesBtn">Cerrar</button>
                        </div>
                    </div>
                `;
                
                const container = safeGetElementById('movimientosListContainer');
                if (container) {
                    container.innerHTML = detallesHTML;
                    
                    document.getElementById('cerrarDetallesBtn')?.addEventListener('click', () => {
                        renderMovimientosList();
                    });
                    
                    document.getElementById('editarMovimientoBtn')?.addEventListener('click', () => {
                        editarMovimiento(movimiento);
                    });
                    
                    document.getElementById('anularMovimientoBtn')?.addEventListener('click', () => {
                        if (confirm('¬øEst√°s seguro de anular este movimiento? Se marcar√° como anulado pero permanecer√° visible.')) {
                            anularMovimiento(movimiento.id);
                            showToast('Movimiento anulado', 'success');
                            renderMovimientosList();
                        }
                    });
                }
            }

            function editarMovimiento(movimiento) {
                // Guardar el ID del movimiento que se est√° editando
                editingMovimientoId = movimiento.id;
                
                // Cargar el movimiento en el formulario de operaciones
                formData = JSON.parse(JSON.stringify(movimiento));
                delete formData.id;
                delete formData.fechaCreacion;
                delete formData.anulado;
                delete formData.fechaAnulacion;
                delete formData.fechaModificacion;
                
                saveFormState();
                loadModule('operaciones');
                showToast('Movimiento cargado para editar. Modifica y guarda para actualizar.', 'info');
            }

            /**
             * =================================================================
             * M√ìDULO DE PENDIENTES
             * =================================================================
             */
            function renderPendientesModule() {
                viewingPendienteDetail = null; // Reset al cargar el m√≥dulo
                return `
                    <div class="operations-container">
                        <div class="form-card">
                            <div class="form-header">
                                <button type="button" class="btn-back" id="btnVolverPendientes" title="Volver">‚Üê Volver</button>
                                <h2 class="form-title">‚è≥ Pendientes</h2>
                                <div style="width: 100px;"></div>
                            </div>
                            <div id="pendientesSummaryContainer"></div>
                            <div id="pendientesListContainer"></div>
                            <div id="pendienteDetailContainer" style="display: none;"></div>
                        </div>
                    </div>
                `;
            }

            // Funci√≥n para actualizar el bot√≥n de volver seg√∫n el contexto en el m√≥dulo de pendientes
            function actualizarBotonVolverPendientes() {
                const btnVolver = document.getElementById('btnVolverPendientes');
                if (!btnVolver) return;
                
                // El bot√≥n "Volver" siempre mantiene la l√≥gica de goBack()
                // Las sub-vistas (detalle) no se agregan al historial de m√≥dulos
                btnVolver.onclick = () => {
                    // Si estamos viendo un detalle, primero volver al listado
                    if (viewingPendienteDetail) {
                        viewingPendienteDetail = null;
                        renderPendientesList();
                    } else {
                        // Si estamos en el listado, usar goBack() normal
                        window.goBack();
                    }
                };
                
                // Actualizar el t√≠tulo del bot√≥n seg√∫n el contexto
                if (viewingPendienteDetail) {
                    btnVolver.title = 'Volver al listado de pendientes';
                } else {
                    btnVolver.title = 'Volver';
                }
            }

            function initPendientesModule() {
                renderPendientesList();
                actualizarBotonVolverPendientes();
            }

            function renderPendientesList() {
                const container = safeGetElementById('pendientesListContainer');
                const summaryContainer = safeGetElementById('pendientesSummaryContainer');
                const detailContainer = safeGetElementById('pendienteDetailContainer');
                if (!container) return;
                
                // Si estamos viendo un detalle, no renderizar la lista
                if (viewingPendienteDetail) {
                    if (container) container.style.display = 'none';
                    if (summaryContainer) summaryContainer.style.display = 'none';
                    if (detailContainer) detailContainer.style.display = 'block';
                    return;
                }
                
                // Mostrar lista y resumen, ocultar detalle
                if (container) container.style.display = 'block';
                if (summaryContainer) summaryContainer.style.display = 'block';
                if (detailContainer) detailContainer.style.display = 'none';
                
                // Actualizar bot√≥n de volver cuando volvemos al listado
                actualizarBotonVolverPendientes();
                
                // Usar cache para mejor rendimiento
                const movimientos = getMovimientosCached();
                
                // Optimizar filtrado: validar estructura y filtrar anulados primero
                const pendientes = movimientos.filter(m => {
                    if (!m || typeof m !== 'object') return false;
                    if (m.anulado) return false;
                    const estado = String(m.estado || '').trim();
                    return estado === 'pendiente_retiro' || estado === 'pendiente_entrega';
                });
                
                if (pendientes.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay operaciones pendientes.</p>';
                    if (summaryContainer) summaryContainer.innerHTML = '';
                    return;
                }
                
                // Calcular totales generales
                let totalRetiroGeneral = {};
                let totalEntregaGeneral = {};
                pendientes.forEach(mov => {
                    const monto = safeParseFloat(mov.monto || mov.total || 0);
                    let moneda = mov.moneda || mov.monedaTC || 'ARS';
                    moneda = normalizeMoneda(moneda);
                    
                    if (mov.estado === 'pendiente_retiro') {
                        if (!totalRetiroGeneral[moneda]) totalRetiroGeneral[moneda] = 0;
                        totalRetiroGeneral[moneda] += monto;
                    } else if (mov.estado === 'pendiente_entrega') {
                        if (!totalEntregaGeneral[moneda]) totalEntregaGeneral[moneda] = 0;
                        totalEntregaGeneral[moneda] += monto;
                    }
                });
                
                // Renderizar resumen general
                if (summaryContainer) {
                    let resumenHTML = '<div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--border-color);">';
                    resumenHTML += '<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">üìä Resumen Total</h3>';
                    
                    if (Object.keys(totalRetiroGeneral).length > 0) {
                        const retiroStr = Object.entries(totalRetiroGeneral)
                            .map(([moneda, total]) => {
                                let monedaNorm = normalizeMoneda(moneda);
                                const monedaLabel = monedas.find(m => m.value === monedaNorm)?.label || monedaNorm;
                                return `<strong>${escapeHTML(monedaLabel)}</strong> ${formatNumberWithThousands(total)}`;
                            })
                            .join(' | ');
                        resumenHTML += `<div style="color: var(--error-color); font-size: 15px; font-weight: 600; margin-bottom: 8px; padding: 8px; background: rgba(255, 69, 58, 0.1); border-radius: 8px; white-space: nowrap; overflow-x: auto;">üî¥ TOTAL A RETIRAR: ${retiroStr}</div>`;
                    }
                    
                    if (Object.keys(totalEntregaGeneral).length > 0) {
                        const entregaStr = Object.entries(totalEntregaGeneral)
                            .map(([moneda, total]) => {
                                let monedaNorm = normalizeMoneda(moneda);
                                const monedaLabel = monedas.find(m => m.value === monedaNorm)?.label || monedaNorm;
                                return `<strong>${escapeHTML(monedaLabel)}</strong> ${formatNumberWithThousands(total)}`;
                            })
                            .join(' | ');
                        resumenHTML += `<div style="color: var(--success-color); font-size: 15px; font-weight: 600; padding: 8px; background: rgba(48, 209, 88, 0.1); border-radius: 8px; white-space: nowrap; overflow-x: auto;">üü¢ TOTAL A ENTREGAR: ${entregaStr}</div>`;
                    }
                    
                    resumenHTML += '</div>';
                    summaryContainer.innerHTML = resumenHTML;
                }
                
                // Agrupar por cliente
                const pendientesPorCliente = {};
                pendientes.forEach(mov => {
                    if (!mov || !mov.id) return; // Validar que el movimiento sea v√°lido
                    const clienteId = mov.cliente || 'sin_cliente';
                    
                    // Inicializar el objeto del cliente si no existe
                    if (!pendientesPorCliente[clienteId]) {
                        const clienteCompleto = getClienteCompleto(clienteId);
                        pendientesPorCliente[clienteId] = {
                            clienteId: clienteId,
                            clienteNombre: getClienteNombre(clienteId),
                            clienteDireccion: clienteCompleto?.direccion || '',
                            clienteTelefono: clienteCompleto?.telefono || '',
                            clienteTelefonoRespaldo: clienteCompleto?.telefonoRespaldo || '',
                            movimientos: [],
                            totalRetiro: 0,
                            totalEntrega: 0,
                            monedasRetiro: {},
                            monedasEntrega: {}
                        };
                    }
                    
                    pendientesPorCliente[clienteId].movimientos.push(mov);
                    
                    // Calcular totales por tipo
                    const monto = safeParseFloat(mov.monto || mov.total || 0);
                    let moneda = mov.moneda || mov.monedaTC || 'ARS';
                    moneda = normalizeMoneda(moneda);
                    
                    const estado = mov.estado || '';
                    if (estado === 'pendiente_retiro') {
                        pendientesPorCliente[clienteId].totalRetiro += monto;
                        if (!pendientesPorCliente[clienteId].monedasRetiro[moneda]) {
                            pendientesPorCliente[clienteId].monedasRetiro[moneda] = 0;
                        }
                        pendientesPorCliente[clienteId].monedasRetiro[moneda] += monto;
                    } else if (estado === 'pendiente_entrega') {
                        pendientesPorCliente[clienteId].totalEntrega += monto;
                        if (!pendientesPorCliente[clienteId].monedasEntrega[moneda]) {
                            pendientesPorCliente[clienteId].monedasEntrega[moneda] = 0;
                        }
                        pendientesPorCliente[clienteId].monedasEntrega[moneda] += monto;
                    }
                });
                
                // Verificar que hay grupos de clientes
                const gruposClientes = Object.values(pendientesPorCliente);
                if (gruposClientes.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay operaciones pendientes.</p>';
                    if (summaryContainer) summaryContainer.innerHTML = '';
                    return;
                }
                
                // Renderizar por cliente
                container.innerHTML = gruposClientes.map(grupo => {
                    const fechaCreacion = new Date(grupo.movimientos[0].fechaCreacion);
                    const fechaFormateada = fechaCreacion.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    
                    let resumenHTML = '';
                    if (grupo.totalRetiro > 0) {
                        const monedasRetiroStr = Object.entries(grupo.monedasRetiro)
                            .map(([moneda, total]) => {
                                let monedaNorm = normalizeMoneda(moneda);
                                const monedaLabel = monedas.find(m => m.value === monedaNorm)?.label || monedaNorm;
                                return `${escapeHTML(monedaLabel)} ${formatNumberWithThousands(total)}`;
                            })
                            .join(', ');
                        resumenHTML += `<p style="color: var(--error-color); font-size: 14px; font-weight: 600; margin: 8px 0 4px 0;">üî¥ RETIRAR: ${monedasRetiroStr}</p>`;
                    }
                    if (grupo.totalEntrega > 0) {
                        const monedasEntregaStr = Object.entries(grupo.monedasEntrega)
                            .map(([moneda, total]) => {
                                let monedaNorm = normalizeMoneda(moneda);
                                const monedaLabel = monedas.find(m => m.value === monedaNorm)?.label || monedaNorm;
                                return `${escapeHTML(monedaLabel)} ${formatNumberWithThousands(total)}`;
                            })
                            .join(', ');
                        resumenHTML += `<p style="color: var(--success-color); font-size: 14px; font-weight: 600; margin: 4px 0 8px 0;">üü¢ ENTREGAR: ${monedasEntregaStr}</p>`;
                    }
                    
                    // Informaci√≥n de contacto y direcci√≥n
                    let contactoHTML = '';
                    if (grupo.clienteTelefono) {
                        contactoHTML += `<p style="color: var(--text-primary); font-size: 14px; margin: 8px 0 4px 0;"><strong>üìû Contacto:</strong> ${grupo.clienteTelefono}`;
                        if (grupo.clienteTelefonoRespaldo) {
                            contactoHTML += ` / ${grupo.clienteTelefonoRespaldo}`;
                        }
                        contactoHTML += `</p>`;
                    }
                    
                    let direccionHTML = '';
                    if (grupo.clienteDireccion) {
                        direccionHTML = `<p style="color: var(--text-primary); font-size: 14px; margin: 4px 0 8px 0;"><strong>üìç D√≥nde ${grupo.totalRetiro > 0 && grupo.totalEntrega > 0 ? 'retirar/entregar' : grupo.totalRetiro > 0 ? 'retirar' : 'entregar'}:</strong> ${escapeHTML(grupo.clienteDireccion)}</p>`;
                    }
                    
                    return `
                        <div class="pendiente-cliente-card" style="padding: 16px; margin-bottom: 16px; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); align-items: center; overflow: hidden;">
                                <div style="min-width: 0; overflow: hidden;">
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(grupo.clienteNombre)}</h3>
                                    <p style="color: var(--text-secondary); font-size: 12px; margin: 2px 0;">${grupo.movimientos.length} operaci√≥n${grupo.movimientos.length > 1 ? 'es' : ''}</p>
                                </div>
                                <div style="font-size: 12px; min-width: 0; overflow: hidden;">
                                    ${grupo.clienteTelefono ? `<div style="color: var(--text-primary); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìû ${escapeHTML(grupo.clienteTelefono)}</div>` : ''}
                                    ${grupo.clienteTelefonoRespaldo ? `<div style="color: var(--text-secondary); font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(grupo.clienteTelefonoRespaldo)}</div>` : ''}
                                </div>
                                <div style="font-size: 12px; color: var(--text-primary); min-width: 0; overflow: hidden;">
                                    ${grupo.clienteDireccion ? `<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìç ${escapeHTML(grupo.clienteDireccion)}</div>` : ''}
                                </div>
                                <div style="text-align: right; flex-shrink: 0;">
                                    ${grupo.totalRetiro > 0 ? `<div style="color: var(--error-color); font-size: 13px; font-weight: 600; margin-bottom: 2px; white-space: nowrap;">üî¥ ${Object.entries(grupo.monedasRetiro).map(([m, t]) => {
                                        const monedaNorm = normalizeMoneda(m);
                                        const monedaLabel = monedas.find(mon => mon.value === monedaNorm)?.label || monedaNorm;
                                        return `${escapeHTML(monedaLabel)} ${formatNumberWithThousands(t)}`;
                                    }).join(', ')}</div>` : ''}
                                    ${grupo.totalEntrega > 0 ? `<div style="color: var(--success-color); font-size: 13px; font-weight: 600; white-space: nowrap;">üü¢ ${Object.entries(grupo.monedasEntrega).map(([m, t]) => {
                                        const monedaNorm = normalizeMoneda(m);
                                        const monedaLabel = monedas.find(mon => mon.value === monedaNorm)?.label || monedaNorm;
                                        return `${escapeHTML(monedaLabel)} ${formatNumberWithThousands(t)}`;
                                    }).join(', ')}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="pendientes-operaciones-list">
                                ${grupo.movimientos.map(mov => {
                                    const fechaMov = new Date(mov.fechaCreacion);
                                    const fechaMovFormateada = fechaMov.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                                    const horaMov = fechaMov.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                                    const operacionLabel = mov.operacion ? mov.operacion.replace('_', ' ') : '';
                                    const subOperacionLabel = mov.subOperacion || '';
                                    const montoMov = safeParseFloat(mov.monto || mov.total || 0);
                                    // Normalizar moneda
                                    let monedaMov = mov.moneda || mov.monedaTC || 'ARS';
                                    monedaMov = normalizeMoneda(monedaMov);
                                    const monedaLabel = monedas.find(m => m.value === monedaMov)?.label || monedaMov;
                                    const tipoPendiente = mov.estado === 'pendiente_retiro' ? 'P. RETIRO' : 'P. ENTREGA';
                                    const colorTipo = mov.estado === 'pendiente_retiro' ? 'var(--error-color)' : 'var(--success-color)';
                                    
                                    // Obtener informaci√≥n de wallet
                                    let walletNombre = '';
                                    if (mov.estado === 'pendiente_retiro') {
                                        const walletRetiro = mov.walletCompra || mov.walletTC || mov.walletBase || '';
                                        if (walletRetiro && walletRetiro !== 'pago_mixto') {
                                            walletNombre = getWalletNombre(walletRetiro) || '';
                                        }
                                    } else if (mov.estado === 'pendiente_entrega') {
                                        const walletEntrega = mov.walletCompra || mov.walletTC || mov.walletProfit || '';
                                        if (walletEntrega && walletEntrega !== 'pago_mixto') {
                                            walletNombre = getWalletNombre(walletEntrega) || '';
                                        }
                                    }
                                    
                                    return `
                                        <div class="pendiente-operacion-row" style="display: grid; grid-template-columns: auto 2fr 1fr 1fr auto auto; gap: 12px; padding: 10px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 8px; align-items: center; border-left: 3px solid ${colorTipo}; overflow: hidden; cursor: pointer;" data-mov-id="${escapeHTML(mov.id)}" data-action="ver-detalle">
                                            <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: ${colorTipo === 'var(--error-color)' ? 'rgba(255, 69, 58, 0.1)' : 'rgba(48, 209, 88, 0.1)'}; color: ${colorTipo}; font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                                                ${tipoPendiente}
                                            </span>
                                            <div style="min-width: 0; overflow: hidden;">
                                                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(operacionLabel)} ${subOperacionLabel ? '> ' + escapeHTML(subOperacionLabel) : ''}</div>
                                                ${walletNombre ? `<div style="font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üí≥ ${escapeHTML(walletNombre)}</div>` : ''}
                                                ${mov.detalle ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(mov.detalle.substring(0, 40))}${mov.detalle.length > 40 ? '...' : ''}</div>` : ''}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary); min-width: 0; white-space: nowrap;">${escapeHTML(fechaMovFormateada)}<br>${escapeHTML(horaMov)}</div>
                                            <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; white-space: nowrap; flex-shrink: 0;">${escapeHTML(monedaLabel)} ${formatNumberWithThousands(montoMov)}</div>
                                            <button type="button" class="btn-submit" style="font-size: 11px; padding: 6px 12px; white-space: nowrap; flex-shrink: 0;" data-mov-id="${escapeHTML(mov.id)}" data-action="finalizar">
                                                Finalizar
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Remover event listeners anteriores usando una funci√≥n nombrada
                if (container._pendientesClickHandler) {
                    container.removeEventListener('click', container._pendientesClickHandler);
                }
                
                // Crear nuevo handler
                container._pendientesClickHandler = (e) => {
                    // Finalizar - debe ir primero para evitar conflictos
                    const finalizarBtn = e.target.closest('[data-action="finalizar"]');
                    if (finalizarBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const movimientoId = finalizarBtn.dataset.movId;
                        if (movimientoId && confirm('¬øMarcar esta operaci√≥n como finalizada? Desaparecer√° de la lista de pendientes.')) {
                            updateMovimiento(movimientoId, { estado: 'realizado' });
                            showToast('Operaci√≥n marcada como finalizada', 'success');
                            renderPendientesList();
                        }
                        return false;
                    }
                    
                    // Ver detalle - solo si no se hizo clic en el bot√≥n finalizar
                    const detalleRow = e.target.closest('[data-action="ver-detalle"]');
                    if (detalleRow && !e.target.closest('[data-action="finalizar"]')) {
                        const movimientoId = detalleRow.dataset.movId;
                        if (movimientoId) {
                            showPendienteDetail(movimientoId);
                        }
                        return false;
                    }
                };
                
                // Agregar event listener
                container.addEventListener('click', container._pendientesClickHandler);
            }
            
            function showPendienteDetail(movimientoId) {
                const movimientos = getMovimientos();
                const movimiento = movimientos.find(m => m.id === movimientoId);
                if (!movimiento) return;
                
                viewingPendienteDetail = movimientoId;
                const detailContainer = document.getElementById('pendienteDetailContainer');
                if (!detailContainer) return;
                
                // Obtener informaci√≥n completa
                const clienteCompleto = getClienteCompleto(movimiento.cliente);
                const fechaMov = new Date(movimiento.fechaCreacion);
                const fechaFormateada = fechaMov.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const horaFormateada = fechaMov.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                // Construir HTML del detalle
                let detailHTML = `
                    <div style="padding: 20px;">
                        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">Detalle de Operaci√≥n</h2>
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 2px solid var(--border-color);">
                `;
                
                // Informaci√≥n b√°sica
                detailHTML += `
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Informaci√≥n General</h3>
                        <div style="display: grid; gap: 8px;">
                            <div><strong>Operaci√≥n:</strong> ${movimiento.operacion ? movimiento.operacion.replace('_', ' ') : 'N/A'}</div>
                            <div><strong>Sub-operaci√≥n:</strong> ${movimiento.subOperacion || 'N/A'}</div>
                            <div><strong>Fecha:</strong> ${fechaFormateada} ${horaFormateada}</div>
                            <div><strong>Estado:</strong> <span style="color: ${movimiento.estado === 'pendiente_retiro' ? 'var(--error-color)' : 'var(--success-color)'}; font-weight: 600;">${movimiento.estado === 'pendiente_retiro' ? 'üî¥ PENDIENTE RETIRO' : 'üü¢ PENDIENTE ENTREGA'}</span></div>
                        </div>
                    </div>
                `;
                
                // Informaci√≥n de cliente
                if (clienteCompleto) {
                    detailHTML += `
                        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Cliente</h3>
                            <div style="display: grid; gap: 8px;">
                                <div><strong>Nombre:</strong> ${clienteCompleto.nombre || 'N/A'}</div>
                                ${clienteCompleto.documento ? `<div><strong>DNI:</strong> ${clienteCompleto.documento}</div>` : ''}
                                ${clienteCompleto.telefono ? `<div><strong>Tel√©fono:</strong> ${clienteCompleto.telefono}</div>` : ''}
                                ${clienteCompleto.telefonoRespaldo ? `<div><strong>Tel√©fono Respaldo:</strong> ${clienteCompleto.telefonoRespaldo}</div>` : ''}
                                ${clienteCompleto.direccion ? `<div><strong>Direcci√≥n:</strong> ${clienteCompleto.direccion}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Informaci√≥n financiera
                const monto = safeParseFloat(movimiento.monto || movimiento.total || 0);
                const moneda = movimiento.moneda || movimiento.monedaTC || 'ARS';
                const monedaLabel = monedas.find(m => m.value === moneda)?.label || moneda;
                
                detailHTML += `
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Informaci√≥n Financiera</h3>
                        <div style="display: grid; gap: 8px;">
                            <div><strong>Monto:</strong> ${monedaLabel} ${formatNumberWithThousands(monto)}</div>
                            ${movimiento.tc ? `<div><strong>Tipo de Cambio:</strong> ${formatNumberWithThousands(movimiento.tc)}</div>` : ''}
                            ${movimiento.total ? `<div><strong>Total:</strong> ${formatNumberWithThousands(movimiento.total)}</div>` : ''}
                        </div>
                    </div>
                `;
                
                // Informaci√≥n de wallets
                let walletInfo = [];
                if (movimiento.walletCompra) walletInfo.push(`Wallet Compra: ${getWalletNombre(movimiento.walletCompra) || movimiento.walletCompra}`);
                if (movimiento.walletTC) walletInfo.push(`Wallet TC: ${getWalletNombre(movimiento.walletTC) || movimiento.walletTC}`);
                if (movimiento.walletBase) walletInfo.push(`Wallet Base: ${getWalletNombre(movimiento.walletBase) || movimiento.walletBase}`);
                if (movimiento.walletProfit) walletInfo.push(`Wallet Profit: ${getWalletNombre(movimiento.walletProfit) || movimiento.walletProfit}`);
                
                if (walletInfo.length > 0) {
                    detailHTML += `
                        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Wallets</h3>
                            <div style="display: grid; gap: 8px;">
                                ${walletInfo.map(w => `<div>üí≥ ${escapeHTML(w)}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Detalle adicional
                if (movimiento.detalle) {
                    detailHTML += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Detalle</h3>
                            <div style="color: var(--text-secondary);">${movimiento.detalle}</div>
                        </div>
                    `;
                }
                
                detailHTML += `
                        </div>
                    </div>
                `;
                
                detailContainer.innerHTML = detailHTML;
                renderPendientesList(); // Esto ocultar√° la lista y mostrar√° el detalle
                
                // Actualizar el bot√≥n del header cuando se muestra el detalle
                actualizarBotonVolverPendientes();
            }

            function renderClientesList() {
                const container = safeGetElementById('clientesListContainer');
                if (!container) return;
                
                const clientes = getClientes();
                
                if (clientes.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay clientes registrados.</p>';
                    return;
                }
                
                container.innerHTML = clientes.map(cliente => {
                    const diasTranscurridos = calcularDiasDesdeUltimaOperacion(cliente.ultimaOperacion);
                    const fechaFormateada = formatearFechaUltimaOperacion(cliente.ultimaOperacion);
                    const colorDias = diasTranscurridos === null ? 'var(--text-secondary)' : 
                                     diasTranscurridos === 0 ? 'var(--success-color)' : 
                                     diasTranscurridos <= 7 ? 'var(--text-primary)' : 
                                     diasTranscurridos <= 30 ? '#ffa500' : 'var(--error-color)';
                    
                    return `
                    <div class="form-card" style="padding: 20px; margin-bottom: 16px; overflow: hidden;">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 16px; align-items: start;">
                            <div style="min-width: 0; overflow: hidden;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                                    <h3 style="font-size: 18px; font-weight: 600; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(cliente.nombre)}</h3>
                                    <span style="font-size: 11px; padding: 2px 8px; border-radius: 12px; background: ${cliente.tipo === 'prestamista' ? 'rgba(119, 171, 255, 0.2)' : cliente.tipo === 'cuenta_corriente' ? 'rgba(48, 209, 88, 0.1)' : 'var(--bg-secondary)'}; color: ${cliente.tipo === 'prestamista' ? 'var(--button-bg)' : cliente.tipo === 'cuenta_corriente' ? 'var(--success-color)' : 'var(--text-secondary)'};">
                                        ${cliente.tipo === 'prestamista' ? 'Prestamista' : cliente.tipo === 'cuenta_corriente' ? 'Cuenta Corriente' : 'Diario'}
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                    ${cliente.documento ? `<div><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">üÜî DNI: ${cliente.documento}</p></div>` : ''}
                                    ${cliente.telefono ? `<div><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">üìû ${cliente.telefono}</p></div>` : ''}
                                    ${cliente.telefonoRespaldo ? `<div><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">üì± Respaldo: ${cliente.telefonoRespaldo}</p></div>` : ''}
                                    ${cliente.email ? `<div><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">‚úâÔ∏è ${escapeHTML(cliente.email)}</p></div>` : ''}
                                    ${cliente.direccion ? `<div style="grid-column: 1 / -1;"><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">üìç ${escapeHTML(cliente.direccion)}</p></div>` : ''}
                                    ${cliente.recomendado ? `<div><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">üë§ Recomendado de: ${escapeHTML(cliente.recomendado)}</p></div>` : ''}
                                </div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                    <div>
                                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                            <strong style="color: var(--text-primary);">√öltima operaci√≥n:</strong> 
                                            <span style="color: ${colorDias}; font-weight: 600;">${fechaFormateada}</span>
                                        </p>
                                    </div>
                                    ${diasTranscurridos !== null ? `
                                        <div>
                                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                                <strong style="color: var(--text-primary);">D√≠as transcurridos:</strong> 
                                                <span style="color: ${colorDias}; font-weight: 600;">
                                                    ${diasTranscurridos === 0 ? 'Hoy' : diasTranscurridos === 1 ? '1 d√≠a' : `${diasTranscurridos} d√≠as`}
                                                </span>
                                            </p>
                                        </div>
                                    ` : '<div><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">Sin operaciones registradas</p></div>'}
                                </div>
                                ${cliente.notas ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);"><p style="color: var(--text-secondary); font-size: 13px; margin: 0;">${escapeHTML(cliente.notas)}</p></div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button type="button" class="btn-edit" data-cliente-id="${escapeHTML(cliente.id)}" style="padding: 8px 12px; font-size: 13px;" title="Editar cliente">‚úèÔ∏è</button>
                                <button type="button" class="btn-remove" data-cliente-id="${escapeHTML(cliente.id)}" style="flex-shrink: 0;" title="Eliminar cliente">‚úï</button>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            ID: ${cliente.id}
                        </div>
                    </div>
                    `;
                }).join('');
                
                // Remover event listeners anteriores usando una funci√≥n nombrada
                if (container._clientesClickHandler) {
                    container.removeEventListener('click', container._clientesClickHandler);
                }
                
                // Crear nuevo handler
                container._clientesClickHandler = (e) => {
                    // Editar cliente
                    if (e.target.classList.contains('btn-edit') || e.target.closest('.btn-edit')) {
                        const btn = e.target.classList.contains('btn-edit') ? e.target : e.target.closest('.btn-edit');
                        const clienteId = btn.dataset.clienteId;
                        cargarClienteParaEditar(clienteId);
                    }
                    
                    // Eliminar cliente
                    if (e.target.classList.contains('btn-remove') || e.target.closest('.btn-remove')) {
                        const btn = e.target.classList.contains('btn-remove') ? e.target : e.target.closest('.btn-remove');
                        const clienteId = btn.dataset.clienteId;
                        const clientesList = getClientes(); // Obtener clientes dentro del event listener
                        const cliente = clientesList.find(c => c.id === clienteId);
                        if (cliente && confirm(`¬øEliminar el cliente "${cliente.nombre}"?`)) {
                            deleteCliente(clienteId);
                            showToast('Cliente eliminado', 'success');
                            renderClientesList();
                        }
                    }
                };
                
                // Agregar event listener
                container.addEventListener('click', container._clientesClickHandler);
            }

            /**
             * =================================================================
             * M√ìDULO DE SALDOS
             * =================================================================
             */
            function renderSaldosModule() {
                return `
                    <div class="operations-container" style="max-width: 100%;">
                        <div class="form-card">
                            <div class="form-header">
                                <button type="button" class="btn-back" onclick="window.goBack()" title="Volver">‚Üê Volver</button>
                                <h2 class="form-title">üí∞ Saldos de Wallets</h2>
                                <div style="width: 100px;"></div>
                            </div>
                            <div id="saldosListContainer"></div>
                        </div>
                    </div>
                `;
            }

            // Cache para saldos de wallets
            let saldosCache = null;
            let saldosCacheTimestamp = null;
            const SALDOS_CACHE_DURATION = 2000; // 2 segundos de cache

            function invalidateSaldosCache() {
                saldosCache = null;
                saldosCacheTimestamp = null;
            }

            function calcularSaldosWallets() {
                // Verificar cache
                const now = Date.now();
                if (saldosCache && saldosCacheTimestamp && (now - saldosCacheTimestamp) < SALDOS_CACHE_DURATION) {
                    return saldosCache;
                }
                
                const wallets = getWallets();
                const movimientos = getMovimientosCached().filter(m => {
                    // Validar estructura del movimiento antes de procesar
                    if (!m || typeof m !== 'object') return false;
                    if (!m.operacion || !m.subOperacion) return false;
                    return !m.anulado;
                });
                const saldos = {};

                // Inicializar saldos para todas las wallets
                wallets.forEach(wallet => {
                    saldos[wallet.id] = {};
                });

                // Funci√≥n helper para obtener el ID de wallet sin el tipo
                const getWalletIdOnly = (walletValue) => {
                    if (!walletValue || walletValue === 'pago_mixto') return null;
                    const parsed = parseWalletId(walletValue);
                    return parsed.wallet === 'pago_mixto' ? null : parsed.wallet;
                };

                // Procesar cada movimiento
                movimientos.forEach(mov => {
                    const operacion = mov.operacion;
                    const subOperacion = mov.subOperacion;
                    let moneda = mov.moneda || mov.monedaTC || 'ARS';
                    moneda = normalizeMoneda(moneda);
                    const monto = safeParseFloat(mov.monto || 0);
                    const total = safeParseFloat(mov.total || monto);

                    // WALLET - INGRESO: suma a walletCompra
                    if (operacion === 'WALLET' && subOperacion === 'INGRESO' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] += monto;
                        }
                    }

                    // WALLET - SALIDA: resta de walletCompra
                    if (operacion === 'WALLET' && subOperacion === 'SALIDA' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] -= monto;
                        }
                    }

                    // TRANSACCIONES - COMPRA: resta de walletCompra (moneda de pago), suma a walletTC (moneda comprada)
                    if (operacion === 'TRANSACCIONES' && subOperacion === 'COMPRA') {
                        let monedaPago = mov.moneda || 'ARS';
                        let monedaComprada = mov.monedaTC || 'USD';
                        monedaPago = normalizeMoneda(monedaPago);
                        monedaComprada = normalizeMoneda(monedaComprada);
                        
                        // Manejar pagos mixtos
                        if (mov.mixedPayments && Array.isArray(mov.mixedPayments) && mov.mixedPayments.length > 0) {
                            // Procesar cada pago mixto individualmente
                            mov.mixedPayments.forEach(payment => {
                                if (payment && payment.wallet && payment.monto) {
                                    const paymentWalletId = getWalletIdOnly(payment.wallet);
                                    const paymentMoneda = normalizeMoneda(payment.moneda || monedaPago);
                                    const paymentMonto = safeParseFloat(payment.monto);
                                    
                                    if (paymentWalletId && paymentMonto > 0) {
                                        if (!saldos[paymentWalletId]) saldos[paymentWalletId] = {};
                                        if (!saldos[paymentWalletId][paymentMoneda]) saldos[paymentWalletId][paymentMoneda] = 0;
                                        saldos[paymentWalletId][paymentMoneda] -= paymentMonto;
                                    }
                                }
                            });
                        } else {
                            // Pago normal (no mixto)
                            const walletCompraId = getWalletIdOnly(mov.walletCompra);
                            const walletTCId = getWalletIdOnly(mov.walletTC);
                            if (walletCompraId) {
                                if (!saldos[walletCompraId]) saldos[walletCompraId] = {};
                                if (!saldos[walletCompraId][monedaPago]) saldos[walletCompraId][monedaPago] = 0;
                                saldos[walletCompraId][monedaPago] -= total;
                            }
                            if (walletTCId) {
                                if (!saldos[walletTCId]) saldos[walletTCId] = {};
                                if (!saldos[walletTCId][monedaComprada]) saldos[walletTCId][monedaComprada] = 0;
                                saldos[walletTCId][monedaComprada] += monto;
                            }
                        }
                    }

                    // TRANSACCIONES - VENTA: suma a walletCompra (moneda recibida), resta de walletTC (moneda vendida)
                    if (operacion === 'TRANSACCIONES' && subOperacion === 'VENTA') {
                        let monedaRecibida = mov.moneda || 'ARS';
                        let monedaVendida = mov.monedaTC || 'USD';
                        monedaRecibida = normalizeMoneda(monedaRecibida);
                        monedaVendida = normalizeMoneda(monedaVendida);
                        
                        // Manejar pagos mixtos
                        if (mov.mixedPayments && Array.isArray(mov.mixedPayments) && mov.mixedPayments.length > 0) {
                            // Procesar cada pago mixto individualmente
                            mov.mixedPayments.forEach(payment => {
                                if (payment && payment.wallet && payment.monto) {
                                    const paymentWalletId = getWalletIdOnly(payment.wallet);
                                    const paymentMoneda = normalizeMoneda(payment.moneda || monedaRecibida);
                                    const paymentMonto = safeParseFloat(payment.monto);
                                    
                                    if (paymentWalletId && paymentMonto > 0) {
                                        if (!saldos[paymentWalletId]) saldos[paymentWalletId] = {};
                                        if (!saldos[paymentWalletId][paymentMoneda]) saldos[paymentWalletId][paymentMoneda] = 0;
                                        saldos[paymentWalletId][paymentMoneda] += paymentMonto;
                                    }
                                }
                            });
                        } else {
                            // Pago normal (no mixto)
                            const walletCompraId = getWalletIdOnly(mov.walletCompra);
                            const walletTCId = getWalletIdOnly(mov.walletTC);
                            if (walletCompraId) {
                                if (!saldos[walletCompraId]) saldos[walletCompraId] = {};
                                if (!saldos[walletCompraId][monedaRecibida]) saldos[walletCompraId][monedaRecibida] = 0;
                                saldos[walletCompraId][monedaRecibida] += total;
                            }
                            if (walletTCId) {
                                if (!saldos[walletTCId]) saldos[walletTCId] = {};
                                if (!saldos[walletTCId][monedaVendida]) saldos[walletTCId][monedaVendida] = 0;
                                saldos[walletTCId][monedaVendida] -= monto;
                            }
                        }
                    }

                    // TRANSACCIONES - ARBITRAJE: walletBase resta, walletProfit suma
                    if (operacion === 'TRANSACCIONES' && subOperacion === 'ARBITRAJE') {
                        let monedaBase = mov.moneda || 'ARS';
                        let monedaProfit = mov.monedaProfit || 'USD';
                        monedaBase = normalizeMoneda(monedaBase);
                        monedaProfit = normalizeMoneda(monedaProfit);
                        const walletBaseId = getWalletIdOnly(mov.walletBase);
                        const walletProfitId = getWalletIdOnly(mov.walletProfit);
                        if (walletBaseId) {
                            if (!saldos[walletBaseId]) saldos[walletBaseId] = {};
                            if (!saldos[walletBaseId][monedaBase]) saldos[walletBaseId][monedaBase] = 0;
                            saldos[walletBaseId][monedaBase] -= safeParseFloat(mov.costoReal || total);
                        }
                        if (walletProfitId) {
                            if (!saldos[walletProfitId]) saldos[walletProfitId] = {};
                            if (!saldos[walletProfitId][monedaProfit]) saldos[walletProfitId][monedaProfit] = 0;
                            saldos[walletProfitId][monedaProfit] += safeParseFloat(mov.profit || 0);
                        }
                    }

                    // CUENTAS_CORRIENTES - INGRESO: suma a walletCompra
                    if (operacion === 'CUENTAS_CORRIENTES' && subOperacion === 'INGRESO' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] += monto;
                        }
                    }

                    // CUENTAS_CORRIENTES - EGRESO: resta de walletCompra
                    if (operacion === 'CUENTAS_CORRIENTES' && subOperacion === 'EGRESO' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] -= monto;
                        }
                    }

                    // CUENTAS_CORRIENTES - COMPRA/VENTA: similar a TRANSACCIONES
                    if (operacion === 'CUENTAS_CORRIENTES' && (subOperacion === 'COMPRA' || subOperacion === 'VENTA')) {
                        let monedaPago = mov.moneda || 'ARS';
                        let monedaOperacion = mov.monedaTC || 'USD';
                        monedaPago = normalizeMoneda(monedaPago);
                        monedaOperacion = normalizeMoneda(monedaOperacion);
                        const walletCompraId = getWalletIdOnly(mov.walletCompra);
                        const walletTCId = getWalletIdOnly(mov.walletTC);
                        if (subOperacion === 'COMPRA') {
                            if (walletCompraId) {
                                if (!saldos[walletCompraId]) saldos[walletCompraId] = {};
                                if (!saldos[walletCompraId][monedaPago]) saldos[walletCompraId][monedaPago] = 0;
                                saldos[walletCompraId][monedaPago] -= total;
                            }
                            if (walletTCId) {
                                if (!saldos[walletTCId]) saldos[walletTCId] = {};
                                if (!saldos[walletTCId][monedaOperacion]) saldos[walletTCId][monedaOperacion] = 0;
                                saldos[walletTCId][monedaOperacion] += monto;
                            }
                        } else { // VENTA
                            if (walletCompraId) {
                                if (!saldos[walletCompraId]) saldos[walletCompraId] = {};
                                if (!saldos[walletCompraId][monedaPago]) saldos[walletCompraId][monedaPago] = 0;
                                saldos[walletCompraId][monedaPago] += total;
                            }
                            if (walletTCId) {
                                if (!saldos[walletTCId]) saldos[walletTCId] = {};
                                if (!saldos[walletTCId][monedaOperacion]) saldos[walletTCId][monedaOperacion] = 0;
                                saldos[walletTCId][monedaOperacion] -= monto;
                            }
                        }
                    }

                    // ADMINISTRATIVAS - AJUSTE: puede sumar o restar seg√∫n el signo
                    if (operacion === 'ADMINISTRATIVAS' && subOperacion === 'AJUSTE' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                        // El ajuste puede ser positivo o negativo seg√∫n el monto
                            saldos[walletId][moneda] += monto;
                        }
                    }

                    // ADMINISTRATIVAS - GASTO: resta de walletCompra
                    if (operacion === 'ADMINISTRATIVAS' && subOperacion === 'GASTO' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] -= monto;
                        }
                    }

                    // WALLET - PRESTAMO: resta de walletCompra (prestamos dinero)
                    if (operacion === 'WALLET' && subOperacion === 'PRESTAMO' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] -= monto;
                        }
                    }

                    // WALLET - DEVOLUCION: suma a walletCompra (nos devuelven dinero)
                    if (operacion === 'WALLET' && subOperacion === 'DEVOLUCION' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] += monto;
                        }
                    }

                    // PRESTAMISTAS - PRESTAMO: resta de walletCompra
                    if (operacion === 'PRESTAMISTAS' && subOperacion === 'PRESTAMO' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] -= total;
                        }
                    }

                    // PRESTAMISTAS - RETIRO: resta de walletCompra
                    if (operacion === 'PRESTAMISTAS' && subOperacion === 'RETIRO' && mov.walletCompra) {
                        const walletId = getWalletIdOnly(mov.walletCompra);
                        if (walletId) {
                            if (!saldos[walletId]) saldos[walletId] = {};
                            if (!saldos[walletId][moneda]) saldos[walletId][moneda] = 0;
                            saldos[walletId][moneda] -= monto;
                        }
                    }

                    // WALLET - MOV ENTRE CUENTAS: resta de cuentaSalida, suma a cuentaIngreso
                    if (operacion === 'WALLET' && subOperacion === 'MOV ENTRE CUENTAS') {
                        const walletSalida = mov.cuentaSalida || mov.walletBase;
                        const walletIngreso = mov.cuentaIngreso || mov.walletProfit;
                        const walletSalidaId = getWalletIdOnly(walletSalida);
                        const walletIngresoId = getWalletIdOnly(walletIngreso);
                        if (walletSalidaId) {
                            if (!saldos[walletSalidaId]) saldos[walletSalidaId] = {};
                            if (!saldos[walletSalidaId][moneda]) saldos[walletSalidaId][moneda] = 0;
                            saldos[walletSalidaId][moneda] -= monto;
                        }
                        if (walletIngresoId) {
                            if (!saldos[walletIngresoId]) saldos[walletIngresoId] = {};
                            if (!saldos[walletIngresoId][moneda]) saldos[walletIngresoId][moneda] = 0;
                            saldos[walletIngresoId][moneda] += monto;
                        }
                    }
                });

                // Guardar en cache
                saldosCache = saldos;
                saldosCacheTimestamp = Date.now();

                return saldos;
            }

            function renderSaldosList() {
                const container = safeGetElementById('saldosListContainer');
                if (!container) return;

                const wallets = getWallets();
                const saldos = calcularSaldosWallets();

                if (wallets.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center;">No hay wallets creadas. Ve a Operaciones > WALLET > CREAR WALLET para crear una.</p>';
                    return;
                }

                // Obtener todas las monedas √∫nicas que tienen saldo en alguna wallet
                const todasLasMonedas = new Set();
                wallets.forEach(wallet => {
                    const walletSaldos = saldos[wallet.id] || {};
                    Object.keys(walletSaldos).forEach(moneda => {
                        if (Math.abs(walletSaldos[moneda]) > 0.01) {
                            todasLasMonedas.add(moneda);
                        }
                    });
                });
                
                // Si no hay monedas con saldo, mostrar al menos las monedas principales
                if (todasLasMonedas.size === 0) {
                    ['ARS', 'USD', 'USDT'].forEach(m => todasLasMonedas.add(m));
                }

                let html = '';
                wallets.forEach(wallet => {
                    const walletSaldos = saldos[wallet.id] || {};
                    const monedasConSaldo = Array.from(todasLasMonedas).filter(moneda => {
                        const saldo = walletSaldos[moneda] || 0;
                        return Math.abs(saldo) > 0.01;
                    });

                    // Mostrar todas las wallets, incluso si no tienen saldo
                    html += `
                        <div class="form-card" style="padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">üí≥ ${wallet.nombre}</h3>
                                    <p style="color: var(--text-secondary); font-size: 12px;">ID: ${wallet.id}</p>
                                </div>
                            </div>
                            ${monedasConSaldo.length > 0 ? `
                                <div style="display: grid; gap: 10px;">
                                    ${monedasConSaldo.map(moneda => {
                                        const saldo = walletSaldos[moneda] || 0;
                                        const monedaLabel = monedas.find(m => m.value === moneda)?.label || moneda;
                                        const esNegativo = saldo < 0;
                                        const esCero = Math.abs(saldo) < 0.01;
                                        return `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color);">
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <span style="font-weight: 600; font-size: 15px;">${monedaLabel}</span>
                                                    ${esNegativo ? '<span style="font-size: 11px; color: var(--error-color);">(Negativo)</span>' : ''}
                                                </div>
                                                <span style="font-size: 16px; font-weight: 600; color: ${esNegativo ? 'var(--error-color)' : esCero ? 'var(--text-secondary)' : 'var(--success-color)'};">
                                                    ${esNegativo ? '-' : ''}${formatNumberWithThousands(Math.abs(saldo))}
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                    <p style="color: var(--text-secondary); font-size: 14px;">Sin saldo en ninguna moneda</p>
                                </div>
                            `}
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            function initSaldosModule() {
                renderSaldosList();
            }

            /**
             * =================================================================
             * M√ìDULO DE CUENTAS CORRIENTES
             * =================================================================
             */
            function renderCuentasCorrientesModule() {
                return `
                    <div class="operations-container" style="max-width: 100%;">
                        <div class="form-card">
                            <div class="form-header">
                                <button type="button" class="btn-back" onclick="window.goBack()" title="Volver">‚Üê Volver</button>
                                <h2 class="form-title">üè¶ Cuentas Corrientes</h2>
                                <div style="width: 100px;"></div>
                            </div>
                            <div id="cuentasCorrientesListContainer"></div>
                        </div>
                    </div>
                `;
            }

            // Cache para balances de cuentas corrientes
            let balancesCache = null;
            let balancesCacheTimestamp = null;
            const BALANCES_CACHE_DURATION = 2000; // 2 segundos de cache

            function invalidateBalancesCache() {
                balancesCache = null;
                balancesCacheTimestamp = null;
            }

            function calcularBalancesCuentasCorrientes() {
                // Verificar cache
                const now = Date.now();
                if (balancesCache && balancesCacheTimestamp && (now - balancesCacheTimestamp) < BALANCES_CACHE_DURATION) {
                    return balancesCache;
                }
                
                const clientes = getClientes().filter(c => c.tipo === 'cuenta_corriente');
                // Optimizar filtrado: validar estructura y filtrar anulados primero
                const movimientos = getMovimientosCached().filter(m => {
                    if (!m || typeof m !== 'object') return false;
                    if (m.anulado) return false;
                    return m.operacion === 'CUENTAS_CORRIENTES';
                });
                const balances = {};

                // Inicializar balances para todos los clientes con cuenta corriente
                clientes.forEach(cliente => {
                    balances[cliente.id] = {};
                });

                // Procesar cada movimiento de cuentas corrientes
                movimientos.forEach(mov => {
                    const clienteId = mov.cliente;
                    if (!clienteId || !balances[clienteId]) return;

                    const subOperacion = mov.subOperacion;
                    let moneda = mov.moneda || mov.monedaTC || 'ARS';
                    moneda = normalizeMoneda(moneda);
                    const monto = safeParseFloat(mov.monto || 0);
                    const total = safeParseFloat(mov.total || monto);

                    if (!balances[clienteId][moneda]) {
                        balances[clienteId][moneda] = 0;
                    }

                    // INGRESO: suma al balance (el cliente nos debe menos o nos pag√≥)
                    if (subOperacion === 'INGRESO') {
                        balances[clienteId][moneda] += monto;
                    }
                    // EGRESO: resta del balance (el cliente nos debe m√°s)
                    else if (subOperacion === 'EGRESO') {
                        balances[clienteId][moneda] -= monto;
                    }
                    // COMPRA: el cliente compra, yo pago con mi wallet, genera deuda del cliente hacia m√≠
                    // El cliente me debe el total que pagu√© (balance negativo = me debe)
                    else if (subOperacion === 'COMPRA') {
                        // El balance se calcula en la moneda de pago (monedaTC)
                        const monedaPago = normalizeMoneda(mov.monedaTC || mov.moneda || 'ARS');
                        if (!balances[clienteId][monedaPago]) {
                            balances[clienteId][monedaPago] = 0;
                        }
                        // Restar del balance: el cliente me debe m√°s (balance m√°s negativo)
                        balances[clienteId][monedaPago] -= total;
                    }
                    // VENTA: el cliente vende, yo recibo dinero en mi wallet, el cliente me debe menos
                    // El cliente me paga (o me debe menos), entonces el balance mejora (suma)
                    else if (subOperacion === 'VENTA') {
                        // El balance se calcula en la moneda de cobro (monedaTC)
                        const monedaCobro = normalizeMoneda(mov.monedaTC || mov.moneda || 'ARS');
                        if (!balances[clienteId][monedaCobro]) {
                            balances[clienteId][monedaCobro] = 0;
                        }
                        // Sumar al balance: el cliente me paga (balance menos negativo o m√°s positivo)
                        balances[clienteId][monedaCobro] += total;
                    }
                    // ARBITRAJE: depende de la l√≥gica espec√≠fica, por ahora no afecta directamente
                });

                // Guardar en cache
                balancesCache = balances;
                balancesCacheTimestamp = Date.now();

                return balances;
            }

            function renderCuentasCorrientesList(clienteIdFiltro = null) {
                const container = safeGetElementById('cuentasCorrientesListContainer');
                if (!container) return;

                const clientes = getClientes().filter(c => c.tipo === 'cuenta_corriente');
                const balances = calcularBalancesCuentasCorrientes();

                // Si hay un filtro de cliente, mostrar solo ese cliente y sus operaciones
                if (clienteIdFiltro) {
                    const cliente = clientes.find(c => c.id === clienteIdFiltro);
                    if (!cliente) {
                        cuentaCorrienteSeleccionada = null;
                        renderCuentasCorrientesList();
                        return;
                    }

                    const clienteBalances = balances[cliente.id] || {};
                    const monedasConBalance = Object.keys(clienteBalances).filter(m => Math.abs(clienteBalances[m]) > 0.01);
                    
                    // Obtener todas las operaciones de este cliente
                    const movimientos = getMovimientos()
                        .filter(m => {
                            if (!m || typeof m !== 'object') return false;
                            if (m.anulado) return false;
                            return m.operacion === 'CUENTAS_CORRIENTES' && m.cliente === clienteIdFiltro;
                        })
                        .sort((a, b) => new Date(b.fechaCreacion || b.fecha) - new Date(a.fechaCreacion || a.fecha));

                    let html = `
                        <div style="margin-bottom: 20px;">
                            <button type="button" class="btn-back" onclick="cuentaCorrienteSeleccionada = null; renderCuentasCorrientesList();" style="margin-bottom: 15px;">‚Üê Volver al listado</button>
                        </div>
                        <div class="form-card" style="padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">${escapeHTML(cliente.nombre)}</h3>
                                    ${cliente.documento ? `<p style="color: var(--text-secondary); font-size: 13px;">DNI: ${cliente.documento}</p>` : ''}
                                    ${cliente.telefono ? `<p style="color: var(--text-secondary); font-size: 13px;">Tel: ${cliente.telefono}</p>` : ''}
                                </div>
                                <span style="font-size: 11px; padding: 4px 8px; border-radius: 12px; background: rgba(48, 209, 88, 0.1); color: var(--success-color); font-weight: 600;">Cuenta Corriente</span>
                            </div>
                            ${monedasConBalance.length > 0 ? `
                                <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                                    ${monedasConBalance.map(moneda => {
                                        const balance = clienteBalances[moneda];
                                        const monedaLabel = monedas.find(m => m.value === moneda)?.label || moneda;
                                        const esDeudor = balance < 0;
                                        return `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color);">
                                                <div>
                                                    <span style="font-weight: 600; font-size: 15px;">${monedaLabel}</span>
                                                    <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">
                                                        ${esDeudor ? '(Nos debe)' : '(A nuestro favor)'}
                                                    </span>
                                                </div>
                                                <span style="font-size: 16px; font-weight: 600; color: ${esDeudor ? 'var(--error-color)' : 'var(--success-color)'};">
                                                    ${esDeudor ? '-' : ''}${formatNumberWithThousands(Math.abs(balance))}
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<p style="color: var(--text-secondary); padding: 15px; text-align: center; background: var(--bg-primary); border-radius: 8px;">Balance en cero</p>'}
                            <div style="margin-top: 20px;">
                                <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Operaciones</h4>
                                ${movimientos.length > 0 ? `
                                    <div style="display: grid; gap: 10px;">
                                        ${movimientos.map(mov => {
                                            const fecha = new Date(mov.fechaCreacion || mov.fecha);
                                            const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                            const horaFormateada = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                                            const monedaLabel = monedas.find(m => m.value === normalizeMoneda(mov.moneda || mov.monedaTC || 'ARS'))?.label || normalizeMoneda(mov.moneda || mov.monedaTC || 'ARS');
                                            return `
                                                <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color);">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                        <div>
                                                            <span style="font-weight: 600; font-size: 14px;">${mov.subOperacion}</span>
                                                            <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">${fechaFormateada} ${horaFormateada}</span>
                                                        </div>
                                                        <span style="font-size: 14px; font-weight: 600;">${formatNumberWithThousands(safeParseFloat(mov.total || mov.monto || 0))} ${monedaLabel}</span>
                                                    </div>
                                                    ${mov.detalle ? `<p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${mov.detalle}</p>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p style="color: var(--text-secondary); padding: 15px; text-align: center; background: var(--bg-primary); border-radius: 8px;">No hay operaciones registradas</p>'}
                            </div>
                        </div>
                    `;
                    container.innerHTML = html;
                    return;
                }

                // Vista de listado de todas las cuentas corrientes
                if (clientes.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center;">No hay clientes con cuenta corriente.</p>';
                    return;
                }

                let html = '';
                clientes.forEach(cliente => {
                    const clienteBalances = balances[cliente.id] || {};
                    const monedasConBalance = Object.keys(clienteBalances).filter(m => Math.abs(clienteBalances[m]) > 0.01);

                    if (monedasConBalance.length === 0) {
                        html += `
                            <div class="form-card" style="padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); cursor: pointer;" onclick="cuentaCorrienteSeleccionada = '${escapeHTML(cliente.id)}'; renderCuentasCorrientesList('${escapeHTML(cliente.id)}');">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">${escapeHTML(cliente.nombre)}</h3>
                                        ${cliente.documento ? `<p style="color: var(--text-secondary); font-size: 13px;">DNI: ${cliente.documento}</p>` : ''}
                                    </div>
                                    <span style="font-size: 11px; padding: 4px 8px; border-radius: 12px; background: rgba(48, 209, 88, 0.1); color: var(--success-color); font-weight: 600;">Cuenta Corriente</span>
                                </div>
                                <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                    <p style="color: var(--text-secondary);">Balance en cero</p>
                                    <p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">Click para ver operaciones</p>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="form-card" style="padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); cursor: pointer;" onclick="cuentaCorrienteSeleccionada = '${escapeHTML(cliente.id)}'; renderCuentasCorrientesList('${escapeHTML(cliente.id)}');">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">${escapeHTML(cliente.nombre)}</h3>
                                        ${cliente.documento ? `<p style="color: var(--text-secondary); font-size: 13px;">DNI: ${cliente.documento}</p>` : ''}
                                    </div>
                                    <span style="font-size: 11px; padding: 4px 8px; border-radius: 12px; background: rgba(48, 209, 88, 0.1); color: var(--success-color); font-weight: 600;">Cuenta Corriente</span>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    ${monedasConBalance.map(moneda => {
                                        const balance = clienteBalances[moneda];
                                        const monedaLabel = monedas.find(m => m.value === moneda)?.label || moneda;
                                        const esDeudor = balance < 0;
                                        return `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color);">
                                                <div>
                                                    <span style="font-weight: 600; font-size: 15px;">${monedaLabel}</span>
                                                    <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">
                                                        ${esDeudor ? '(Nos debe)' : '(A nuestro favor)'}
                                                    </span>
                                                </div>
                                                <span style="font-size: 16px; font-weight: 600; color: ${esDeudor ? 'var(--error-color)' : 'var(--success-color)'};">
                                                    ${esDeudor ? '-' : ''}${formatNumberWithThousands(Math.abs(balance))}
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <p style="color: var(--text-secondary); font-size: 12px; margin-top: 12px; text-align: center;">Click para ver operaciones</p>
                            </div>
                        `;
                    }
                });

                container.innerHTML = html;
            }

            function initCuentasCorrientesModule() {
                // Si hay una cuenta corriente seleccionada, mostrarla; sino, mostrar el listado
                if (cuentaCorrienteSeleccionada) {
                    renderCuentasCorrientesList(cuentaCorrienteSeleccionada);
                } else {
                    renderCuentasCorrientesList();
                }
            }
            
            // Hacer la funci√≥n accesible globalmente para los onclick
            window.renderCuentasCorrientesList = renderCuentasCorrientesList;

            try {
                setupMenu();
                updateDateDisplay();
                setupTheme();
                const activeModule = safeLocalStorageOperation('get', 'activeModule') || '';
                // Cargar m√≥dulo inicial sin agregar al historial
                // Si no hay m√≥dulo guardado, mostrar pantalla principal
                loadModule(activeModule || 'inicio', false);
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
                // Intentar cargar al menos el m√≥dulo de operaciones
                try {
                    if (typeof loadModule === 'function') {
                        loadModule('operaciones');
                    }
                } catch (e) {
                    console.error('Error cr√≠tico al cargar m√≥dulo:', e);
                }
            }
        });
    </script>
</body>
</html>

